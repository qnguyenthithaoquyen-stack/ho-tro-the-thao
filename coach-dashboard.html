<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA2dXWCyjL2xgCSyeW9QQ7RvjI_O7kFHJw",
        authDomain: "sporthealthdata.firebaseapp.com",
        projectId: "sporthealthdata",
        storageBucket: "sporthealthdata.appspot.com",
        messagingSenderId: "789054240877",
        appId: "1:789054240877:web:04a400c9ea586523a86764",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
        const logoutLink = document.getElementById('logout-link');
        const athleteListUl = document.getElementById('athleteList');
        let sensorIntervalId = null; 

        onAuthStateChanged(auth, async (user) => {
            document.body.classList.add('loaded');
            if (user) {
                logoutLink.style.display = 'inline-flex';
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === 'coach') {
                    initializeDashboard(user.uid);
                } else {
                    alert("Bạn không có quyền truy cập trang này.");
                    window.location.href = './dangnhap.html';
                }
            } else {
                window.location.href = './dangnhap.html';
            }
        });

        function initializeDashboard(coachId) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).catch(error => console.error("Lỗi khi đăng xuất:", error));
            });
            listenForManagedAthletes(coachId);
        }

        function listenForManagedAthletes(coachId) {
            const managedAthletesColRef = collection(db, "users", coachId, "managed_athletes");
            onSnapshot(managedAthletesColRef, (snapshot) => {
                athleteListUl.innerHTML = '';
                if (snapshot.empty) {
                    athleteListUl.innerHTML = '<p style="padding: 12px; color: var(--text-light-color);">Chưa có VĐV nào.</p>';
                    return;
                }
                snapshot.forEach((athleteDoc) => {
                    const athleteData = athleteDoc.data();
                    const athleteId = athleteDoc.id;
                    const li = document.createElement('li');
                    li.className = 'athlete-item';
                    li.dataset.athleteId = athleteId;
                    const name = athleteData.fullName || "Chưa có tên";
                    const avatarChar = name.charAt(0).toUpperCase();
                    li.innerHTML = `<div class="athlete-avatar">${avatarChar}</div><span>${name}</span>`;
                    li.addEventListener('click', () => {
                        document.querySelectorAll('.athlete-item').forEach(item => item.classList.remove('selected'));
                        li.classList.add('selected');
                        displayAthleteDetails(athleteId);
                    });
                    athleteListUl.appendChild(li);
                });
            });
        }

        async function displayAthleteDetails(athleteId) {
            if (sensorIntervalId) {
                clearInterval(sensorIntervalId);
            }
            const detailsPlaceholder = document.getElementById('athlete-details-placeholder');
            const detailsContent = document.getElementById('athlete-details-content');

            // Reset các giá trị về '--' trước khi fetch dữ liệu mới
            document.getElementById('heartRate').textContent = '--';
            document.getElementById('spo2').textContent = '--';
            document.getElementById('bloodPressure').textContent = '--';
            document.getElementById('acceleration').textContent = '--';

            try {
                const athleteDocRef = doc(db, "users", athleteId);
                const athleteDocSnap = await getDoc(athleteDocRef);

                if (athleteDocSnap.exists()) {
                    const data = athleteDocSnap.data();
                    document.getElementById('athleteName').textContent = data.fullName || 'Chưa có tên';
                    document.getElementById('athleteEmail').textContent = data.email || 'Chưa có email';
                    document.getElementById('athleteDob').textContent = `Ngày sinh: ${data.dateOfBirth || 'N/A'}`;
                    document.getElementById('athleteCity').textContent = `Thành phố: ${data.city || 'N/A'}`;
                    
                    document.getElementById('send-exercise-btn').href = `send-exercise.html?athleteId=${athleteId}`;
                    document.getElementById('chat-with-athlete-btn').href = `chat-coach.html?with=${athleteId}`;
                    document.getElementById('view-warnings-btn').href = `canhbao-coach.html?athleteId=${athleteId}`;
                    document.getElementById('history-btn').href = `lichsu-thanhtich.html?athleteId=${athleteId}`;

                    // simulateSensorDataForCoach(athleteId); // <-- ĐÃ VÔ HIỆU HÓA DÒNG NÀY
                    detailsPlaceholder.style.display = 'none';
                    detailsContent.style.display = 'block';
                } else {
                    console.error("Không tìm thấy thông tin của VĐV với ID:", athleteId);
                }
            } catch(error) {
                console.error("Lỗi khi lấy thông tin chi tiết VĐV:", error);
            }
        }

        function simulateSensorDataForCoach(athleteId) {
            const heartRateEl = document.getElementById('heartRate');
            const spo2El = document.getElementById('spo2');
            const bloodPressureEl = document.getElementById('bloodPressure');
            const accelerationEl = document.getElementById('acceleration');

            const getRandom = (min, max, decimals = 0) => {
                return (Math.random() * (max - min) + min).toFixed(decimals);
            };
            
            sensorIntervalId = setInterval(() => {
                if (heartRateEl && spo2El && bloodPressureEl && accelerationEl) {
                    
                    heartRateEl.textContent = '104'; 
                    
                    spo2El.textContent = getRandom(96, 100);
                    bloodPressureEl.textContent = `${getRandom(120, 130, 0)}/${getRandom(80, 85, 0)}`;
                    accelerationEl.textContent = getRandom(1.5, 4.5, 2);
                }
            }, 1500); 
        }
    });
</script>
