<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cảnh báo Chấn thương - Hỗ Trợ Huấn Luyện Thể Thao</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
  :root{
    --primary:#008080; --bg:#f0f4f8; --card:#fff; --text:#333; --muted:#6c757d; --line:#e9ecef; --shadow:0 10px 25px -5px rgba(0,0,0,.07);
    --risk-high:#d4380d; --risk-med:#096dd9; --risk-low:#389e0d;
    --risk-high-bg:#fff2e8; --risk-med-bg:#e6f7ff; --risk-low-bg:#f6ffed;
  }
  *{box-sizing:border-box}
  body{font-family:Roboto,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  .container{max-width:1200px;margin:0 auto;background:#fff;min-height:100vh}
  .header{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:var(--primary);color:#fff}
  .header-left{display:flex;align-items:center;gap:12px}
  .logo{background:#fff;color:var(--primary);font-weight:700;padding:8px 10px;border-radius:8px}
  .project-info h1{font-size:20px;margin:0;font-weight:700}
  .project-info p{font-size:12px;margin:0;opacity:.9}
  .user-actions a{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:999px;text-decoration:none;border:1.5px solid #fff;background:#fff;color:var(--primary);font-weight:500}
  .navbar{display:flex;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:0 24px}
  .navbar a{padding:14px 18px;text-decoration:none;color:#333;font-weight:500;position:relative}
  .navbar a.active{color:var(--primary)}
  .navbar a.active::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:70%;height:3px;background:var(--primary)}
  .main{padding:24px}
  .page-header{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap;margin-bottom:18px}
  .title{margin:0 0 4px 0;font-size:26px;color:var(--primary)}
  .subtitle{margin:0;color:var(--muted)}
  .btn-back{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .filters{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 4px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fafafa;font-size:13px;cursor:pointer}
  .chip.active{border-color:var(--primary);color:var(--primary);background:#f0fffd}
  .warnings{margin-top:14px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:16px;display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:720px){ .card{grid-template-columns:1.2fr 1fr} }
  .risk-badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;font-size:13px;font-weight:600}
  .risk-high{color:var(--risk-high);background:var(--risk-high-bg);border:1px solid #ffd8bf}
  .risk-med{color:var(--risk-med);background:var(--risk-med-bg);border:1px solid #bae7ff}
  .risk-low{color:var(--risk-low);background:var(--risk-low-bg);border:1px solid #b7eb8f}
  .grid{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  .h3{margin:0;font-size:18px}
  .desc{margin:6px 0 0 0;color:var(--muted);font-size:14px}
  .kpis{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:480px){ .kpis{grid-template-columns:1fr 1fr} }
  .kpi{border:1px dashed var(--line);border-radius:12px;padding:12px}
  .kpi .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .progress{height:10px;background:#f1f5f9;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%}
  .bar.high{background:#ff7a45}
  .bar.med{background:#69b1ff}
  .bar.low{background:#95de64}
  .advice{background:#fcfffc;border:1px solid #e8f5e9;border-radius:12px;padding:12px}
  .date{font-size:12px;color:var(--muted)}
  .empty{padding:40px;text-align:center;color:var(--muted)}
  .loader{padding:40px;text-align:center;color:var(--muted)}
  .pill{font-size:12px;border:1px solid var(--line);padding:3px 8px;border-radius:999px;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="header-left">
      <div class="logo">LOGO</div>
      <div class="project-info">
        <h1>HỖ TRỢ HUẤN LUYỆN THỂ THAO</h1>
        <p>DỰ ÁN KHOA HỌC KỸ THUẬT</p>
      </div>
    </div>
    <div class="user-actions">
      <a href="#" id="logout-link" style="display:none">Đăng xuất</a>
    </div>
  </header>

  <nav class="navbar">
    <a href="index.html">Trang chủ</a>
    <a href="gioithieu.html">Giới thiệu</a>
    <a href="bangdieukhien.html" class="active">Bảng điều khiển</a>
  </nav>

  <main class="main">
    <div class="page-header">
      <div>
        <h2 class="title">Cảnh báo Chấn thương</h2>
        <p id="athlete-name" class="subtitle">Dữ liệu của vận động viên</p>
      </div>
      <a class="btn-back" href="bangdieukhien.html">
        ← Quay về Bảng điều khiển
      </a>
    </div>

    <!-- Bộ lọc nhanh (tuỳ chọn) -->
    <div class="filters" id="filters">
      <button class="chip active" data-filter="all">Tất cả</button>
      <button class="chip" data-filter="high">Nguy cơ cao</button>
      <button class="chip" data-filter="medium">Nguy cơ trung bình</button>
      <button class="chip" data-filter="low">Nguy cơ thấp</button>
    </div>

    <div id="warnings" class="warnings"></div>
    <div id="loader" class="loader">Đang tải dữ liệu…</div>
    <div id="empty" class="empty" style="display:none">Không có cảnh báo nào được ghi nhận.</div>
  </main>
</div>

<script type="module">
  // Firebase v9 (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2dXWCyjL2xgCSyeW9QQ7RvjI_O7kFHJw",
    authDomain: "sporthealthdata.firebaseapp.com",
    projectId: "sporthealthdata",
    storageBucket: "sporthealthdata.appspot.com",
    messagingSenderId: "789054240877",
    appId: "1:789054240877:web:04a400c9ea586523a86764",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const logoutLink = document.getElementById('logout-link');
  const athleteNameEl = document.getElementById('athlete-name');
  const warningsEl = document.getElementById('warnings');
  const loaderEl = document.getElementById('loader');
  const emptyEl = document.getElementById('empty');
  const filtersEl = document.getElementById('filters');

  let currentFilter = 'all';
  let cachedDocs = []; // giữ snapshot để lọc client-side

  // —— Utils —— //
  function formatDateFlexible(dt){
    // Hỗ trợ Firestore Timestamp, millis number, ISO string
    try{
      if (!dt) return 'N/A';
      if (typeof dt === 'object' && ('seconds' in dt)) {
        return new Date(dt.seconds * 1000).toLocaleString('vi-VN');
      }
      if (typeof dt === 'number') {
        return new Date(dt).toLocaleString('vi-VN');
      }
      return new Date(dt).toLocaleString('vi-VN');
    }catch(e){ return 'N/A'; }
  }
  function riskClass(risk){
    const r = (risk||'medium').toLowerCase();
    if (r==='high') return {badge:'risk-high', bar:'high', label:'Nguy cơ cao'};
    if (r==='low') return {badge:'risk-low', bar:'low', label:'Nguy cơ thấp'};
    return {badge:'risk-med', bar:'med', label:'Nguy cơ trung bình'};
  }
  function clampPercent(x){
    const n = Number(x);
    if (Number.isFinite(n)) return Math.max(0, Math.min(100, n));
    return 0;
  }

  function render(list){
    warningsEl.innerHTML = '';
    if (!list.length){
      emptyEl.style.display = 'block';
      return;
    }
    emptyEl.style.display = 'none';

    list.forEach(item => {
      const { title, description, risk, accuracy, advice, date } = item;
      const r = riskClass(risk);
      const pct = clampPercent(accuracy);

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="grid">
          <div class="row" style="justify-content:space-between">
            <span class="risk-badge ${r.badge}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="opacity:.9">
                <path d="M12 2 1 21h22L12 2zM12 16a1 1 0 1 1 0 2 1 1 0 0 1 0-2Zm-1-7h2v6h-2V9Z"/>
              </svg>
              ${r.label}
            </span>
            <span class="pill">${formatDateFlexible(date)}</span>
          </div>
          <h3 class="h3">${title || 'Cảnh báo chấn thương'}</h3>
          <p class="desc">${description || 'Không có mô tả chi tiết.'}</p>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Tỉ lệ đúng (ước lượng mô hình)</div>
            <div class="progress"><div class="bar ${r.bar}" style="width:${pct}%"></div></div>
            <div class="muted" style="margin-top:6px">${pct}%</div>
          </div>
          <div class="kpi advice">
            <div class="label">Lời khuyên</div>
            <div>${advice || 'Chưa có lời khuyên cụ thể. Hãy theo dõi tải luyện tập, khởi động kỹ và kiểm tra kỹ thuật.'}</div>
          </div>
        </div>
      `;
      warningsEl.appendChild(card);
    });
  }

  function applyFilter(){
    if (currentFilter==='all') return render(cachedDocs);
    render(cachedDocs.filter(d => (d.risk||'').toLowerCase()===currentFilter));
  }

  // —— Auth & Data —— //
  onAuthStateChanged(auth, async (user) => {
    if (!user){ window.location.href = './dangnhap.html'; return; }
    logoutLink.style.display = 'inline-flex';

    const params = new URLSearchParams(window.location.search);
    const athleteId = params.get('athleteId');
    if (!athleteId){
      loaderEl.textContent = 'Không tìm thấy ID vận động viên.';
      return;
    }

    try{
      // Tên VĐV
      const userDoc = await getDoc(doc(db, 'users', athleteId));
      if (userDoc.exists()){
        const d = userDoc.data();
        athleteNameEl.textContent = `Dữ liệu của ${d.fullName || 'Vận động viên'}`;
      }

      // Cảnh báo (realtime)
      const qRef = query(
        collection(db, 'users', athleteId, 'injury_warnings'),
        orderBy('date', 'desc')
      );

      onSnapshot(qRef, (snap) => {
        loaderEl.style.display = 'none';
        if (snap.empty){
          cachedDocs = [];
          render([]);
          return;
        }
        cachedDocs = snap.docs.map(doc => {
          const x = doc.data();
          return {
            title: x.title,
            description: x.description,
            risk: (x.risk || x.severity || 'medium'), // hỗ trợ trường cũ 'severity'
            accuracy: (x.accuracy ?? x.correctRate ?? 0), // hỗ trợ tên khác
            advice: x.advice,
            date: x.date
          };
        });
        applyFilter();
      }, (err) => {
        console.error('Lỗi onSnapshot:', err);
        loaderEl.textContent = 'Đã xảy ra lỗi khi tải dữ liệu.';
      });
    }catch(err){
      console.error('Lỗi khi tải dữ liệu:', err);
      loaderEl.textContent = 'Đã xảy ra lỗi khi tải dữ liệu.';
    }
  });

  if (logoutLink){
    logoutLink.addEventListener('click', (e)=>{
      e.preventDefault();
      signOut(auth).catch(err => console.error('Lỗi khi đăng xuất:', err));
    });
  }

  // —— Filter UI —— //
  filtersEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if (!btn) return;
    [...filtersEl.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    applyFilter();
  });
</script>
</body>
</html>
