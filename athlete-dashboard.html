<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng điều khiển VĐV - Hỗ Trợ Huấn Luyện Thể Thao</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #008080;
            --secondary-color: #00a9a9;
            --background-color: #f0f4f8;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --text-light-color: #6c757d;
            --border-color: #e9ecef;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07);
            --run-color: #1890ff;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            background-color: var(--background-color); 
            color: var(--text-color);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        body.loaded { opacity: 1; }

        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: var(--primary-color); color: #fff; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { background-color: #fff; color: var(--primary-color); font-weight: 700; padding: 10px; border-radius: 8px; }
        .project-info h1 { font-size: 24px; margin: 0; font-weight: 700; }
        .project-info p { font-size: 12px; margin: 0; opacity: 0.9; }
        .user-actions { display: flex; align-items: center; gap: 12px; }
        .user-actions a { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 9px 22px; font-size: 14px; font-weight: 500; border-radius: 50px; text-decoration: none; border: 1.5px solid #fff; transition: background-color 0.3s, color 0.3s; }
        .user-actions a svg { width: 16px; height: 16px; }
        #logout-link { background-color: #fff; color: var(--primary-color); }
        #logout-link:hover { background-color: rgba(255, 255, 255, 0.9); }
        .navbar { display: flex; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.05); padding: 0 30px; }
        .navbar a { padding: 15px 25px; text-decoration: none; color: #333; font-weight: 500; position: relative; transition: color 0.3s ease; }
        .navbar a.active { color: var(--primary-color); }
        .navbar a.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70%; height: 3px; background-color: var(--primary-color); }

        .main-content { padding: 30px; }
        .loader-container { display: flex; justify-content: center; align-items: center; min-height: 50vh; color: var(--text-light-color); }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .daily-goals { background-color: var(--card-bg-color); border-radius: 16px; padding: 30px; box-shadow: var(--shadow); }
        .daily-goals h2 { margin-top: 0; font-size: 24px; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-radius: 12px; margin-bottom: 15px; transition: box-shadow 0.3s, transform 0.3s; border: 1px solid transparent; }
        .task-item.run { background-color: #e6f7ff; border-color: #91d5ff; }
        .task-item:hover { transform: translateY(-4px); box-shadow: 0 8px 20px -5px rgba(0,0,0,0.12); }
        .task-info { display: flex; align-items: center; gap: 20px; }
        .task-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .task-icon svg { width: 28px; height: 28px; stroke: var(--run-color);}
        .task-details h3 { margin: 0; font-size: 16px; font-weight: 500; }
        .task-details p { margin: 4px 0 0; font-size: 14px; color: var(--text-light-color); }
        .task-action button { color: #fff; background-color: var(--run-color); border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: 500; transition: filter 0.3s; }
        .task-action button:hover { filter: brightness(1.1); }
        
        .main-functions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; }
        .function-button { padding: 20px; border-radius: 16px; text-align: center; color: #fff; font-weight: 700; font-size: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow); position: relative; overflow: hidden; background-size: cover; background-position: center; text-decoration: none; }
        .function-button:hover { transform: translateY(-5px); box-shadow: 0 12px 30px -5px rgba(0,0,0,0.15); }
        .function-button svg { width: 32px; height: 32px; stroke-width: 1.5; z-index: 2; }
        .function-button span { z-index: 2; }
        .function-button::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transition: background-color 0.3s; }
        .function-button:hover::before { background-color: rgba(0,0,0,0.2); }
        .btn-blue { background-image: url('https://images.pexels.com/photos/3757374/pexels-photo-3757374.jpeg?auto=compress&cs=tinysrgb&w=600'); }
        .btn-blue::before { background-color: rgba(13, 110, 253, 0.7); }
        .btn-green { background-image: url('https://images.pexels.com/photos/590022/pexels-photo-590022.jpeg?auto=compress&cs=tinysrgb&w=600'); }
        .btn-green::before { background-color: rgba(25, 135, 84, 0.7); }
        .btn-yellow { background-image: url('https://images.pexels.com/photos/4098228/pexels-photo-4098228.jpeg?auto=compress&cs=tinysrgb&w=600'); color: #fff; }
        .btn-yellow::before { background-color: rgba(255, 193, 7, 0.7); }
        .btn-red { background-image: url('https://images.pexels.com/photos/7991379/pexels-photo-7991379.jpeg?auto=compress&cs=tinysrgb&w=600'); }
        .btn-red::before { background-color: rgba(220, 53, 69, 0.7); }
        
        .quick-stats { background-color: var(--card-bg-color); border-radius: 16px; padding: 30px; box-shadow: var(--shadow); }
        .quick-stats h2 { margin-top: 0; font-size: 24px; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .stat-card { display: flex; align-items: center; gap: 15px; padding: 20px; margin-bottom: 15px; border-radius: 12px; color: white; transition: transform 0.2s, box-shadow 0.3s; }
        .stat-card-info h3 { margin: 0 0 5px 0; font-size: 14px; font-weight: 500; opacity: 0.9; }
        .stat-card-info .value { font-size: 28px; font-weight: 700; }
        .stat-distance { background: linear-gradient(45deg, #0d6efd, #0a58ca); }
        .stat-time { background: linear-gradient(45deg, #198754, #146c43); }
        .stat-calories { background: linear-gradient(45deg, #ffc107, #d39e00); }
        .stat-today-distance { background: linear-gradient(45deg, #fd7e14, #c8630c); }
        .access-denied { text-align: center; padding: 50px; }
        .access-denied h2 { color: var(--primary-color); }
        @media (max-width: 992px) { .dashboard-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo">LOGO</div>
                <div class="project-info"><h1>HỖ TRỢ HUẤN LUYỆN THỂ THAO</h1><p>DỰ ÁN KHOA HỌC KỸ THUẬT</p></div>
            </div>
            <div class="user-actions">
                <a href="#" id="logout-link" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    <span>Đăng xuất</span>
                </a>
            </div>
        </header>
        <nav class="navbar">
            <a href="index.html">Trang chủ</a>
            <a href="gioithieu.html">Giới thiệu</a>
            <a href="bangdieukhien.html" class="active">Bảng điều khiển</a>
        </nav>
        <main class="main-content" id="content-area">
            <div class="loader-container">
                <p>Đang tải dữ liệu vận động viên...</p>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2dXWCyjL2xgCSyeW9QQ7RvjI_O7kFHJw",
            authDomain: "sporthealthdata.firebaseapp.com",
            projectId: "sporthealthdata",
            storageBucket: "sporthealthdata.appspot.com",
            messagingSenderId: "789054240877",
            appId: "1:789054240877:web:04a400c9ea586523a86764",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const logoutLink = document.getElementById('logout-link');
        const contentArea = document.getElementById('content-area');
        
        function renderDashboard(userData) {
            const userName = userData.fullName || "Vận động viên";
            contentArea.innerHTML = `
                <div class="dashboard-grid">
                    <div class="left-column">
                        <div class="daily-goals">
                            <div id="goals-list">
                                <h2>Mục tiêu của <span>${userName}</span></h2>
                            </div>
                        </div>
                        <div class="main-functions">
                            <a href="bất lực.html" class="function-button btn-blue">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 1.5a10.5 10.5 0 1 0 0 21 10.5 10.5 0 0 0 0-21z"/><path d="M12 12a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9z"/><path d="M12 12a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
                                <span>Phân tích tư thế</span>
                            </a>
                            <a href="#" class="function-button btn-green">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="m18.7 8-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                                <span>Lịch sử thành tích</span>
                            </a>
                            <a href="#" id="chat-with-coach-btn" class="function-button btn-yellow">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                <span>Chat với HLV</span>
                            </a>
                             <a href="#" class="function-button btn-red">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                <span>Cảnh báo chấn thương</span>
                            </a>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="quick-stats">
                            <h2>Thống kê nhanh</h2>
                            <div class="stat-card stat-distance"><div class="stat-card-info"><h3>Tổng quãng đường (tuần)</h3><p class="value" id="stat-weekly-distance">-- km</p></div></div>
                            <div class="stat-card stat-today-distance"><div class="stat-card-info"><h3>Tổng quãng đường (hôm nay)</h3><p class="value" id="stat-today-distance">-- km</p></div></div>
                            <div class="stat-card stat-time"><div class="stat-card-info"><h3>Thời gian tập (tuần)</h3><p class="value" id="stat-weekly-duration">--h --m</p></div></div>
                            <div class="stat-card stat-calories"><div class="stat-card-info"><h3>Calo tiêu thụ (hôm nay)</h3><p class="value" id="stat-today-calories">-- kcal</p></div></div>
                        </div>
                    </div>
                </div>`;
        }

        function renderAccessDenied() {
            contentArea.innerHTML = `<div class="access-denied"><h2>Truy cập bị từ chối</h2><p>Trang này chỉ dành cho tài khoản Vận động viên.</p></div>`;
        }
        
        function listenForExercises(athleteId) {
            const goalsListContainer = document.getElementById('goals-list');
            if (!goalsListContainer) return;
            const exercisesColRef = collection(db, "users", athleteId, "exercises");
            const q = query(exercisesColRef, orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const existingTasks = goalsListContainer.querySelectorAll('.task-item, .no-exercise-msg');
                existingTasks.forEach(task => task.remove());
                if (snapshot.empty) {
                    const noExerciseItem = document.createElement('p');
                    noExerciseItem.textContent = 'Bạn chưa có bài tập nào được giao.';
                    noExerciseItem.className = 'no-exercise-msg';
                    noExerciseItem.style.color = 'var(--text-light-color)';
                    goalsListContainer.appendChild(noExerciseItem);
                } else {
                    snapshot.forEach(doc => {
                        const exercise = doc.data();
                        const exerciseDiv = document.createElement('div');
                        exerciseDiv.className = 'task-item run';
                        exerciseDiv.innerHTML = `<div class="task-info"><div class="task-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div class="task-details"><h3>${exercise.title || 'Bài tập mới'}</h3><p>Hạn chót: ${exercise.dueDate || 'Chưa có'}</p></div></div><div class="task-action"><button>Thực hiện</button></div>`;
                        goalsListContainer.appendChild(exerciseDiv);
                    });
                }
            });
        }

        function listenForAthleteStats(athleteId) {
            const weeklyDistanceEl = document.getElementById('stat-weekly-distance');
            const todayDistanceEl = document.getElementById('stat-today-distance');
            const weeklyDurationEl = document.getElementById('stat-weekly-duration');
            const todayCaloriesEl = document.getElementById('stat-today-calories');
            const statsDocRef = doc(db, "athlete_stats", athleteId);
            onSnapshot(statsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const stats = docSnap.data();
                    weeklyDistanceEl.textContent = `${stats.weekly_distance_km ?? '--'} km`;
                    todayDistanceEl.textContent = `${stats.today_distance_km ?? '--'} km`;
                    todayCaloriesEl.textContent = `${stats.today_calories_kcal ?? '--'} kcal`;
                    if (stats.weekly_duration_minutes !== undefined) {
                        const hours = Math.floor(stats.weekly_duration_minutes / 60);
                        const minutes = stats.weekly_duration_minutes % 60;
                        weeklyDurationEl.textContent = `${hours}h ${minutes}m`;
                    } else {
                        weeklyDurationEl.textContent = '--h --m';
                    }
                } else {
                    weeklyDistanceEl.textContent = '-- km';
                    todayDistanceEl.textContent = '-- km';
                    weeklyDurationEl.textContent = '--h --m';
                    todayCaloriesEl.textContent = '-- kcal';
                }
            });
        }

        onAuthStateChanged(auth, async (user) => {
            document.body.classList.add('loaded');
            if (user) {
                logoutLink.style.display = 'inline-flex';
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().role === 'athlete') {
                    renderDashboard(userDoc.data());
                    listenForExercises(user.uid);
                    listenForAthleteStats(user.uid);
                    
                    const coachId = userDoc.data().managedBy;
                    const chatBtn = document.getElementById('chat-with-coach-btn');
                    if(chatBtn) {
                        if (coachId) {
                            chatBtn.href = `chat.html?with=${coachId}`;
                        } else {
                            chatBtn.style.opacity = '0.5';
                            chatBtn.style.cursor = 'not-allowed';
                            chatBtn.title = 'Bạn chưa được gán cho HLV nào.';
                            chatBtn.addEventListener('click', (e) => e.preventDefault());
                        }
                    }

                } else {
                    renderAccessDenied();
                }
            } else {
                window.location.href = './dangnhap.html';
            }
        });

        if (logoutLink) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).catch((error) => console.error('Lỗi khi đăng xuất:', error));
            });
        }
    </script>
</body>
</html>

