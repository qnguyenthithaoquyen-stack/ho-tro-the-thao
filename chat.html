<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat 1–1</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0}
    .wrap{max-width:980px;margin:24px auto;padding:0 12px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:20px;font-weight:600}
    .uid{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:12px;border:1px solid var(--border)}
    #chat-log{height:62vh;overflow:auto;padding:10px;border-radius:10px;background:#fafafa;border:1px solid var(--border)}
    .bubble{padding:.55rem .8rem;border-radius:14px;margin:.28rem 0;max-width:72%;line-height:1.35;word-wrap:break-word;white-space:pre-wrap}
    .me{background:#DCF8C6;margin-left:auto}
    .peer{background:#eee;margin-right:auto}
    .row{display:flex;gap:8px;margin-top:10px}
    .row input{flex:1;border-radius:10px;border:1px solid var(--border);padding:12px;font-size:15px}
    .row button{border:0;border-radius:10px;padding:12px 16px;cursor:pointer;background:#10b981;color:#fff;font-weight:600}
    .row button[disabled]{opacity:.6;cursor:not-allowed}
    .error{display:none;color:#b00020;margin:8px 0}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Chat 1–1</div>
      <div class="uid" id="meUid">Đang khởi tạo…</div>
    </div>

    <div id="err" class="error"></div>

    <div class="card">
      <div id="chat-log"></div>

      <div class="row">
        <input id="chatInput" placeholder="Nhập tin nhắn..." />
        <button id="sendBtn">Gửi</button>
      </div>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- Nếu bạn có file firebase-config.js, hãy load TRƯỚC đoạn script module phía dưới
       và gán window.firebaseConfig = { ... } trong file đó. -->

  <script type="module">
    /***** Firebase SDK (v10+) *****/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, addDoc, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // ---- CẤU HÌNH FIREBASE ----
    // 1) Cách A: đặt cấu hình vào đây
    // 2) Cách B: hoặc nạp từ file firebase-config.js -> window.firebaseConfig
    const firebaseConfig = window.firebaseConfig ?? {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    if (!firebaseConfig || !firebaseConfig.projectId) {
      console.warn("⚠️ Thiếu firebaseConfig. Hãy cung cấp cấu hình dự án Firebase của bạn.");
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /***** DOM refs *****/
    const els = {
      me: document.getElementById('meUid'),
      log: document.getElementById('chat-log'),
      input: document.getElementById('chatInput'),
      send: document.getElementById('sendBtn'),
      err: document.getElementById('err'),
      hint: document.getElementById('hint'),
    };

    function showError(msg){
      els.err.textContent = msg;
      els.err.style.display = 'block';
    }
    function setHint(msg){
      els.hint.textContent = msg || '';
    }
    function bubble(who, text){
      const d = document.createElement('div');
      d.className = `bubble ${who}`;
      d.textContent = text;
      els.log.appendChild(d);
      els.log.scrollTop = els.log.scrollHeight;
    }

    /***** Lấy tham số URL *****/
    const params = new URLSearchParams(location.search);
    const OTHER_ID = params.get('with') || params.get('otherId') || null; // ưu tiên ?with=
    const convIdFromUrl = params.get('convId') || null;

    // Tên người để hiển thị (tuỳ chọn): ?name=...
    const peerName = params.get('name');
    if (peerName) setHint('Đang chat với: ' + peerName);

    /***** Tạo convId ổn định từ 2 uid *****/
    function pairConvId(a, b){ return [a,b].sort().join('__'); }

    /***** Tạo/lấy hội thoại (khớp rules: participants.length == 2) *****/
    async function getOrCreateConversation(myUid, peerUid){
      // Nếu có convId rõ ràng → dùng luôn; nếu không, sinh từ cặp uid
      const convId = convIdFromUrl || pairConvId(myUid, peerUid);
      const ref = doc(db, 'conversations', convId);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          participants: [myUid, peerUid],  // QUAN TRỌNG: đúng kiểu mảng 2 UID
          lastMessage: null,
          updatedAt: serverTimestamp(),
        });
      }
      return convId;
    }

    /***** Lắng nghe tin nhắn *****/
    function listenMessages(convId, myUid){
      const q = query(collection(db, 'conversations', convId, 'messages'), orderBy('createdAt','asc'));
      return onSnapshot(q, (snap) => {
        els.log.innerHTML = '';
        snap.forEach(docSnap => {
          const m = docSnap.data();
          bubble(m.senderId === myUid ? 'me' : 'peer', m.text);
        });
      }, (err) => {
        console.error('Lỗi khi lắng nghe tin nhắn:', err);
        const isPerm = /missing|insufficient permissions/i.test(err.message);
        showError(isPerm
          ? 'Bạn không có quyền xem cuộc trò chuyện này. Hãy kiểm tra đăng nhập hoặc danh sách participants của phòng.'
          : ('Lỗi: ' + err.message));
      });
    }

    /***** Gửi tin nhắn (đúng 3 field theo rules) + cập nhật meta parent *****/
    async function sendMessage(convId, myUid, text){
      await addDoc(collection(db, 'conversations', convId, 'messages'), {
        text,
        senderId: myUid,
        createdAt: serverTimestamp(),
      });
      await updateDoc(doc(db, 'conversations', convId), {
        lastMessage: { text, senderId: myUid, createdAt: serverTimestamp() },
        updatedAt: serverTimestamp(),
      });
    }

    /***** Đăng nhập ẩn danh → Khởi tạo chat *****/
    onAuthStateChanged(auth, async (user) => {
      try {
        // Nếu chưa có user → đăng nhập ẩn danh cho nhanh
        if (!user) { 
          await signInAnonymously(auth);
          return; // sẽ quay lại đây lần 2 khi đã có user
        }

        const myUid = user.uid;
        els.me.textContent = 'UID của bạn: ' + myUid;

        // Thiếu tham số → báo rõ ràng
        if (!OTHER_ID && !convIdFromUrl) {
          setHint('Tip: mở như sau → chat.html?with=<UID_đối_tác>');
          showError('Thiếu tham số with=UID (hoặc convId=...) trên URL.');
          return;
        }

        // Tạo/lấy hội thoại
        const convId = await getOrCreateConversation(myUid, OTHER_ID ?? myUid);
        setHint((peerName ? `Đang chat với: ${peerName} • ` : '') + `Phòng: ${convId}`);

        // Lắng nghe tin nhắn
        listenMessages(convId, myUid);

        // Gửi tin nhắn
        let sending = false;
        const doSend = async () => {
          if (sending) return;
          const text = (els.input.value || '').trim();
          if (!text) return;
          sending = true; els.send.disabled = true;
          try {
            await sendMessage(convId, myUid, text);
            els.input.value = '';
          } catch (e) {
            console.error(e);
            showError('Không gửi được tin: ' + e.message);
          } finally {
            sending = false; els.send.disabled = false;
          }
        };
        els.send.addEventListener('click', doSend);
        els.input.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); }
        });

      } catch (e) {
        console.error(e);
        showError('Lỗi khởi tạo: ' + e.message);
      }
    });
  </script>
</body>
</html>
