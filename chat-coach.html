<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat - Hỗ Trợ Huấn Luyện (HLV)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    :root{
      --primary-color:#008080;
      --background-color:#f0f4f8;
      --card-bg-color:#ffffff;
      --text-color:#333;
      --text-light-color:#6c757d;
      --border-color:#e9ecef;
      --sender-bg:#e6f2f2;
      --receiver-bg:var(--primary-color);
    }
    body{font-family:'Roboto',sans-serif;margin:0;background:var(--background-color)}
    .container{max-width:1200px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;padding:15px 30px;background:var(--primary-color);color:#fff}
    .header-left{display:flex;align-items:center;gap:15px}
    .logo{background:#fff;color:var(--primary-color);font-weight:700;padding:10px;border-radius:8px}
    .project-info h1{font-size:24px;margin:0}
    .navbar{display:flex;background:var(--card-bg-color);box-shadow:0 2px 4px rgba(0,0,0,.05);padding:0 30px}
    .navbar a{padding:15px 25px;text-decoration:none;color:var(--text-light-color);font-weight:500}

    .chat-container{display:flex;flex-direction:column;height:calc(100vh - 140px);max-width:800px;margin:20px auto;background:var(--card-bg-color);box-shadow:0 4px 12px rgba(0,0,0,.1);border-radius:16px;overflow:hidden}
    .chat-header{padding:15px 20px;border-bottom:1px solid var(--border-color);background:#f8f9fa;display:flex;justify-content:space-between;align-items:center}
    .chat-header h2{margin:0;font-size:18px;color:var(--text-color)}
    .chat-header a{color:var(--primary-color);text-decoration:none;font-size:14px}

    .error{display:none;color:#b00020;padding:8px 20px}
    .chat-messages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column}
    .message{max-width:70%;padding:10px 15px;border-radius:18px;margin-bottom:10px;line-height:1.4}
    .message.sent{background:var(--sender-bg);color:var(--text-color);align-self:flex-end;border-bottom-right-radius:4px}
    .message.received{background:var(--receiver-bg);color:#fff;align-self:flex-start;border-bottom-left-radius:4px}
    .message .timestamp{font-size:11px;color:var(--text-light-color);margin-top:5px;display:block}
    .message.received .timestamp{color:rgba(255,255,255,0.7)}

    .chat-input{display:flex;padding:15px;border-top:1px solid var(--border-color);background:#f8f9fa}
    .chat-input input{flex:1;border:1px solid var(--border-color);border-radius:20px;padding:10px 15px;font-size:16px;outline:none}
    .chat-input button{background:var(--primary-color);border:none;color:#fff;border-radius:50%;width:40px;height:40px;margin-left:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-left">
        <div class="logo">LOGO</div>
        <div class="project-info"><h1>HỖ TRỢ HUẤN LUYỆN THỂ THAO</h1></div>
      </div>
    </header>
    <nav class="navbar">
      <a href="index.html">Trang chủ</a>
      <a href="gioithieu.html">Giới thiệu</a>
      <a href="bangdieukhien.html">Bảng điều khiển</a>
    </nav>

    <div class="chat-container">
      <div class="chat-header">
        <h2 id="chatWithTitle">Đang tải...</h2>
        <a href="coach-dashboard.html" id="backButton">&larr; Quay lại</a>
      </div>
      <div class="error" id="errorBox"></div>
      <div class="chat-messages" id="chatMessages"></div>
      <form class="chat-input" id="messageForm">
        <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." autocomplete="off">
        <button type="submit" aria-label="Gửi">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, serverTimestamp, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2dXWCyjL2xgCSyeW9QQ7RvjI_O7kFHJw",
      authDomain: "sporthealthdata.firebaseapp.com",
      projectId: "sporthealthdata",
      storageBucket: "sporthealthdata.appspot.com",
      messagingSenderId: "789054240877",
      appId: "1:789054240877:web:04a400c9ea586523a86764",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- DOM ---
    const chatWithTitle = document.getElementById('chatWithTitle');
    const chatMessages  = document.getElementById('chatMessages');
    const messageForm   = document.getElementById('messageForm');
    const messageInput  = document.getElementById('messageInput');
    const errorBox      = document.getElementById('errorBox');

    function showErr(msg){ errorBox.textContent = msg; errorBox.style.display='block'; }
    function hideErr(){ errorBox.style.display='none'; }

    function displayMessage(data){
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(data.senderId === currentUser.uid ? 'sent' : 'received');

      const text = document.createElement('span');
      text.textContent = data.text;

      const ts = document.createElement('span');
      ts.classList.add('timestamp');
      ts.textContent = data.createdAt?.seconds
        ? new Date(data.createdAt.seconds*1000).toLocaleTimeString()
        : '';

      div.appendChild(text);
      div.appendChild(ts);
      chatMessages.appendChild(div);
    }

    // --- Helpers (đồng bộ với phía VĐV) ---
    function pairConvId(a,b){ return [a,b].sort().join('__'); }

    // Tạo phòng KHÔNG đọc trước (phù hợp rules: allow create)
    async function ensureConversation(db, myUid, peerUid){
      const id  = pairConvId(myUid, peerUid);
      const ref = doc(db, "conversations", id);
      try{
        await setDoc(ref, {
          participants: [myUid, peerUid],
          lastMessage: null,
          updatedAt: serverTimestamp(),
        }, { merge:false });
      }catch(e){
        // Nếu đã tồn tại và setDoc coi là update (bị chặn) thì bỏ qua.
      }
      return id;
    }

    // --- State ---
    let currentUser, athleteId, convId;

    onAuthStateChanged(auth, async (user)=>{
      try{
        if(!user){ window.location.href='./dangnhap.html'; return; }
        currentUser = user;

        const params = new URLSearchParams(location.search);
        athleteId = params.get('with');
        if(!athleteId){
          showErr('Không tìm thấy ID của vận động viên (with=...).');
          return;
        }

        // Tạo/đảm bảo phòng tồn tại trong "conversations"
        convId = await ensureConversation(db, currentUser.uid, athleteId);

        // Tiêu đề
        try{
          const athleteDoc = await getDoc(doc(db,"users",athleteId));
          if(athleteDoc.exists()) chatWithTitle.textContent = `Chat với ${athleteDoc.data().fullName}`;
          else chatWithTitle.textContent = 'Chat';
        }catch{ chatWithTitle.textContent='Chat'; }

        // Bắt đầu nghe tin nhắn
        listenForMessages();
        hideErr();

        // Gửi tin
        messageForm.addEventListener('submit', handleMessageSubmit);
      }catch(e){
        showErr('Lỗi khởi tạo: ' + (e?.message || e));
      }
    });

    function listenForMessages(){
      const messagesColRef = collection(db, "conversations", convId, "messages");
      const q = query(messagesColRef, orderBy("createdAt"));
      onSnapshot(q, (snapshot)=>{
        chatMessages.innerHTML = '';
        snapshot.forEach(docSnap => displayMessage(docSnap.data()));
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, (error)=>{
        console.error("Lỗi khi lắng nghe tin nhắn:", error);
        showErr(/insufficient permissions/i.test(error.message)
          ? "Thiếu quyền đọc phòng chat. Hãy kiểm tra rules và participants của phòng."
          : ("Không thể tải tin nhắn. Lỗi: " + error.message));
      });
    }

    async function handleMessageSubmit(e){
      e.preventDefault();
      const text = messageInput.value.trim();
      if(!text || !convId) return;

      messageInput.value = '';

      try{
        // Gửi message: chỉ 3 field đúng theo rules
        await addDoc(collection(db, "conversations", convId, "messages"), {
          text, senderId: currentUser.uid, createdAt: serverTimestamp()
        });

        // Cập nhật meta parent: đúng whitelist trong rules
        await updateDoc(doc(db, "conversations", convId), {
          lastMessage: { text, senderId: currentUser.uid, createdAt: serverTimestamp() },
          updatedAt: serverTimestamp()
        });
      }catch(error){
        console.error("Lỗi khi gửi tin nhắn:", error);
        showErr(`Không thể gửi tin nhắn: ${error.message}`);
      }
    }
  </script>
</body>
</html>
