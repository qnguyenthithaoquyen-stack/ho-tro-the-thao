<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập - Hỗ Trợ Huấn Luyện Thể Thao</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body{font-family:'Roboto',sans-serif;margin:0;background-color:#f0f2f5;color:#333}
        .container{max-width:1200px;margin:0 auto;background-color:#fff;box-shadow:0 0 15px rgba(0,0,0,.07)}
        .header{display:flex;justify-content:space-between;align-items:center;padding:15px 30px;background-color:#008080;color:#fff}
        .header-left{display:flex;align-items:center}
        .logo{background-color:#fff;color:#008080;font-weight:700;padding:10px;border-radius:5px;margin-right:15px}
        .project-info h1{font-size:24px;margin:0;font-weight:700}
        .project-info p{font-size:12px;margin:0;opacity:.9}
        .navbar{display:flex;background-color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:0 30px}
        .navbar a{padding:15px 25px;text-decoration:none;color:#333;font-weight:500}
        .main-content{padding:60px 30px;display:flex;justify-content:center;align-items:center;background-color:#f0f2f5;min-height:60vh}
        .login-form-container{background-color:#fff;border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,.1);padding:40px;width:100%;max-width:400px}
        .login-form-container h2{font-size:28px;font-weight:700;color:#008080;text-align:center;margin-top:0;margin-bottom:30px}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;font-size:14px;font-weight:500;color:#555;margin-bottom:8px}
        .form-group input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box}
        .submit-btn{background-color:#008080;color:#fff;border:none;padding:14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:16px;width:100%;transition:background-color .3s}
        .submit-btn:hover{background-color:#006666}
        .signup-link{text-align:center;margin-top:20px;font-size:14px;color:#555}
        .signup-link a{color:#008080;font-weight:700;text-decoration:none}
        .message{margin-bottom:15px;padding:10px;border-radius:8px;display:none;text-align:center;border:1px solid transparent}
        .message.error{background-color:#f8d7da;color:#721c24;border-color:#f5c6cb}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo">LOGO</div>
                <div class="project-info">
                    <h1>HỖ TRỢ HUẤN LUYỆN THỂ THAO</h1>
                    <p>DỰ ÁN KHOA HỌC KỸ THUẬT</p>
                </div>
            </div>
        </header>
        <nav class="navbar">
            <a href="index.html">Trang chủ</a>
            <a href="gioithieu.html">Giới thiệu</a>
        </nav>
        <main class="main-content">
            <div class="login-form-container">
                <form id="loginForm">
                    <h2>Đăng nhập</h2>
                    <div id="error-message" class="message error"></div>
                    <div class="form-group">
                        <label for="email">EMAIL</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">MẬT KHẨU</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="submit-btn">Đăng Nhập</button>
                </form>
                <div class="signup-link">
                    Chưa có tài khoản? <a href="dangki.html">Đăng ký ngay</a>
                </div>
            </div>
        </main>
    </div>

    <!-- Toàn bộ JavaScript được tích hợp vào đây -->
    <script type="module">
        // Import các hàm cần thiết từ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Cấu hình Firebase của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyA2dXWCyjL2xgCSyeW9QQ7RvjI_O7kFHJw",
            authDomain: "sporthealthdata.firebaseapp.com",
            projectId: "sporthealthdata",
            storageBucket: "sporthealthdata.appspot.com",
            messagingSenderId: "789054240877",
            appId: "1:789054240877:web:04a400c9ea586523a86764",
            measurementId: "G-ZWS9C7P359"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Đợi cho toàn bộ nội dung trang (DOM) được tải xong
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            const errorMessageDiv = document.getElementById('error-message');

            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = loginForm.email.value;
                    const password = loginForm.password.value;
                    const submitButton = loginForm.querySelector('.submit-btn');

                    submitButton.disabled = true;
                    submitButton.textContent = 'Đang xử lý...';
                    errorMessageDiv.style.display = 'none';

                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        const userDocRef = doc(db, 'users', user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            const role = userData.role;

                            // **ĐÃ SỬA LỖI: Xây dựng URL đầy đủ để chuyển hướng**
                            const currentPath = window.location.pathname;
                            const newPath = currentPath.substring(0, currentPath.lastIndexOf('/'));

                            if (role === 'coach') {
                                window.location.href = newPath + '/coach-dashboard.html';
                            } else if (role === 'athlete') {
                                window.location.href = newPath + '/athlete-dashboard.html';
                            } else {
                                throw new Error('Không thể xác định vai trò người dùng.');
                            }
                        } else {
                            throw new Error('Không tìm thấy dữ liệu người dùng.');
                        }

                    } catch (error) {
                        console.error("Lỗi đăng nhập:", error);
                        
                        let friendlyMessage = 'Email hoặc mật khẩu không chính xác.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            friendlyMessage = 'Email hoặc mật khẩu không chính xác.';
                        } else {
                            friendlyMessage = 'Đã có lỗi xảy ra. Vui lòng thử lại.';
                        }
                        errorMessageDiv.textContent = friendlyMessage;
                        errorMessageDiv.style.display = 'block';

                        submitButton.disabled = false;
                        submitButton.textContent = 'Đăng Nhập';
                    }
                });
            }
        });
    </script>
</body>
</html>
