<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ph√¢n t√≠ch t∆∞ th·∫ø ‚Äî H·ªó tr·ª£ Hu·∫•n luy·ªán Th·ªÉ thao</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== Theme (dark-teal) ===== */
:root{
  --bg: #0b1620;
  --panel: #101d2a;
  --soft: #0f2330;
  --soft-2:#122839;
  --border:#183445;
  --text:#e6f1f7;
  --muted:#8fb6c8;
  --teal:#00b3a4;
  --teal-2:#009688;
  --warning:#ff6b6b;
  --ok:#1fb980;
  --shadow: 0 6px 18px rgba(0,0,0,.35);
  --radius: 14px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:radial-gradient(1200px 800px at -10% -10%, #163a4b 0%, var(--bg) 45%);
  color:var(--text); font-family:'Inter',system-ui,Arial,sans-serif;
}

/* ===== App bar ===== */
.appbar{
  max-width:1200px;margin:18px auto 0;
  background:linear-gradient(90deg,#0b3a45, #0b2f3a);
  border:1px solid #15424f;border-radius:16px;padding:14px 18px; box-shadow:var(--shadow);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.appbar .title{
  font-weight:700;font-size:18px; letter-spacing:.2px;
}
.appbar .subtitle{font-size:12px;color:var(--muted)}
.appbar .right{display:flex;gap:10px}
.btn{
  appearance:none;border:1px solid var(--border);color:var(--text);background:var(--soft);
  padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s; font-weight:600;
}
.btn:hover{background:#153548}
.btn.teal{background:var(--teal-2);border-color:transparent}
.btn.teal:hover{background:#007c70}
.btn.ghost{background:transparent}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);
  border-radius:999px;color:var(--muted);font-size:12px;background:rgba(255,255,255,.02)}
/* ===== Layout ===== */
.wrapper{max-width:1200px;margin:16px auto 28px;padding:0 2px}
.grid{
  display:grid; grid-template-columns: 1.25fr .9fr; gap:16px;
}
.card{
  background:linear-gradient(180deg,var(--panel),var(--soft));
  border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  padding:16px;
}
.card h3{margin:0 0 10px;font-size:15px;font-weight:700}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

.select, .file, .input{
  background:var(--soft-2); border:1px solid var(--border); color:var(--text);
  padding:10px 12px;border-radius:12px; font-weight:500; min-width:170px
}
.file{min-width:260px}
.small{color:var(--muted); font-size:12px}
.label{color:var(--muted); font-size:12px; margin-bottom:6px}

/* media player area */
.player{
  position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#000;
  min-height:260px;
}
.player video, .player canvas{display:block; width:100%; height:100%}
.player .badge-live{position:absolute; left:12px; top:12px}
.progress{display:flex; gap:10px; align-items:center; margin-top:12px}
.progress .bar{flex:1;height:10px;border-radius:999px;overflow:hidden;background:#0d2533;border:1px solid var(--border)}
.progress .bar span{display:block;height:100%;width:0;background:linear-gradient(90deg,#13c0aa,#19d4bf)}

.list{display:flex;flex-direction:column; gap:10px}
.item{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border:1px solid var(--border); background:rgba(255,255,255,.02); border-radius:12px; padding:10px 12px;
}
.item .meta{min-width:0}
.item .name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.item .sub{font-size:12px;color:var(--muted)}
.pill{padding:6px 10px;border-radius:999px;border:1px solid #204d60;background:#0d2a35;font-size:12px}
.pill.ok{border-color:#1b7a59;color:#b7f3da;background:#0e2e27}
.pill.warn{border-color:#7a1b1b;color:#ffd7d7;background:#2d1414}

/* charts area */
.chart-wrap{height:220px}

/* modal */
.modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:999}
.modal .box{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:18px; width:min(94vw,420px); box-shadow:var(--shadow)}
.modal .box p{margin:0 0 14px}
.modal .act{display:flex;justify-content:flex-end; gap:8px}

/* responsive */
@media (max-width: 980px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- ===== App Bar: T√™n VƒêV + n√∫t quay v·ªÅ + ti·ªán √≠ch ===== -->
<header class="appbar">
  <div>
    <div class="title" id="pageTitle">Ph√¢n t√≠ch t∆∞ th·∫ø cho VƒêV</div>
    <div class="subtitle">T·∫£i video, ch·∫°y MediaPipe, so kh·ªõp v·ªõi khung chu·∫©n theo m√¥n & g√≥c quay.</div>
  </div>
  <div class="right">
    <a class="btn ghost" href="bangdieukhien.html">‚Üê B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
    <button id="exportReportBtn" class="btn teal">Xu·∫•t b√°o c√°o</button>
    <a class="btn ghost" href="#dash" id="toggleDashboardBtn">Dashboard</a>
  </div>
</header>

<div class="wrapper">
  <div class="grid">
    <!-- LEFT: Player & Tools -->
    <section class="card">
      <h3>Tr√¨nh ph√°t & ƒêi·ªÅu khi·ªÉn</h3>

      <div class="player" id="playerWrap">
        <video id="player" controls playsinline crossorigin="anonymous" muted></video>
        <canvas id="overlay"></canvas>
        <div class="badge badge-live pill" id="liveBadge" style="display:none">ƒêang ki·ªÉm tra‚Ä¶</div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <div class="label">M√¥n th·ªÉ thao</div>
          <select id="sport" class="select">
            <option value="xuatphat">Xu·∫•t ph√°t</option>
            <option value="nhaycao">Nh·∫£y cao</option>
            <option value="nemta">N√©m t·∫°</option>
          </select>
        </div>
        <div>
          <div class="label">G√≥c quay</div>
          <select id="viewSel" class="select">
            <option value="auto">T·ª± ƒë·ªông</option>
            <option value="front">Tr∆∞·ªõc / Sau</option>
            <option value="left">B√™n tr√°i</option>
            <option value="right">B√™n ph·∫£i</option>
            <option value="back">ƒê·∫±ng sau</option>
          </select>
        </div>
        <div style="flex:1;min-width:280px">
          <div class="label">T·∫£i video (.mp4, .mov)</div>
          <input id="videoUpload" type="file" accept="video/*" multiple class="file" />
        </div>
        <div class="row" style="gap:8px; margin-left:auto">
          <button id="analyzeBtn" class="btn teal">Ph√¢n t√≠ch</button>
          <button id="forceAnalyzeBtn" class="btn">Ph√¢n t√≠ch l·∫°i</button>
          <button id="clearStorage" class="btn">X√≥a d·ªØ li·ªáu</button>
        </div>
      </div>

      <div class="progress" id="progressRow" style="display:none">
        <div class="bar"><span id="progressBar"></span></div>
        <div class="small" id="progressText">0%</div>
      </div>

      <div style="margin-top:16px">
        <h3>L·ªãch s·ª≠ (l·ªçc theo m√¥n)</h3>
        <div id="videoList" class="list"></div>
      </div>
    </section>

    <!-- RIGHT: Analysis & Chart -->
    <aside class="card">
      <h3>Th√¥ng tin ph√¢n t√≠ch</h3>
      <div id="analysisPanel" class="small pill" style="border-radius:10px">Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.</div>

      <h3 style="margin-top:14px">Th·ªëng k√™ t·ªâ l·ªá ƒë√∫ng</h3>
      <div class="chart-wrap"><canvas id="chartCanvas"></canvas></div>
    </aside>
  </div>

  <!-- Dashboard m·ªü r·ªông (·∫©n/hi·ªán) -->
  <section class="card" id="dashboardCard" style="display:none; margin-top:16px">
    <div class="row" style="justify-content:space-between">
      <h3>Dashboard N√¢ng cao</h3>
      <span class="badge" id="aiStatusPill">AI: ch∆∞a t·∫£i</span>
    </div>
    <div class="row" style="flex-wrap:wrap; gap:16px; margin-top:4px">
      <div style="flex:1 1 320px">
        <div class="label">G√≥c theo th·ªùi gian</div>
        <div class="chart-wrap"><canvas id="angleChart"></canvas></div>
      </div>
      <div style="flex:1 1 320px">
        <div class="label">V·∫≠n t·ªëc theo th·ªùi gian</div>
        <div class="chart-wrap"><canvas id="velChart"></canvas></div>
      </div>
      <div style="flex:1 1 320px">
        <div class="label">ROM (Ph·∫°m vi c·ª≠ ƒë·ªông)</div>
        <div class="chart-wrap"><canvas id="romChart"></canvas></div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="runModelBtn" class="btn teal">Ch·∫°y m√¥ h√¨nh AI</button>
      <button id="exportFeaturesBtn" class="btn">Xu·∫•t Features (.json)</button>
      <button id="exportFeaturesCsvBtn" class="btn">Xu·∫•t Features (.csv)</button>
    </div>
    <div class="small" id="aiAlerts" style="margin-top:10px">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
  </section>

  <p class="small" style="text-align:center;opacity:.75;margin-top:18px">
    ¬© 2025 ‚Äî Demo giao di·ªán theo y√™u c·∫ßu: thanh c√¥ng c·ª• (t√™n VƒêV, quay v·ªÅ), ch·ªçn m√¥n, ch·ªçn g√≥c quay, t·∫£i video, n√∫t ph√¢n t√≠ch, video + canvas, k·∫øt qu·∫£ & l·ªãch s·ª≠.
  </p>
</div>

<!-- Modal -->
<div class="modal" id="customModal">
  <div class="box">
    <p id="modalText"></p>
    <div class="act" id="modalActions">
      <button class="btn teal" id="modalCloseBtn">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>

<script type="module">
/* ================== Firebase ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2dXWCyjL2xgCSyeW9QQ7RvjI_O7kFHJw",
  authDomain: "sporthealthdata.firebaseapp.com",
  projectId: "sporthealthdata",
  storageBucket: "sporthealthdata.appspot.com",
  messagingSenderId: "789054240877",
  appId: "1:789054240877:web:04a400c9ea586523a86764",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================== DOM refs ================== */
const sportSel = document.getElementById('sport');
const viewSel  = document.getElementById('viewSel');
const videoUpload = document.getElementById('videoUpload');
const videoListEl = document.getElementById('videoList');
const player = document.getElementById('player');
const overlay = document.getElementById('overlay');
const analyzeBtn = document.getElementById('analyzeBtn');
const forceAnalyzeBtn = document.getElementById('forceAnalyzeBtn');
const analysisPanel = document.getElementById('analysisPanel');
const chartCanvas = document.getElementById('chartCanvas');
const clearStorageBtn = document.getElementById('clearStorage');
const progressRow = document.getElementById('progressRow');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const liveBadge = document.getElementById('liveBadge');
const exportBtn = document.getElementById('exportReportBtn');
const dashCard = document.getElementById('dashboardCard');
const toggleDashboardBtn = document.getElementById('toggleDashboardBtn');
const angleChartEl = document.getElementById('angleChart');
const velChartEl = document.getElementById('velChart');
const romChartEl = document.getElementById('romChart');
const aiAlertsEl = document.getElementById('aiAlerts');
const aiStatusPill = document.getElementById('aiStatusPill');
const pageTitleEl = document.getElementById('pageTitle');

/* ================== Title from URL ================== */
const urlParams = new URLSearchParams(window.location.search);
const athleteName = urlParams.get('athleteName');
if (athleteName) pageTitleEl.textContent = `Ph√¢n t√≠ch t∆∞ th·∫ø cho VƒêV: ${decodeURIComponent(athleteName)}`;

/* ================== Local state ================== */
let uploadedVideos = [];
let results = JSON.parse(localStorage.getItem('thethaott_results')||'{}');
let currentVideo = null;
let chart=null, mpPose=null, mpPoseDrawingCallback=null, overlayPass=null, lastPoseLandmarks=null;
let featTime=[], featAngles=[], featVel=[], featROM={}, aiModel=null, aiAvailable=false;
let viewCounts={front:0,left:0,right:0,back:0};

/* ================== IndexedDB (gi·ªØ video) ================== */
const DB_NAME='thethaott_videos_db', DB_VERSION=1, STORE_NAME='videos';
let idb;
function initDB(){return new Promise((res,rej)=>{
  const req=indexedDB.open(DB_NAME,DB_VERSION);
  req.onupgradeneeded=e=>{
    const dbi=e.target.result;
    if(!dbi.objectStoreNames.contains(STORE_NAME))
      dbi.createObjectStore(STORE_NAME,{keyPath:'id'});
  };
  req.onsuccess=e=>{idb=e.target.result;res()}
  req.onerror=e=>rej(e);
})}
function saveVideoToDB(video){return new Promise((res,rej)=>{
  const tx=idb.transaction([STORE_NAME],'readwrite'); tx.objectStore(STORE_NAME).put(video);
  tx.oncomplete=res; tx.onerror=e=>rej(e);
})}
function getVideosFromDB(){return new Promise((res,rej)=>{
  const tx=idb.transaction([STORE_NAME],'readonly'); const rq=tx.objectStore(STORE_NAME).getAll();
  rq.onsuccess=e=>res(e.target.result); rq.onerror=e=>rej(e);
})}
function deleteVideoFromDB(id){return new Promise((res,rej)=>{
  const tx=idb.transaction([STORE_NAME],'readwrite'); tx.objectStore(STORE_NAME).delete(id);
  tx.oncomplete=res; tx.onerror=e=>rej(e);
})}
function clearVideosFromDB(){return new Promise((res,rej)=>{
  const tx=idb.transaction([STORE_NAME],'readwrite'); tx.objectStore(STORE_NAME).clear();
  tx.oncomplete=res; tx.onerror=e=>rej(e);
})}

/* ================== UI helpers ================== */
function setProgress(p, text){
  progressRow.style.display='flex';
  progressBar.style.width=Math.max(0,Math.min(100,p))+'%';
  progressText.textContent=text ?? `${Math.round(p)}%`;
  if(p>=100) setTimeout(()=>progressRow.style.display='none', 400);
}
function showModal(msg,isConfirm=false,onConfirm=null){
  const m=document.getElementById('customModal'); const t=document.getElementById('modalText'); const a=document.getElementById('modalActions');
  t.textContent=msg; a.innerHTML='';
  if(isConfirm){
    const c1=document.createElement('button'); c1.className='btn'; c1.textContent='H·ªßy'; c1.onclick=()=>m.style.display='none';
    const c2=document.createElement('button'); c2.className='btn teal'; c2.textContent='X√°c nh·∫≠n'; c2.onclick=()=>{onConfirm&&onConfirm(); m.style.display='none'};
    a.append(c1,c2);
  }else{
    const c=document.createElement('button'); c.className='btn teal'; c.textContent='ƒê√≥ng'; c.onclick=()=>m.style.display='none'; a.append(c);
  }
  m.style.display='flex';
}
document.getElementById('modalCloseBtn').onclick=()=>document.getElementById('customModal').style.display='none';
function saveResults(){localStorage.setItem('thethaott_results',JSON.stringify(results)); renderChart()}

/* ================== MediaPipe Pose ================== */
function ensureMpPose(){
  if(typeof Pose==='undefined') return null;
  if(!mpPose){
    mpPose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
    mpPose.setOptions({modelComplexity:1,smoothLandmarks:true,enableSegmentation:false,minDetectionConfidence:.45,minTrackingConfidence:.45});
    mpPose.onResults(r=>{ if(r && r.poseLandmarks) lastPoseLandmarks=r.poseLandmarks });
  }
  return mpPose;
}

/* ======= Khung chu·∫©n (ƒë√£ tinh ch·ªânh) ======= */
const KHUNG_CHUAN = {
  xuatphat:[
    {name:'G·ªëi tr·ª•', joints:['kneeL','kneeR'], want:100, tol:18, anySide:true},
    {name:'H√¥ng', joints:['hipL','hipR'], want:120, tol:20, anySide:true},
    {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:42, tol:12},
    {name:'Khu·ª∑u tay tr·ª•', joints:['elbowL','elbowR'], want:95, tol:20, anySide:true}
  ],
  nhaycao:[
    {name:'G·ªëi ch√¢n gi·∫≠m', joints:['kneeL','kneeR'], want:155, tol:18, anySide:true},
    {name:'H√¥ng m·ªü', joints:['hipL','hipR'], want:165, tol:18, anySide:true},
    {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:18, tol:12},
    {name:'Vai vung', joints:['shoulderL','shoulderR'], want:160, tol:20, anySide:true}
  ],
  nemta:[
    {name:'G·ªëi', joints:['kneeL','kneeR'], want:110, tol:20, anySide:true},
    {name:'H√¥ng xoay', joints:['hipL','hipR'], want:125, tol:20, anySide:true},
    {name:'Khu·ª∑u tay', joints:['elbowL','elbowR'], want:100, tol:20, anySide:true},
    {name:'Vai', joints:['shoulderL','shoulderR'], want:90, tol:22, anySide:true},
    {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:30, tol:12}
  ]
};
const KHUNG_CHUAN_GOC = {
  xuatphat:{
    front:KHUNG_CHUAN.xuatphat,
    back: KHUNG_CHUAN.xuatphat,
    left:[
      {name:'G·ªëi g·∫ßn camera', joints:['kneeL','kneeR'], want:100, tol:20, anySide:true},
      {name:'H√¥ng g·∫ßn camera', joints:['hipL','hipR'], want:120, tol:22, anySide:true},
      {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:45, tol:14}
    ],
    right:[
      {name:'G·ªëi g·∫ßn camera', joints:['kneeL','kneeR'], want:100, tol:20, anySide:true},
      {name:'H√¥ng g·∫ßn camera', joints:['hipL','hipR'], want:120, tol:22, anySide:true},
      {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:45, tol:14}
    ],
  },
  nhaycao:{
    front:KHUNG_CHUAN.nhaycao,
    back: KHUNG_CHUAN.nhaycao,
    left:[
      {name:'G·ªëi gi·∫≠m', joints:['kneeL','kneeR'], want:155, tol:20, anySide:true},
      {name:'H√¥ng m·ªü', joints:['hipL','hipR'], want:165, tol:20, anySide:true},
      {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:20, tol:14}
    ],
    right:[
      {name:'G·ªëi gi·∫≠m', joints:['kneeL','kneeR'], want:155, tol:20, anySide:true},
      {name:'H√¥ng m·ªü', joints:['hipL','hipR'], want:165, tol:20, anySide:true},
      {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:20, tol:14}
    ],
  },
  nemta:{
    front:KHUNG_CHUAN.nemta, back:KHUNG_CHUAN.nemta,
    left:[
      {name:'H√¥ng g·∫ßn camera', joints:['hipL','hipR'], want:125, tol:22, anySide:true},
      {name:'Vai g·∫ßn camera', joints:['shoulderL','shoulderR'], want:90, tol:24, anySide:true},
      {name:'Khu·ª∑u tay g·∫ßn camera', joints:['elbowL','elbowR'], want:100, tol:22, anySide:true},
      {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:30, tol:14}
    ],
    right:[
      {name:'H√¥ng g·∫ßn camera', joints:['hipL','hipR'], want:125, tol:22, anySide:true},
      {name:'Vai g·∫ßn camera', joints:['shoulderL','shoulderR'], want:90, tol:24, anySide:true},
      {name:'Khu·ª∑u tay g·∫ßn camera', joints:['elbowL','elbowR'], want:100, tol:22, anySide:true},
      {name:'Th√¢n nghi√™ng', joints:['torsoIncline'], want:30, tol:14}
    ],
  }
};
const PER_FRAME_THRESH={xuatphat:0.6, nhaycao:0.55, nemta:0.6};

/* ======= Tools: g√≥c & ƒë√°nh gi√° ======= */
function degBetween(a,b,c){
  const abx=a.x-b.x, aby=a.y-b.y, cbx=c.x-b.x, cby=c.y-b.y;
  const dot=abx*cbx+aby*cby; const mag=Math.sqrt((abx*abx+aby*aby)*(cbx*cbx+cby*cby))||1;
  let cos=dot/mag; cos=Math.max(-1,Math.min(1,cos));
  return Math.acos(cos)*180/Math.PI;
}
function torsoInclineDeg(lm){
  const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24]; if(!(lS&&rS&&lH&&rH)) return 0;
  const s={x:(lS.x+rS.x)/2, y:(lS.y+rS.y)/2}, h={x:(lH.x+rH.x)/2, y:(lH.y+rH.y)/2};
  const dx=s.x-h.x, dy=s.y-h.y; return Math.atan2(Math.abs(dy), Math.abs(dx))*180/Math.PI;
}
function extractAngles(lm){
  const A={};
  if(lm[23]&&lm[25]&&lm[27]) A.kneeL=degBetween(lm[23],lm[25],lm[27]);
  if(lm[24]&&lm[26]&&lm[28]) A.kneeR=degBetween(lm[24],lm[26],lm[28]);
  if(lm[11]&&lm[23]&&lm[25]) A.hipL=degBetween(lm[11],lm[23],lm[25]);
  if(lm[12]&&lm[24]&&lm[26]) A.hipR=degBetween(lm[12],lm[24],lm[26]);
  if(lm[11]&&lm[13]&&lm[15]) A.elbowL=degBetween(lm[11],lm[13],lm[15]);
  if(lm[12]&&lm[14]&&lm[16]) A.elbowR=degBetween(lm[12],lm[14],lm[16]);
  if(lm[13]&&lm[11]&&lm[23]) A.shoulderL=degBetween(lm[13],lm[11],lm[23]);
  if(lm[14]&&lm[12]&&lm[24]) A.shoulderR=degBetween(lm[14],lm[12],lm[24]);
  A.torsoIncline=torsoInclineDeg(lm);
  return A;
}
function detectView2D(lm){
  const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24]; if(!(lS&&rS&&lH&&rH)) return 'front';
  const sMid={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2}; const hMid={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};
  const torso=Math.hypot(sMid.x-hMid.x,sMid.y-hMid.y); const shoulderW=Math.abs(rS.x-lS.x); 
  const ratio=shoulderW/(torso||1); if(ratio<.55){return(rS.x>lS.x)?'right':'left'} return 'front';
}
function getRulesByView(s,v){const g=KHUNG_CHUAN_GOC[s]; return (g&&g[v])?g[v]:KHUNG_CHUAN[s]||[]}
function checkAgainstStandard(angles,sport,view){
  const rules=getRulesByView(sport,view); let ok=0;
  for(const r of rules){
    let good=false;
    if(r.anySide){ for(const k of r.joints){ const v=angles[k]; if(typeof v==='number' && Math.abs(v-r.want)<=r.tol){good=true;break}}}
    else { const v=angles[r.joints[0]]; if(typeof v==='number' && Math.abs(v-r.want)<=r.tol) good=true }
    if(good) ok++;
  }
  const score=(rules.length? ok/rules.length : 0);
  return {pass: score >= (PER_FRAME_THRESH[sport]??0.6), okCount:ok, totalRules:rules.length, rules};
}
function angleVelocity(prev,curr,dt){
  const out={}; const keys=new Set([...Object.keys(prev||{}),...Object.keys(curr||{})]);
  keys.forEach(k=>{const a=(curr&&typeof curr[k]==='number')?curr[k]:null; const b=(prev&&typeof prev[k]==='number')?prev[k]:null; out[k]=(a!=null&&b!=null&&dt>0)?(a-b)/dt:0});
  return out;
}
function computeROM(series){
  const keys=new Set(); series.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));
  const rom={}; keys.forEach(k=>{let min=+Infinity,max=-Infinity; series.forEach(a=>{const v=a[k]; if(typeof v==='number'){if(v<min)min=v;if(v>max)max=v}}); if(min<+Infinity&&max>-Infinity) rom[k]={min,max,range:max-min}});
  return rom;
}

/* ====== Ph√¢n lo·∫°i k·∫øt qu·∫£ ====== */
const DU_LIEU={
  xuatphat:{loi:["G·∫≠p g·ªëi ch∆∞a ƒë√∫ng g√≥c","Tay ch·ªëng ch∆∞a v·ªØng","Th√¢n ng∆∞·ªùi h∆°i nghi√™ng v·ªÅ tr∆∞·ªõc"],chanthuong:["C·ªï tay","G·ªëi","Vai"],goiy:["Gi·ªØ th√¢n ng∆∞·ªùi ·ªïn ƒë·ªãnh khi xu·∫•t ph√°t","TƒÉng t·ªëc b·∫±ng m≈©i ch√¢n","T·∫≠p ph·∫£n x·∫° b·∫≠t nhanh"]},
  nhaycao:{loi:["Ch·∫°y ƒë√† ch·∫≠m","G·ªëi kh√¥ng n√¢ng cao","Kh√¥ng ki·ªÉm so√°t cong l∆∞ng"],chanthuong:["G·ªëi","C·ªôt s·ªëng th·∫Øt l∆∞ng"],goiy:["Ch·∫°y ƒë√† + nh·∫£y 1 ch√¢n","Gi√£n c·ªôt s·ªëng","B·∫≠t nh·∫£y n√¢ng g·ªëi"]},
  nemta:{loi:["H·∫° vai khi xoay","Ch∆∞a t·ªëi ∆∞u l·ª±c ch√¢n"],chanthuong:["C·ªï tay","Vai","L∆∞ng"],goiy:["TƒÉng c∆° b·ª•ng xoay","Ph·ªëi h·ª£p ch√¢n‚Äìtr·ª•c‚Äìƒë·∫©y t·∫°","Xoay ng∆∞·ªùi ch·∫≠m gi·ªØ vai"]}
};
function deterministicClassification(tile,sport){
  const b=DU_LIEU[sport]; if(tile===100) return{loi:[],chanthuong:[],goiy:[],xeploai:'HO√ÄN H·∫¢O',dongvien:'üåü Xu·∫•t s·∫Øc!',ketluan:'Gi·ªØ v·ªØng phong ƒë·ªô'};
  if(tile>=90) return{loi:b.loi.slice(0,1),chanthuong:b.chanthuong.slice(0,1),goiy:b.goiy.slice(0,1),xeploai:'T·ªêT',dongvien:'üî• R·∫•t t·ªët!',ketluan:'Gi·ªØ v·ªØng'};
  if(tile>=70) return{loi:b.loi.slice(0,2),chanthuong:b.chanthuong.slice(0,2),goiy:b.goiy.slice(0,2),xeploai:'KH√Å',dongvien:'üëç Kh√°, c·∫ßn ho√†n thi·ªán',ketluan:'C·∫£i thi·ªán v√†i ƒëi·ªÉm'};
  return {loi:b.loi,chanthuong:b.chanthuong,goiy:b.goiy,xeploai:'TRUNG B√åNH',dongvien:'‚ö†Ô∏è C·∫ßn c·ªë g·∫Øng',ketluan:'T·∫≠p trung luy·ªán th√™m'};
}

/* ======= Renderers ======= */
function renderChart(){
  const sport=sportSel.value; const keys=Object.keys(results).filter(k=>results[k].sport===sport);
  const labels=keys.map(k=>results[k].name), data=keys.map(k=>results[k].tile);
  if(chart) chart.destroy();
  chart=new Chart(chartCanvas.getContext('2d'),{
    type:'bar', data:{labels,datasets:[{label:'T·ªâ l·ªá ƒë√∫ng (%)',data,backgroundColor:'rgba(0,179,164,.8)',borderColor:'#00b3a4'}]},
    options:{indexAxis:'y',scales:{x:{min:0,max:110,ticks:{color:'#8fb6c8'},grid:{color:'#183445'}},y:{ticks:{color:'#cfe4ee'},grid:{display:false}}},plugins:{legend:{display:false}}}
  })
}
function showAnalysisPanel(res){
  if(!res){analysisPanel.innerHTML='Ch∆∞a c√≥ ph√¢n t√≠ch.';return}
  let s=`<div class="small">`;
  s+=`<div><strong>${res.name}</strong></div>`;
  s+=`<div>G√≥c √°p d·ª•ng: <span class="pill">${(res.view||'auto').toUpperCase()}</span></div>`;
  s+=`<div>T·ªâ l·ªá ƒë√∫ng: <span class="pill ok">${res.tile}%</span> (ƒê√∫ng: ${res.dung} | Sai: ${res.sai})</div>`;
  s+=`<div>X·∫øp lo·∫°i: <strong>${res.xeploai}</strong> ‚Äî ${res.ketluan}</div>`;
  if(res.tile<100){
    s+=`<hr style="border:none;border-top:1px solid #183445">`;
    s+=`<div><strong>‚ùå L·ªói t∆∞ th·∫ø</strong><ul>`+res.loi.map(x=>`<li>${x}</li>`).join('')+`</ul></div>`;
    s+=`<div><strong>‚ö†Ô∏è Ch·∫•n th∆∞∆°ng</strong><ul>`+res.chanthuong.map(x=>`<li>${x}</li>`).join('')+`</ul></div>`;
    s+=`<div><strong>üí° G·ª£i √Ω</strong><ul>`+res.goiy.map(x=>`<li>${x}</li>`).join('')+`</ul></div>`;
  }
  s+=`</div>`;
  analysisPanel.innerHTML=s;
}
function renderVideoList(){
  const sport=sportSel.value; videoListEl.innerHTML='';
  const filtered=uploadedVideos.filter(v=> v.sportTag===sport || (v.name||'').toLowerCase().includes(sport));
  if(filtered.length===0){videoListEl.innerHTML='<div class="small">Ch∆∞a c√≥ video cho m√¥n n√†y.</div>'; return}
  filtered.forEach(v=>{
    const has=!!results[v.id];
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`
      <div class="meta">
        <div class="name" title="${v.name}">${v.name}</div>
        <div class="sub">${v.sportTag||''}</div>
      </div>
      <div class="row" style="gap:8px">
        ${has?'<span class="pill ok">ƒê√£ ph√¢n t√≠ch</span>':''}
        <button class="btn ghost btn-open">Xem</button>
        <button class="btn ${has?'':'teal'} btn-analyze">${has?'Ph√¢n t√≠ch l·∫°i':'Ph√¢n t√≠ch'}</button>
        <button class="btn ghost btn-del">X√≥a</button>
      </div>`;
    row.querySelector('.btn-open').onclick=()=>openVideo(v);
    row.querySelector('.btn-analyze').onclick=()=>{openVideo(v); setTimeout(()=>runAnalysisIfNeeded(v,has),200)}
    row.querySelector('.btn-del').onclick=()=>deleteVideo(v.id);
    videoListEl.appendChild(row);
  })
}

/* ======= Dashboard charts ======= */
function renderDashboard(res){
  const t=featTime, pick=(arr,key)=>arr.map(a=> (typeof a[key]==='number')?a[key]:0 );
  const knee=pick(featAngles,'kneeL').map((v,i)=>Math.max(v,pick(featAngles,'kneeR')[i]||v));
  const hip=pick(featAngles,'hipL').map((v,i)=>Math.max(v,pick(featAngles,'hipR')[i]||v));
  const torso=pick(featAngles,'torsoIncline');
  const velKnee=pick(featVel,'kneeL').map((v,i)=>Math.abs(Math.max(v,pick(featVel,'kneeR')[i]||v)));
  const velHip=pick(featVel,'hipL').map((v,i)=>Math.abs(Math.max(v,pick(featVel,'hipR')[i]||v)));
  if(window._angleChart) window._angleChart.destroy();
  if(window._velChart) window._velChart.destroy();
  if(window._romChart) window._romChart.destroy();

  const baseOpt={responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
    scales:{x:{ticks:{color:'#8fb6c8'},grid:{color:'#183445'}},y:{ticks:{color:'#8fb6c8'},grid:{color:'#183445'}}}, plugins:{legend:{labels:{color:'#cfe4ee'}}}};
  window._angleChart=new Chart(angleChartEl.getContext('2d'),{type:'line',
    data:{labels:t,datasets:[{label:'G·ªëi',data:knee,borderColor:'#00b3a4',tension:.1},{label:'H√¥ng',data:hip,borderColor:'#6f42c1',tension:.1},{label:'Th√¢n',data:torso,borderColor:'#fd7e14',tension:.1}]},options:baseOpt});
  window._velChart=new Chart(velChartEl.getContext('2d'),{type:'line',
    data:{labels:t,datasets:[{label:'|v| G·ªëi',data:velKnee,borderColor:'#1fb980',tension:.1},{label:'|v| H√¥ng',data:velHip,borderColor:'#ff6b6b',tension:.1}]},
    options:{...baseOpt,scales:{...baseOpt.scales,y:{...baseOpt.scales.y,title:{display:true,text:'¬∞/s',color:'#8fb6c8'}}}}});
  const rom=res.features?.rom||{}; const romLabels=Object.keys(rom); const romData=romLabels.map(k=>rom[k].range);
  window._romChart=new Chart(romChartEl.getContext('2d'),{type:'bar',data:{labels:romLabels,datasets:[{label:'ROM (¬∞)',data:romData,backgroundColor:'rgba(0,179,164,.7)'}]},
  options:{...baseOpt,indexAxis:'y'}});
  aiAlertsEl.innerHTML='<span class="small">·∫§n "Ch·∫°y m√¥ h√¨nh AI" ƒë·ªÉ d·ª± ƒëo√°n.</span>';
}

/* ======= Firestore save ======= */
async function saveAchievementToFirestore(result, athleteId){
  if(!athleteId||!result) return;
  try{
    const colRef=collection(db,"users",athleteId,"achievements");
    await addDoc(colRef,{date: serverTimestamp(), eventName:`Ph√¢n t√≠ch t∆∞ th·∫ø video: ${result.name}`, result:`T·ªâ l·ªá ƒë√∫ng: ${result.tile}%`, notes:`X·∫øp lo·∫°i: ${result.xeploai}. ${result.ketluan}`});
  }catch(e){console.error('Save achievements error',e)}
}
async function saveInjuryWarningsToFirestore(result, athleteId){
  if(!athleteId || !result?.chanthuong?.length) return;
  try{
    const colRef=collection(db,"users",athleteId,"warnings");
    for(const inj of result.chanthuong){
      await addDoc(colRef,{date:serverTimestamp(),title:`Nguy c∆° ch·∫•n th∆∞∆°ng: ${inj}`,description:`Ph√°t hi·ªán nguy c∆° v√πng ${inj} trong video "${result.name}".`,severity:'medium'});
    }
  }catch(e){console.error('Save warnings error',e)}
}

/* ======= Analyze core ======= */
async function analyzeVideoUsingMediaPipe(videoFile,sport,force=false){
  const id=videoFile.id; if(results[id] && !force) return results[id];
  if(!ensureMpPose()){showModal('Kh√¥ng kh·ªüi t·∫°o ƒë∆∞·ª£c MediaPipe Pose.');return null}
  featTime=[]; featAngles=[]; featVel=[]; featROM={}; viewCounts={front:0,left:0,right:0,back:0};

  player.src=videoFile.url; player.muted=true; player.crossOrigin='anonymous';
  await new Promise(r=>{ if(player.readyState>=1) return r(); const fn=()=>{player.removeEventListener('loadedmetadata',fn);r()}; player.addEventListener('loadedmetadata',fn); setTimeout(r,1500) });
  player.pause();

  const total=60, duration=player.duration||3, stepSec=Math.max(.08, duration/total);
  let sampled=0, valid=0, prevAngles=null;

  setProgress(0,'0%'); const chosen=viewSel.value;
  for(let i=0;i<total;i++){
    const t=Math.min(i*stepSec, Math.max(0,(player.duration||duration)-.05));
    await new Promise(resolve=>{
      const cb=(resPose)=>{
        sampled++; let pass=false;
        if(resPose?.poseLandmarks?.length){
          const w=player.videoWidth||overlay.width||640, h=player.videoHeight||overlay.height||360;
          const lm=resPose.poseLandmarks.map(l=>({x:l.x*w, y:l.y*h}));
          const auto=detectView2D(lm); if(viewCounts[auto]!=null) viewCounts[auto]++; const use=(chosen==='auto')?auto:chosen;
          const nose=lm[0]||{x:w/2,y:h/2}; const near=Math.abs(nose.x-w/2)<w*.60;
          if(near){
            const ang=extractAngles(lm); const chk=checkAgainstStandard(ang,sport,use); pass=chk.pass; overlayPass=pass?'pass':'fail';
            const dt=featTime.length? (t-featTime[featTime.length-1]) : stepSec; const vel=angleVelocity(prevAngles||ang,ang,dt);
            featTime.push(t); featAngles.push(ang); featVel.push(vel); prevAngles=ang;
          }
        }else if(lastPoseLandmarks?.length){
          const w=player.videoWidth||overlay.width||640, h=player.videoHeight||overlay.height||360;
          const lm=lastPoseLandmarks.map(l=>({x:l.x*w, y:l.y*h})); const auto=detectView2D(lm); if(viewCounts[auto]!=null) viewCounts[auto]++;
          const use=(chosen==='auto')?auto:chosen; const ang=extractAngles(lm); const chk=checkAgainstStandard(ang,sport,use); pass=chk.pass; overlayPass=pass?'pass':'fail';
          const dt=featTime.length? (t-featTime[featTime.length-1]) : stepSec; const vel=angleVelocity(prevAngles||ang,ang,dt);
          featTime.push(t); featAngles.push(ang); featVel.push(vel); prevAngles=ang;
        }
        if(pass) valid++;
        const pct=Math.round(((i+1)/total)*100); setProgress(pct, pct+'%'); setTimeout(resolve,8);
      };
      mpPose.onResults(cb);
      const onSeek=async()=>{player.removeEventListener('seeked',onSeek); try{await mpPose.send({image:player})}catch(e){}};
      player.addEventListener('seeked',onSeek); try{player.currentTime=t}catch(e){player.removeEventListener('seeked',onSeek); resolve()}
      setTimeout(()=>resolve(),3000);
    })
  }

  let decided=viewSel.value; if(decided==='auto'){decided=Object.entries(viewCounts).sort((a,b)=>b[1]-a[1])[0]?.[0]||'front'}
  if(valid/Math.max(sampled,1)<.25){ setProgress(100,'Xong'); showModal('Video kh√¥ng ph√π h·ª£p v·ªõi m√¥n ƒë√£ ch·ªçn.'); return null }

  const summary = summarizeFeatures(); featROM=summary.rom;
  const tile=Math.round((valid/Math.max(sampled,1))*100), sai=Math.max(0,Math.round(sampled-valid)), dung=Math.max(0,Math.round(valid));
  const extra=deterministicClassification(tile,sport);
  const result={id:videoFile.id, name:videoFile.name, sport, sai,dung,tile, view:decided, khungChuan:getRulesByView(sport,decided), features:summary, ...extra};
  results[videoFile.id]=result; saveResults(); setProgress(100,'Xong');

  const athleteId=urlParams.get('athleteId'); if(athleteId){ saveAchievementToFirestore(result,athleteId); saveInjuryWarningsToFirestore(result,athleteId) }
  return result;
}
function summarizeFeatures(){
  const keys=new Set(); featAngles.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));
  const sum={},sumSq={}; keys.forEach(k=>{sum[k]=0; sumSq[k]=0}); const n=featAngles.length;
  featAngles.forEach(a=>{ keys.forEach(k=>{const v=typeof a[k]==='number'?a[k]:0; sum[k]+=v; sumSq[k]+=v*v}) });
  const mean={},std={}; keys.forEach(k=>{mean[k]=n?(sum[k]/n):0; std[k]=n?Math.sqrt(Math.max(0,sumSq[k]/n-mean[k]*mean[k])):0});
  const rom=computeROM(featAngles);
  const vKeys=new Set(); featVel.forEach(a=>Object.keys(a).forEach(k=>vKeys.add(k)));
  const vsum={},vsumSq={}; vKeys.forEach(k=>{vsum[k]=0;vsumSq[k]=0}); const vn=featVel.length;
  featVel.forEach(a=>{ vKeys.forEach(k=>{const v=typeof a[k]==='number'?a[k]:0; vsum[k]+=v; vsumSq[k]+=v*v}) });
  const vmean={}, vstd={}; vKeys.forEach(k=>{vmean[k]=vn?(vsum[k]/vn):0; vstd[k]=vn?Math.sqrt(Math.max(0,vsumSq[k]/vn-vmean[k]*vmean[k])):0});
  return {mean,std,rom,vmean,vstd, nFrames:n, duration: featTime.length? featTime[featTime.length-1]-featTime[0]:0};
}

/* ======= Open / analyze / delete / export ======= */
async function openVideo(v){
  currentVideo=v; player.src=v.url; player.muted=false; player.crossOrigin='anonymous'; player.playsInline=true;
  await new Promise(r=>{if(player.readyState>=1) return r(); const fn=()=>{player.removeEventListener('loadedmetadata',fn);r()}; player.addEventListener('loadedmetadata',fn); setTimeout(r,1000)});
  player.pause();
  function resize(){
    const rect=player.getBoundingClientRect(); const dpr=window.devicePixelRatio||1;
    overlay.style.width=rect.width+'px'; overlay.style.height=rect.height+'px';
    const w=Math.max(1,player.videoWidth||rect.width||640), h=Math.max(1,player.videoHeight||rect.height||360);
    overlay.width=Math.round(w*dpr); overlay.height=Math.round(h*dpr); const ctx=overlay.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
  } resize(); window.addEventListener('resize',resize);
  showAnalysisPanel(results[v.id]); renderChart(); ensureMpPose();

  const ctx=overlay.getContext('2d');
  mpPoseDrawingCallback=(r)=>{
    if(r?.poseLandmarks?.length) lastPoseLandmarks=r.poseLandmarks;
    const w=player.videoWidth||overlay.width||640, h=player.videoHeight||overlay.height||360;
    ctx.clearRect(0,0,overlay.width,overlay.height);
    if(lastPoseLandmarks?.length){
      const lm=lastPoseLandmarks.map(l=>({x:l.x*w,y:l.y*h}));
      const conns=(typeof POSE_CONNECTIONS!=='undefined')?POSE_CONNECTIONS:(Pose && Pose.POSE_CONNECTIONS? Pose.POSE_CONNECTIONS:null);
      if(currentVideo){
        const ang=extractAngles(lm); const spt=currentVideo.sportTag||sportSel.value;
        const vUse=(viewSel.value==='auto')?detectView2D(lm):viewSel.value; const chk=checkAgainstStandard(ang,spt,vUse);
        overlayPass=chk.pass?'pass':'fail'; liveBadge.style.display='block'; liveBadge.textContent=(vUse?`[${vUse}] `:'')+(chk.pass?'‚úÖ ƒê·∫°t':'‚ö†Ô∏è L·ªói');
      }else liveBadge.style.display='none';
      if(conns){ ctx.strokeStyle=overlayPass==='pass'?'#1fb980':'#ff6b6b'; ctx.lineWidth=2.4; conns.forEach(c=>{const a=lm[c[0]],b=lm[c[1]]; if(a&&b){ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();}}) }
      lm.forEach(p=>{ctx.fillStyle=overlayPass==='pass'?'#00b3a4':'#ff6b6b'; ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill()});
    }
  };
  mpPose.onResults(mpPoseDrawingCallback);
  let raf=null,last=0; const minInt=45;
  async function loop(){ if(player.paused||player.ended){ if(raf) cancelAnimationFrame(raf); return } const now=performance.now(); if(now-last>minInt){try{await mpPose.send({image:player})}catch(e){} last=now} raf=requestAnimationFrame(loop) }
  player.onplay=()=>loop(); player.onended=()=>{if(raf) cancelAnimationFrame(raf); liveBadge.style.display='none'};
  showAnalysisPanel(results[v.id]);
}
async function runAnalysisIfNeeded(v,force=false){
  analysisPanel.innerHTML='<div class="small">ƒêang ph√¢n t√≠ch‚Ä¶</div>'; setProgress(0,'0%');
  const res=await analyzeVideoUsingMediaPipe(v, v.sportTag||sportSel.value, force);
  if(res){ showAnalysisPanel(res); renderChart(); renderDashboard(res); showModal('Ph√¢n t√≠ch ho√†n t·∫•t v√† ƒë√£ l∆∞u.'); }
  else { analysisPanel.innerHTML='<div class="small">Ph√¢n t√≠ch th·∫•t b·∫°i.</div>' }
}
function deleteVideo(id){
  showModal('X√≥a video v√† k·∫øt qu·∫£ li√™n quan?',true, async ()=>{
    const vd=uploadedVideos.find(v=>v.id===id); if(vd?.url) URL.revokeObjectURL(vd.url);
    await deleteVideoFromDB(id); uploadedVideos=uploadedVideos.filter(v=>v.id!==id);
    if(results[id]){delete results[id]; saveResults()} renderVideoList(); if(currentVideo?.id===id){player.src=''; currentVideo=null; analysisPanel.innerHTML='Ch∆∞a c√≥ video.'}
  })
}
exportBtn.onclick=()=>{
  if(!currentVideo || !results[currentVideo.id]) return showModal('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ xu·∫•t.');
  const data=results[currentVideo.id], blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${data.name.replace(/\.[^/.]+$/,'')}_report.json`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),800);
}

/* ======= Events ======= */
videoUpload.addEventListener('change', async (e)=>{
  for(const f of Array.from(e.target.files)){
    const id='v_'+(Date.now()+Math.random()).toString(36).slice(2); const url=URL.createObjectURL(f);
    let tag=''; const ln=f.name.toLowerCase(); if(ln.includes('xuat')) tag='xuatphat'; else if(ln.includes('nhay')) tag='nhaycao'; else if(ln.includes('nem')) tag='nemta'; if(!tag) tag=sportSel.value;
    const v={id,name:f.name,url,sportTag:tag,file:f}; uploadedVideos.push(v);
    try{ await saveVideoToDB({id:id,name:f.name,sportTag:tag,file:f}) }catch{ showModal('Kh√¥ng l∆∞u ƒë∆∞·ª£c video v√†o DB (ch·∫ø ƒë·ªô demo v·∫´n d√πng ƒë∆∞·ª£c).') }
  }
  renderVideoList(); if(uploadedVideos.length && !currentVideo) openVideo(uploadedVideos.at(-1));
});
sportSel.addEventListener('change',()=>{renderVideoList(); renderChart()});
analyzeBtn.onclick=()=>{ if(!currentVideo) return showModal('Ch∆∞a ch·ªçn video.'); runAnalysisIfNeeded(currentVideo,false) }
forceAnalyzeBtn.onclick=()=>{ if(!currentVideo) return showModal('Ch∆∞a ch·ªçn video.'); runAnalysisIfNeeded(currentVideo,true) }
clearStorageBtn.onclick=()=>showModal('X√≥a to√†n b·ªô d·ªØ li·ªáu (k·∫øt qu·∫£ + video)?',true, async ()=>{
  localStorage.removeItem('thethaott_results'); results={};
  try{ await clearVideosFromDB(); uploadedVideos.forEach(v=>URL.revokeObjectURL(v.url)); uploadedVideos=[] }catch{}
  renderVideoList(); renderChart(); analysisPanel.innerHTML='Ch∆∞a c√≥ video.'; player.src=''; currentVideo=null;
  showModal('ƒê√£ x√≥a d·ªØ li·ªáu.');
});
toggleDashboardBtn.onclick=()=>{ dashCard.style.display=(dashCard.style.display==='none'?'block':'none'); if(dashCard.style.display==='block' && currentVideo && results[currentVideo.id]) renderDashboard(results[currentVideo.id]) }

document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    await initDB(); const stored=await getVideosFromDB();
    uploadedVideos=stored.map(v=>({...v,url:URL.createObjectURL(v.file)}));
  }catch(e){console.warn('IndexedDB not ready',e)}
  ensureMpPose(); renderVideoList(); renderChart();
});
window.addEventListener('beforeunload',()=>uploadedVideos.forEach(v=>{try{URL.revokeObjectURL(v.url)}catch{}}));

/* ======= AI (optional) ======= */
async function tryLoadAIModel(){
  try{ aiStatusPill.textContent='AI: ƒëang t·∫£i‚Ä¶'; aiModel=await tf.loadLayersModel('model/model.json'); aiAvailable=true; aiStatusPill.textContent='AI: s·∫µn s√†ng' }
  catch{ aiModel=null; aiAvailable=false; aiStatusPill.textContent='AI: ch∆∞a c√≥ model' }
}
tryLoadAIModel();

document.getElementById('runModelBtn').onclick=()=>{
  if(!currentVideo) return showModal('Ch∆∞a c√≥ video.');
  const summary=results[currentVideo.id]?.features || summarizeFeatures();
  const keys=['kneeL','kneeR','hipL','hipR','elbowL','elbowR','shoulderL','shoulderR','torsoIncline'];
  const flat=(obj)=>keys.map(k=> (typeof obj[k]==='number')?obj[k]:0 );
  const romRanges=keys.map(k=> summary.rom[k]?.range ?? 0);
  const vec=[...flat(summary.mean),...flat(summary.std),...romRanges,...flat(summary.vmean),...flat(summary.vstd)];
  if(aiAvailable && aiModel){
    try{
      const t=tf.tensor2d([vec]); const out=aiModel.predict(t); const y=(Array.isArray(out)? out[0]:out).dataSync(); const labels=['Sai k·ªπ thu·∫≠t','T∆∞ th·∫ø r·ªßi ro','B·∫•t th∆∞·ªùng ƒë·ªông t√°c'];
      aiAlertsEl.innerHTML='<ul>'+Array.from(y).map((s,i)=>`<li>${labels[i]||('nh√£n '+i)}: ${(s*100).toFixed(1)}%</li>`).join('')+'</ul>'; t.dispose(); if(!Array.isArray(out)) out.dispose?.();
    }catch{ aiAlertsEl.innerHTML='<span class="small">Model l·ªói. D√πng heuristic.</span>'; heuristic() }
  }else{ heuristic() }
  function heuristic(){
    const a=[]; const rom=summary.rom||{}, vmean=summary.vmean||{};
    const kneeROM=Math.max(rom.kneeL?.range||0, rom.kneeR?.range||0), hipROM=Math.max(rom.hipL?.range||0,rom.hipR?.range||0), torsoROM=rom.torsoIncline?.range||0, kneeV=Math.max(Math.abs(vmean.kneeL||0),Math.abs(vmean.kneeR||0));
    const sport=sportSel.value;
    if(sport==='nhaycao'){ if(kneeROM<35) a.push('ROM g·ªëi th·∫•p (<35¬∞)'); if(hipROM<30) a.push('ROM h√¥ng th·∫•p'); if(torsoROM>50) a.push('Bi·∫øn thi√™n th√¢n l·ªõn'); }
    if(sport==='xuatphat'){ if(kneeV<20) a.push('V·∫≠n t·ªëc g·ªëi th·∫•p ‚Äî ph·∫£n x·∫° ch∆∞a nhanh'); }
    if(sport==='nemta'){ if(hipROM<25) a.push('ROM h√¥ng th·∫•p'); if(Math.abs(vmean.shoulderR||0)<10 && Math.abs(vmean.shoulderL||0)<10) a.push('Vai vung ch·∫≠m'); }
    if(!a.length) a.push('Kh√¥ng ph√°t hi·ªán c·∫£nh b√°o r√µ r√†ng.');
    aiAlertsEl.innerHTML='<ul>'+a.map(x=>`<li>${x}</li>`).join('')+'</ul>';
  }
};
</script>
</body>
</html>
