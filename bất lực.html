<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H·ªó tr·ª£ Hu·∫•n luy·ªán Th·ªÉ thao - Ph√¢n t√≠ch T∆∞ th·∫ø</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* B·∫£ng m√†u t∆∞∆°i + chuy·ªÉn s·∫Øc */
      --bg1:#0f172a;         /* slate-900 */
      --bg2:#111827;         /* gray-900  */
      --grad1:#0ea5e9;       /* sky-500   */
      --grad2:#22c55e;       /* green-500 */
      --grad3:#a855f7;       /* purple-500*/
      --card:rgba(255,255,255,.08);
      --glass:rgba(255,255,255,.12);
      --bd:rgba(255,255,255,.12);
      --txt:#e5e7eb;
      --muted:#94a3b8;
      --pri:#22d3ee;         /* cyan-400  */
      --pri2:#0ea5e9;        /* sky-500   */
      --accent:#f59e0b;      /* amber-500 */
      --ok:#22c55e;
      --warn:#f97316;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r-lg:16px;
      --r-xl:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family:Inter,system-ui,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(14,165,233,.25), transparent 60%),
        radial-gradient(900px 500px at 110% -20%, rgba(168,85,247,.20), transparent 55%),
        radial-gradient(700px 400px at 50% 120%, rgba(34,197,94,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
    }

    .wrap{max-width:1200px;margin:auto;padding:28px}
    .page-head{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px
    }
    .title{
      font-family:Poppins,Inter,sans-serif;
      font-weight:700; font-size:22px;
      letter-spacing:.2px;
      background: linear-gradient(90deg, var(--pri) 0%, var(--grad3) 50%, var(--accent) 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .subtitle{color:var(--muted);font-size:13px}

    .card{
      background:linear-gradient(180deg, var(--glass), rgba(255,255,255,.06));
      border:1px solid var(--bd);
      border-radius:var(--r-xl);
      box-shadow:var(--shadow);
      backdrop-filter:saturate(140%) blur(10px);
      padding:18px;
    }
    h3{
      margin:0 0 12px;
      font-size:16px;font-weight:700;letter-spacing:.2px;
      color:#fff;
      display:flex;align-items:center;gap:8px
    }
    h3:before{
      content:'';
      display:inline-block;width:8px;height:8px;border-radius:50%;
      background:radial-gradient(circle at 35% 35%, #fff, var(--pri2) 60%, transparent 70%);
      box-shadow:0 0 18px var(--pri2);
    }
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1}

    /* Toolbar */
    .toolbar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .toolbar .slot{background:rgba(255,255,255,.03);border:1px dashed var(--bd);padding:10px;border-radius:14px}
    label.small{display:block;margin-bottom:6px}
    input[type=file],select,input[type=number]{
      width:100%;
      padding:10px 12px;border:1px solid var(--bd);border-radius:12px;background:rgba(255,255,255,.06);
      color:var(--txt);outline:none;
    }
    select:focus,input:focus{box-shadow:0 0 0 3px rgba(14,165,233,.2)}

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;
      border-radius:14px;border:1px solid var(--bd);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      color:var(--txt);cursor:pointer;user-select:none;
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    .btn:hover{box-shadow:0 10px 22px rgba(0,0,0,.3);}
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      border-color:transparent;
      background:linear-gradient(90deg, var(--pri) 0%, var(--pri2) 100%);
      color:#00131a;
      font-weight:700;
      text-shadow:0 1px 0 rgba(255,255,255,.25);
    }
    .btn-danger{background:linear-gradient(90deg, #fb7185 0%, #ef4444 100%); border-color:transparent; color:#2b0a0a;font-weight:700}
    .btn-ghost{background:rgba(255,255,255,.05)}
    a.btn{text-decoration:none}

    /* Player */
    .player{
      position:relative;border-radius:18px;overflow:hidden;
      border:1px solid var(--bd);
      background:
        radial-gradient(400px 220px at 80% -10%, rgba(14,165,233,.15), transparent 60%),
        radial-gradient(300px 180px at -10% 90%, rgba(34,197,94,.15), transparent 60%),
        #000;
      min-height:280px;
    }
    .player video,.player canvas{width:100%;height:100%;display:block}
    .badge{
      position:absolute;left:12px;top:12px;padding:6px 12px;border-radius:999px;font-size:12px;
      background:linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.2); color:#fff;
      box-shadow:0 0 0 2px rgba(255,255,255,.06);
      animation:glow 2s ease-in-out infinite;
    }
    @keyframes glow{
      0%,100%{box-shadow:0 0 0 2px rgba(255,255,255,.06), 0 0 10px rgba(34,211,238,.0)}
      50%{box-shadow:0 0 0 2px rgba(255,255,255,.06), 0 0 18px rgba(34,211,238,.35)}
    }

    /* Progress */
    .progress{display:flex;gap:10px;align-items:center;margin-top:12px}
    .bar{flex:1;height:12px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.08);border:1px solid var(--bd)}
    .bar>span{
      display:block;height:100%;width:0%;
      background:linear-gradient(90deg, var(--ok), #10b981, #34d399);
      transition:width .35s ease-in-out
    }

    /* Pills */
    .pill{
      display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid var(--bd);
      background:rgba(255,255,255,.06); font-size:12px; color:var(--txt)
    }

    /* Editor */
    .editor{
      max-height:260px;overflow:auto;border:1px solid var(--bd);
      border-radius:14px;background:rgba(255,255,255,.04);padding:10px
    }
    .video-item{
      display:flex;justify-content:space-between;align-items:center;
      border:1px solid var(--bd);border-radius:14px;padding:10px;margin-bottom:8px;
      background:rgba(255,255,255,.05);
      transition:transform .08s ease, background .2s ease
    }
    .video-item:hover{background:rgba(255,255,255,.07); transform:translateY(-1px)}
    .video-item .btn{padding:8px 12px}

    /* Layout */
    .grid{display:grid;gap:18px}
    .layout{grid-template-columns:1.15fr .85fr}
    @media (max-width: 992px){.layout{grid-template-columns:1fr}.toolbar{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="page-head">
    <div>
      <div id="pageTitle" class="title">B·∫£ng ƒëi·ªÅu khi·ªÉn Ph√¢n t√≠ch T∆∞ th·∫ø</div>
      <div class="subtitle">Ch·ªçn m√¥n, t·∫£i video v√† b·∫Øt ƒë·∫ßu ph√¢n t√≠ch.</div>
    </div>
    <a href="bangdieukhien.html" class="btn btn-ghost">‚Üê Quay l·∫°i</a>
  </div>

  <!-- Chu·∫©n b·ªã d·ªØ li·ªáu -->
  <div class="card">
    <h3>Chu·∫©n b·ªã d·ªØ li·ªáu</h3>
    <div class="toolbar">
      <div class="slot">
        <label class="small">M√¥n th·ªÉ thao</label>
        <select id="sport">
          <option value="xuatphat">Xu·∫•t ph√°t</option>
          <option value="nhaycao">Nh·∫£y cao</option>
          <option value="nemta">N√©m t·∫°</option>
        </select>
      </div>
      <div class="slot">
        <label class="small">G√≥c quay</label>
        <select id="viewSel">
          <option value="auto">T·ª± ƒë·ªông</option>
          <option value="front">Tr∆∞·ªõc/Sau</option>
          <option value="left">B√™n tr√°i</option>
          <option value="right">B√™n ph·∫£i</option>
          <option value="back">ƒê·∫±ng sau</option>
        </select>
      </div>
      <div class="slot">
        <label class="small">T·∫£i video (.mp4)</label>
        <input id="videoUpload" type="file" accept="video/*" multiple />
      </div>
      <div class="slot" style="display:flex;align-items:flex-end">
        <button id="clearStorage" class="btn btn-danger" title="X√≥a to√†n b·ªô video & k·∫øt qu·∫£">üóë X√≥a d·ªØ li·ªáu</button>
      </div>
    </div>
  </div>

  <!-- Layout ch√≠nh -->
  <div class="grid layout">
    <!-- C·ªôt tr√°i -->
    <div class="grid">
      <div class="card">
        <h3>L·ªãch s·ª≠ video</h3>
        <div id="videoList" class="small muted">Ch∆∞a c√≥ video n√†o.</div>
      </div>

      <div class="card">
        <h3>Tr√¨nh ph√°t & Ph√¢n t√≠ch</h3>
        <div class="player" id="playerWrap">
          <video id="player" controls playsinline crossorigin="anonymous" muted></video>
          <canvas id="overlay"></canvas>
          <div id="liveBadge" class="badge" style="display:none">ƒêang ki·ªÉm tra‚Ä¶</div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="analyzeBtn" class="btn btn-primary">Ph√¢n t√≠ch</button>
          <button id="forceAnalyzeBtn" class="btn">Ph√¢n t√≠ch l·∫°i</button>
          <button id="exportReportBtn" class="btn">Xu·∫•t b√°o c√°o</button>
          <button id="toggleDashboardBtn" class="btn">Dashboard</button>
        </div>
        <div class="progress" id="progressRow" style="display:none">
          <div class="bar"><span id="progressBar"></span></div>
          <div class="small" id="progressText">0%</div>
        </div>
      </div>
    </div>

    <!-- C·ªôt ph·∫£i -->
    <div class="grid">
      <div class="card">
        <h3>Th√¥ng tin ph√¢n t√≠ch</h3>
        <div id="analysisPanel" class="small">Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.</div>
        <hr style="border-color:var(--bd);opacity:.5">
        <div class="row">
          <div>
            <label class="small">Ng∆∞·ª°ng pass theo m√¥n (%)</label>
            <input type="range" id="sportThresh" min="40" max="90" step="1">
            <div class="small"><span id="threshLabel" class="pill"></span></div>
          </div>
          <div>
            <label class="small">T√πy ch·ªçn</label><br/>
            <button id="resetStandards" class="btn">Kh√¥i ph·ª•c khung chu·∫©n m·∫∑c ƒë·ªãnh</button>
          </div>
        </div>
        <hr style="border-color:var(--bd);opacity:.5">
        <h4 class="small" style="margin:0 0 8px;color:#d1d5db">Th·ªëng k√™ t·ªâ l·ªá ƒë√∫ng</h4>
        <div style="height:220px"><canvas id="chartCanvas"></canvas></div>
      </div>

      <div class="card" id="dashboardCard" style="display:none">
        <h3>Dashboard n√¢ng cao</h3>
        <div class="small muted" style="margin-bottom:10px">
          G√≥c kh·ªõp, v·∫≠n t·ªëc (¬∞/s), ROM; h·ªó tr·ª£ m√¥ h√¨nh AI (n·∫øu c√≥).
          <span class="pill" id="aiStatusPill">AI: ch∆∞a t·∫£i</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr;gap:12px">
          <div style="height:220px"><canvas id="angleChart"></canvas></div>
          <div style="height:220px"><canvas id="velChart"></canvas></div>
          <div style="height:220px"><canvas id="romChart"></canvas></div>
          <div>
            <div id="aiAlerts" class="small muted">·∫§n "Ch·∫°y m√¥ h√¨nh AI" ƒë·ªÉ d·ª± ƒëo√°n.</div>
            <div class="row" style="margin-top:10px">
              <button id="runModelBtn" class="btn btn-primary">Ch·∫°y m√¥ h√¨nh AI</button>
              <button id="exportFeaturesBtn" class="btn">Xu·∫•t Features (.json)</button>
              <button id="exportFeaturesCsvBtn" class="btn">Xu·∫•t Features (.csv)</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Khung chu·∫©n (ch·ªânh & l∆∞u c·ª•c b·ªô)</h3>
        <div class="small muted">S·ª≠a <b>want</b>, <b>tol</b>, <b>weight</b> r·ªìi ‚ÄúL∆∞u khung chu·∫©n‚Äù.</div>
        <div id="stdEditor" class="editor small"></div>
        <div class="row" style="margin-top:8px">
          <button id="saveStdBtn" class="btn btn-primary">L∆∞u khung chu·∫©n</button>
          <button id="recalcBtn" class="btn">T√≠nh l·∫°i theo khung m·ªõi</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h3>Ghi ch√∫</h3>
    <div class="small">
      Pass/fail t·ª´ng khung h√¨nh d·ª±a tr√™n khung chu·∫©n theo m√¥n & g√≥c quay, c√≥ <b>tr·ªçng s·ªë</b> v√† <b>ng∆∞·ª°ng</b>.  
      Video/khung chu·∫©n l∆∞u c·ª•c b·ªô (IndexedDB/LocalStorage). C√≥ th·ªÉ l∆∞u th√†nh t√≠ch & c·∫£nh b√°o l√™n Firestore (khi c√≥ <code>?athleteId=...</code>).
    </div>
  </div>
</div>

<!-- Modal -->
<div id="customModal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,.55);backdrop-filter:blur(4px);z-index:999;align-items:center;justify-content:center">
  <div style="background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));border:1px solid var(--bd);box-shadow:var(--shadow);border-radius:18px;padding:18px;max-width:480px">
    <div id="modalText" style="margin-bottom:12px"></div>
    <div id="modalActions" class="row" style="justify-content:flex-end"></div>
  </div>
</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>

<!-- Firebase SDK + To√†n b·ªô logic (gi·ªØ nguy√™n ch·ª©c nƒÉng, ch·ªâ ch·ªânh UI) -->
<script type="module">
  /* === Firebase init (gi·ªØ nh∆∞ tr∆∞·ªõc) === */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2dXWCyjL2xgCSyeW9QQ7RvjI_O7kFHJw",
    authDomain: "sporthealthdata.firebaseapp.com",
    projectId: "sporthealthdata",
    storageBucket: "sporthealthdata.appspot.com",
    messagingSenderId: "789054240877",
    appId: "1:789054240877:web:04a400c9ea586523a86764",
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  async function saveAchievementToFirestore(resultData, athleteId) {
    try {
      const col = collection(db, "users", athleteId, "achievements");
      await addDoc(col, {
        date: serverTimestamp(),
        eventName: `Ph√¢n t√≠ch t∆∞ th·∫ø: ${resultData.name}`,
        result: `T·ªâ l·ªá ƒë√∫ng: ${resultData.tile}%`,
        notes: `X·∫øp lo·∫°i: ${resultData.xeploai}. ${resultData.ketluan}`,
      });
    } catch (e) { console.error("L·ªói l∆∞u achievements:", e); }
  }
  async function saveInjuryWarningsToFirestore(resultData, athleteId) {
    if (!Array.isArray(resultData.chanthuong) || !resultData.chanthuong.length) return;
    try {
      const col = collection(db, "users", athleteId, "warnings");
      await Promise.all(resultData.chanthuong.map(i =>
        addDoc(col, {
          date: serverTimestamp(),
          title: `Nguy c∆° ch·∫•n th∆∞∆°ng: ${i}`,
          description: `Ph√°t hi·ªán nguy c∆° v√πng ${i} trong video "${resultData.name}".`,
          severity: "medium",
        })
      ));
    } catch (e) { console.error("L·ªói l∆∞u warnings:", e); }
  }

  /* === App elements === */
  const sportSel = document.getElementById('sport');
  const viewSel  = document.getElementById('viewSel');
  const videoUpload = document.getElementById('videoUpload');
  const videoListEl = document.getElementById('videoList');
  const player = document.getElementById('player');
  const overlay = document.getElementById('overlay');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const forceAnalyzeBtn = document.getElementById('forceAnalyzeBtn');
  const analysisPanel = document.getElementById('analysisPanel');
  const chartCanvas = document.getElementById('chartCanvas');
  const clearStorageBtn = document.getElementById('clearStorage');
  const progressRow = document.getElementById('progressRow');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const liveBadge = document.getElementById('liveBadge');
  const exportBtn = document.getElementById('exportReportBtn');
  const dashCard = document.getElementById('dashboardCard');
  const toggleDashboardBtn = document.getElementById('toggleDashboardBtn');
  const angleChartEl = document.getElementById('angleChart');
  const velChartEl = document.getElementById('velChart');
  const romChartEl = document.getElementById('romChart');
  const aiAlertsEl = document.getElementById('aiAlerts');
  const aiStatusPill = document.getElementById('aiStatusPill');
  const exportFeaturesBtn = document.getElementById('exportFeaturesBtn');
  const exportFeaturesCsvBtn = document.getElementById('exportFeaturesCsvBtn');
  const runModelBtn = document.getElementById('runModelBtn');
  const stdEditor = document.getElementById('stdEditor');
  const saveStdBtn = document.getElementById('saveStdBtn');
  const recalcBtn = document.getElementById('recalcBtn');
  const sportThresh = document.getElementById('sportThresh');
  const threshLabel = document.getElementById('threshLabel');

  /* === IndexedDB === */
  const DB_NAME='thethaott_videos_db', DB_VERSION=1, STORE_NAME='videos';
  let idb;
  function initDB(){
    return new Promise((res,rej)=>{
      const req=indexedDB.open(DB_NAME,DB_VERSION);
      req.onupgradeneeded=e=>{
        const db=e.target.result;
        if(!db.objectStoreNames.contains(STORE_NAME)){
          db.createObjectStore(STORE_NAME,{keyPath:'id'});
        }
      };
      req.onsuccess=e=>{idb=e.target.result;res(idb);}
      req.onerror=e=>rej(e);
    });
  }
  const saveVideoToDB = v => new Promise((res,rej)=>{
    const tx=idb.transaction([STORE_NAME],'readwrite');
    tx.objectStore(STORE_NAME).put(v).onsuccess=()=>res();
    tx.onerror=e=>rej(e);
  });
  const getVideosFromDB = () => new Promise((res,rej)=>{
    const tx=idb.transaction([STORE_NAME],'readonly');
    tx.objectStore(STORE_NAME).getAll().onsuccess=e=>res(e.target.result||[]);
    tx.onerror=e=>rej(e);
  });
  const deleteVideoFromDB = id => new Promise((res,rej)=>{
    const tx=idb.transaction([STORE_NAME],'readwrite');
    tx.objectStore(STORE_NAME).delete(id);
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e);
  });
  const clearVideosFromDB = () => new Promise((res,rej)=>{
    const tx=idb.transaction([STORE_NAME],'readwrite');
    tx.objectStore(STORE_NAME).clear();
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e);
  });

  /* === Modal === */
  function showModal(html, confirm=false, onOk=null){
    const m=document.getElementById('customModal');
    const t=document.getElementById('modalText');
    const a=document.getElementById('modalActions');
    t.innerHTML=html;
    a.innerHTML='';
    const closeBtn=document.createElement('button');
    closeBtn.className='btn btn-primary'; closeBtn.textContent=confirm?'H·ªßy':'ƒê√≥ng';
    closeBtn.onclick=()=>m.style.display='none';
    a.appendChild(closeBtn);
    if(confirm){
      const ok=document.createElement('button');
      ok.className='btn'; ok.textContent='X√°c nh·∫≠n';
      ok.onclick=()=>{m.style.display='none'; onOk&&onOk();};
      a.appendChild(ok);
    }
    m.style.display='flex';
  }

  /* === Khung chu·∫©n + Ng∆∞·ª°ng === */
  const DEFAULT_THRESH = {xuatphat:60, nhaycao:55, nemta:60}; // %
  const loadThresh = ()=> ({...DEFAULT_THRESH, ...(JSON.parse(localStorage.getItem('std_thresh')||'{}'))});
  const saveThresh = v => localStorage.setItem('std_thresh', JSON.stringify(v));
  let THRESH = loadThresh();

  const DEFAULT_STD = {
    xuatphat:[
      {name:'G·ªëi (L/R)', joints:['kneeL','kneeR'], want:100, tol:20, anySide:true, weight:1.2},
      {name:'H√¥ng (L/R)', joints:['hipL','hipR'],   want:120, tol:25, anySide:true, weight:1.0},
      {name:'Th√¢n nghi√™ng',joints:['torsoIncline'], want:45,  tol:15, anySide:false, weight:0.8},
      {name:'Khu·ª∑u (L/R)', joints:['elbowL','elbowR'], want:90, tol:25, anySide:true, weight:0.6},
    ],
    nhaycao:[
      {name:'G·ªëi gi·∫≠m (L/R)', joints:['kneeL','kneeR'], want:150, tol:20, anySide:true, weight:1.2},
      {name:'H√¥ng m·ªü (L/R)',  joints:['hipL','hipR'],   want:160, tol:20, anySide:true, weight:1.0},
      {name:'Th√¢n nghi√™ng',  joints:['torsoIncline'],  want:20,  tol:15, anySide:false, weight:0.8},
      {name:'Vai (L/R)',     joints:['shoulderL','shoulderR'], want:160, tol:25, anySide:true, weight:0.7},
    ],
    nemta:[
      {name:'G·ªëi (L/R)',     joints:['kneeL','kneeR'], want:100, tol:25, anySide:true, weight:1.0},
      {name:'H√¥ng (L/R)',    joints:['hipL','hipR'],   want:120, tol:25, anySide:true, weight:1.0},
      {name:'Khu·ª∑u (L/R)',   joints:['elbowL','elbowR'], want:100, tol:25, anySide:true, weight:0.8},
      {name:'Vai (L/R)',     joints:['shoulderL','shoulderR'], want:90, tol:25, anySide:true, weight:0.7},
      {name:'Th√¢n nghi√™ng',  joints:['torsoIncline'],  want:30,  tol:15, anySide:false, weight:0.7},
    ],
  };
  const VIEW_OVERRIDES = {
    xuatphat:{ left:[{name:'Th√¢n nghi√™ng',joints:['torsoIncline'], want:45, tol:18, anySide:false, weight:0.9}], right:[{name:'Th√¢n nghi√™ng',joints:['torsoIncline'], want:45, tol:18, anySide:false, weight:0.9}] },
    nhaycao:{ left:[{name:'Th√¢n nghi√™ng',joints:['torsoIncline'], want:20, tol:18, anySide:false, weight:0.9}], right:[{name:'Th√¢n nghi√™ng',joints:['torsoIncline'], want:20, tol:18, anySide:false, weight:0.9}] },
    nemta:  { left:[{name:'Th√¢n nghi√™ng',joints:['torsoIncline'], want:30, tol:18, anySide:false, weight:0.9}], right:[{name:'Th√¢n nghi√™ng',joints:['torsoIncline'], want:30, tol:18, anySide:false, weight:0.9}] },
  };
  const loadStd = ()=> {
    const saved=JSON.parse(localStorage.getItem('std_rules')||'{}');
    const merged=JSON.parse(JSON.stringify(DEFAULT_STD));
    for(const k in saved){ merged[k]=saved[k]; }
    return merged;
  }
  const saveStd = v => localStorage.setItem('std_rules', JSON.stringify(v));
  let STD = loadStd();
  const rulesFor = (sport, view) => {
    const base = STD[sport] ? JSON.parse(JSON.stringify(STD[sport])) : [];
    const ov = VIEW_OVERRIDES[sport]?.[view] || [];
    return [...base, ...ov];
  };

  /* === MediaPipe & t√≠nh g√≥c === */
  let uploadedVideos=[], results=JSON.parse(localStorage.getItem('thethaott_results')||'{}');
  let currentVideo=null, mpPose=null, mpPoseDrawingCallback=null, lastPoseLandmarks=null, chart=null;
  let featTime=[], featAngles=[], featVel=[], featROM={}, aiModel=null, aiAvailable=false;
  let viewCounts={front:0,left:0,right:0,back:0};

  const saveResults = ()=>{ localStorage.setItem('thethaott_results', JSON.stringify(results)); renderChart(); }
  const uidFromName = name => { let h=2166136261; for(let i=0;i<name.length;i++){h ^= name.charCodeAt(i);h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);} return 'v_'+(h>>>0); }
  function setProgress(pct, text){ progressRow.style.display='flex'; progressBar.style.width=Math.max(0,Math.min(100,pct))+'%'; progressText.textContent=text||`${Math.round(pct)}%`; if(pct>=100){ setTimeout(()=>progressRow.style.display='none', 400); } }
  function ensureMpPose(){
    if(!mpPose){
      mpPose = new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
      mpPose.setOptions({modelComplexity:1,smoothLandmarks:true,enableSegmentation:false,minDetectionConfidence:0.45,minTrackingConfidence:0.45});
      mpPose.onResults(r=>{ if(r?.poseLandmarks?.length) lastPoseLandmarks=r.poseLandmarks; });
    }
    return mpPose;
  }
  async function tryLoadAIModel(){
    try{ aiStatusPill.textContent='AI: ƒëang t·∫£i...'; aiModel = await tf.loadLayersModel('model/model.json'); aiAvailable=true; aiStatusPill.textContent='AI: s·∫µn s√†ng'; }
    catch{ aiAvailable=false; aiModel=null; aiStatusPill.textContent='AI: ch∆∞a c√≥ model'; }
  }

  const PER_FRAME_BASE = ()=>({xuatphat:(THRESH.xuatphat/100), nhaycao:(THRESH.nhaycao/100), nemta:(THRESH.nemta/100)});
  const degBetween=(a,b,c)=>{const abx=a.x-b.x,aby=a.y-b.y,cbx=c.x-b.x,cby=c.y-b.y;const dot=abx*cbx+aby*cby;const mag=Math.sqrt((abx*abx+aby*aby)*(cbx*cbx+cby*cby));if(!mag)return 0;let cos=dot/mag;cos=Math.max(-1,Math.min(1,cos));return Math.acos(cos)*180/Math.PI;}
  const torsoInclineDeg=lm=>{const lS=lm[11],rS=lm[12],lH=lm[23],rH=lm[24];if(!(lS&&rS&&lH&&rH))return 0;const s={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2},h={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};return Math.atan2(Math.abs(s.y-h.y),Math.abs(s.x-h.x))*180/Math.PI}
  const extractAngles=lm=>{const ang={}; if(lm[23]&&lm[25]&&lm[27]) ang.kneeL=degBetween(lm[23],lm[25],lm[27]); if(lm[24]&&lm[26]&&lm[28]) ang.kneeR=degBetween(lm[24],lm[26],lm[28]); if(lm[11]&&lm[23]&&lm[25]) ang.hipL=degBetween(lm[11],lm[23],lm[25]); if(lm[12]&&lm[24]&&lm[26]) ang.hipR=degBetween(lm[12],lm[24],lm[26]); if(lm[11]&&lm[13]&&lm[15]) ang.elbowL=degBetween(lm[11],lm[13],lm[15]); if(lm[12]&&lm[14]&&lm[16]) ang.elbowR=degBetween(lm[12],lm[14],lm[16]); if(lm[13]&&lm[11]&&lm[23]) ang.shoulderL=degBetween(lm[13],lm[11],lm[23]); if(lm[14]&&lm[12]&&lm[24]) ang.shoulderR=degBetween(lm[14],lm[12],lm[24]); ang.torsoIncline=torsoInclineDeg(lm); return ang;}
  const detectView2D=lm=>{const lS=lm[11],rS=lm[12]; if(!(lS&&rS)) return 'front'; return (Math.abs(rS.x-lS.x) < 0.55*Math.abs(((lm[11].x+lm[12].x)/2)-((lm[23].x+lm[24].x)/2))) ? (rS.x>lS.x?'right':'left') : 'front';}
  const angleVelocity=(prev,curr,dt)=>{const out={},keys=new Set([...Object.keys(prev||{}),...Object.keys(curr||{})]);keys.forEach(k=>{const a=(curr&&typeof curr[k]==='number')?curr[k]:null;const b=(prev&&typeof prev[k]==='number')?prev[k]:null;out[k]=(a!=null&&b!=null&&dt>0)?(a-b)/dt:0;});return out;}
  const computeROM=series=>{const keys=new Set();series.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));const rom={};keys.forEach(k=>{let min=+Infinity,max=-Infinity;series.forEach(a=>{const v=a[k];if(typeof v==='number'){if(v<min)min=v;if(v>max)max=v;}});if(min<+Infinity&&max>-Infinity)rom[k]={min,max,range:max-min};});return rom;}
  function summarizeFeatures(){const keys=new Set();featAngles.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));const sum={},sumSq={};keys.forEach(k=>{sum[k]=0;sumSq[k]=0;});const n=featAngles.length;featAngles.forEach(a=>{keys.forEach(k=>{const v=typeof a[k]==='number'?a[k]:0;sum[k]+=v;sumSq[k]+=v*v;});});const mean={},std={};keys.forEach(k=>{mean[k]=n?(sum[k]/n):0;std[k]=n?Math.sqrt(Math.max(0,sumSq[k]/n-mean[k]*mean[k])):0;});const rom=computeROM(featAngles);const vkeys=new Set();featVel.forEach(a=>Object.keys(a).forEach(k=>vkeys.add(k)));const vsum={},vsumSq={};vkeys.forEach(k=>{vsum[k]=0;vsumSq[k]=0;});const vn=featVel.length;featVel.forEach(a=>{vkeys.forEach(k=>{const v=typeof a[k]==='number'?a[k]:0;vsum[k]+=v;vsumSq[k]+=v*v;});});const vmean={},vstd={};vkeys.forEach(k=>{vmean[k]=vn?(vsum[k]/vn):0;vstd[k]=vn?Math.sqrt(Math.max(0,vsumSq[k]/vn - vmean[k]*vmean[k])):0;});return {mean,std,rom,vmean,vstd,nFrames:n,duration: featTime.length? featTime.at(-1)-featTime[0]:0};}

  function weightedCheck(angles, sport, view){
    const rules = rulesFor(sport, view);
    let okW=0, totalW=0;
    for(const r of rules){
      const w = Number(r.weight||1); totalW += w;
      let within=false;
      if(r.anySide){ for(const k of r.joints){ const v=angles[k]; if(typeof v==='number' && Math.abs(v-r.want)<=r.tol){within=true;break;} } }
      else{ const v=angles[r.joints[0]]; if(typeof v==='number' && Math.abs(v-r.want)<=r.tol) within=true; }
      if(within) okW += w;
    }
    const score = totalW>0? okW/totalW : 0;
    const pass = score >= (PER_FRAME_BASE()[sport]||0.6);
    return {pass, score, rules};
  }

  function deterministicClassification(tile, sport){
    const packs = {
      xuatphat:{loi:["G·∫≠p g·ªëi ch∆∞a ƒë√∫ng g√≥c","Tay ch·ªëng ch∆∞a v·ªØng","Th√¢n ng∆∞·ªùi h∆°i nghi√™ng"], chan:["C·ªï tay","G·ªëi","Vai"], goiy:["Gi·ªØ th√¢n ng∆∞·ªùi th·∫≥ng","Luy·ªán ph·∫£n x·∫° b·∫≠t","Xu·∫•t ph√°t t·∫°i ch·ªó 5s"]},
      nhaycao:{loi:["Ch·∫°y ƒë√† ch∆∞a ƒë·ªß","G·ªëi kh√¥ng n√¢ng cao","L∆∞ng qua x√† k√©m"], chan:["G·ªëi","C·ªôt s·ªëng th·∫Øt l∆∞ng"], goiy:["Ch·∫°y ƒë√† + nh·∫£y 1 ch√¢n","K√©o gi√£n c·ªôt s·ªëng","B·∫≠t n√¢ng cao g·ªëi"]},
      nemta:{loi:["H·∫° vai khi xoay","Ch∆∞a t·ªëi ∆∞u l·ª±c ch√¢n"], chan:["C·ªï tay","Vai","L∆∞ng"], goiy:["TƒÉng c∆° b·ª•ng xoay","Ph·ªëi h·ª£p ch√¢n-tr·ª•c-ƒë·∫©y","Xoay ch·∫≠m gi·ªØ vai"]}
    }[sport];
    let loi=[],chanthuong=[],goiy=[],xeploai='',dongvien='',ketluan='';
    if(tile===100){xeploai='HO√ÄN H·∫¢O';dongvien='üåü Xu·∫•t s·∫Øc!';ketluan='Gi·ªØ v·ªØng';}
    else if(tile>=90){xeploai='T·ªêT';dongvien='üî• R·∫•t t·ªët!';ketluan='Gi·ªØ v·ªØng';loi=packs.loi.slice(0,1);chanthuong=packs.chan.slice(0,1);goiy=packs.goiy.slice(0,1);}
    else if(tile>=70){xeploai='KH√Å';dongvien='üëç Kh√° t·ªët!';ketluan='C·∫£i thi·ªán th√™m';loi=packs.loi.slice(0,2);chanthuong=packs.chan.slice(0,2);goiy=packs.goiy.slice(0,2);}
    else{xeploai='TRUNG B√åNH';dongvien='‚ö†Ô∏è C·∫ßn c·ªë g·∫Øng';ketluan='T·∫≠p trung luy·ªán';loi=packs.loi;chanthuong=packs.chan;goiy=packs.goiy;}
    return {loi,chanthuong,goiy,xeploai,dongvien,ketluan};
  }

  function showAnalysisPanel(res){
    if(!res){ analysisPanel.innerHTML='Ch∆∞a c√≥ ph√¢n t√≠ch.'; return; }
    let html = `<strong style="color:#fff">${res.name}</strong><br>`;
    html += `G√≥c: <span class="pill">${(res.view||'auto').toUpperCase()}</span> ¬∑ T·ªâ l·ªá ƒë√∫ng: <b style="color:var(--pri)">${res.tile}%</b> (ƒê√∫ng: ${res.dung} | Sai: ${res.sai})<br>`;
    html += `X·∫øp lo·∫°i: <b style="color:var(--accent)">${res.xeploai}</b> ‚Äì ${res.ketluan}<br>`;
    if(res.tile<100){
      html += '<hr style="border-color:var(--bd);opacity:.5"><div><b>‚ùå L·ªói t∆∞ th·∫ø</b><ul>'+res.loi.map(x=>`<li>${x}</li>`).join('')+'</ul></div>';
      html += '<div><b>‚ö†Ô∏è Nguy c∆° ch·∫•n th∆∞∆°ng</b><ul>'+res.chanthuong.map(x=>`<li>${x}</li>`).join('')+'</ul></div>';
      html += '<div><b>üí° G·ª£i √Ω</b><ul>'+res.goiy.map(x=>`<li>${x}</li>`).join('')+'</ul></div>';
    }
    analysisPanel.innerHTML=html;
  }

  function renderChart(){
    const sport=sportSel.value;
    const keys=Object.keys(results).filter(k=>results[k].sport===sport);
    const labels=keys.map(k=>results[k].name); const data=keys.map(k=>results[k].tile);
    if(window._chart) window._chart.destroy();
    window._chart=new Chart(chartCanvas.getContext('2d'),{
      type:'bar',
      data:{labels,datasets:[{label:'T·ªâ l·ªá ƒë√∫ng (%)',data,backgroundColor:'rgba(34,211,238,.8)',borderRadius:8}]},
      options:{indexAxis:'y',scales:{x:{min:0,max:110,grid:{color:'rgba(255,255,255,.06)'}},y:{grid:{display:false}}},plugins:{legend:{display:false}}}
    });
  }

  function renderStdEditor(){
    const s=sportSel.value; const list=rulesFor(s, 'front');
    stdEditor.innerHTML = list.map((r,i)=>`
      <div style="display:grid;grid-template-columns:1.2fr .8fr .8fr .8fr;gap:10px;align-items:center;margin-bottom:8px">
        <div>${r.name}${r.anySide?' <span class="pill">anySide</span>':''}</div>
        <div>mu·ªën: <input data-k="want" data-i="${i}" type="number" value="${r.want}" style="width:80px">¬∞</div>
        <div>¬± <input data-k="tol" data-i="${i}" type="number" value="${r.tol}" style="width:70px">¬∞</div>
        <div>w=<input data-k="weight" data-i="${i}" step="0.1" type="number" value="${r.weight||1}" style="width:70px"></div>
      </div>
    `).join('');
  }
  function applyStdEditorToSTD(){
    const s=sportSel.value; const list=STD[s]||[];
    stdEditor.querySelectorAll('input').forEach(inp=>{
      const idx=Number(inp.dataset.i), key=inp.dataset.k;
      if(list[idx] && key){ list[idx][key] = Number(inp.value); }
    });
    saveStd(STD);
  }

  function renderVideoList(){
    const s=sportSel.value;
    const filtered=uploadedVideos.filter(v=>v.sportTag===s||v.name.toLowerCase().includes(s==='xuatphat'?'xuat':(s==='nhaycao'?'nhay':'nem')));
    if(!filtered.length){ videoListEl.innerHTML='<div class="small">Ch∆∞a c√≥ video cho m√¥n n√†y.</div>'; return; }
    videoListEl.innerHTML='';
    filtered.forEach(v=>{
      const has=!!results[v.id];
      const div=document.createElement('div'); div.className='video-item';
      div.innerHTML=`
        <div style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px">
          <b>${v.name}</b> ${has?`<span class="pill" title="ƒê√£ ph√¢n t√≠ch">${results[v.id].tile}%</span>`:''}
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn">Xem</button>
          <button class="btn ${has?'':'btn-primary'} analyze">${has?'Ph√¢n t√≠ch l·∫°i':'Ph√¢n t√≠ch'}</button>
          <button class="btn btn-danger del" title="X√≥a">&times;</button>
        </div>`;
      div.querySelector('.btn').onclick=()=>openVideo(v);
      div.querySelector('.analyze').onclick=()=>{openVideo(v); setTimeout(()=>runAnalysisIfNeeded(v, has),200);}
      div.querySelector('.del').onclick=()=>showModal('X√≥a video n√†y?',true,async()=>{
        try{
          if(v.url) URL.revokeObjectURL(v.url);
          await deleteVideoFromDB(v.id);
          uploadedVideos = uploadedVideos.filter(x=>x.id!==v.id);
          if(results[v.id]){ delete results[v.id]; saveResults(); }
          if(currentVideo?.id===v.id){ currentVideo=null; player.src=''; analysisPanel.innerHTML='Ch∆∞a c√≥ video.'; }
          renderVideoList();
        }catch(e){ console.error(e); showModal('Kh√¥ng th·ªÉ x√≥a video.');}
      });
      videoListEl.appendChild(div);
    });
  }

  async function openVideo(v){
    currentVideo=v; player.src=v.url; player.muted=false; player.crossOrigin='anonymous'; player.playsInline=true;
    await new Promise(r=>{ if(player.readyState>=1) return r(); const fn=()=>{player.removeEventListener('loadedmetadata',fn); r();}; player.addEventListener('loadedmetadata',fn); setTimeout(r,1000); });
    player.pause();

    function resizeOverlay(){
      const rect=player.getBoundingClientRect(); const dpr=window.devicePixelRatio||1;
      overlay.style.width=rect.width+'px'; overlay.style.height=rect.height+'px';
      const w=Math.max(1,player.videoWidth||rect.width||640), h=Math.max(1,player.videoHeight||rect.height||360);
      overlay.width=Math.round(w*dpr); overlay.height=Math.round(h*dpr); const ctx=overlay.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    resizeOverlay(); window.addEventListener('resize',resizeOverlay);

    showAnalysisPanel(results[v.id]); renderChart(); ensureMpPose();
    const ctx=overlay.getContext('2d');

    mpPoseDrawingCallback=(r)=>{
      if(r?.poseLandmarks?.length) lastPoseLandmarks=r.poseLandmarks;
      const W=player.videoWidth||overlay.width||640, H=player.videoHeight||overlay.height||360;
      ctx.clearRect(0,0,overlay.width,overlay.height);
      if(lastPoseLandmarks?.length){
        const lm=lastPoseLandmarks.map(p=>({x:p.x*W,y:p.y*H}));
        const vUse = (viewSel.value==='auto')? detectView2D(lm) : viewSel.value;
        const chk = weightedCheck(extractAngles(lm), v.sportTag||sportSel.value, vUse);
        liveBadge.style.display='block';
        liveBadge.textContent = `[${vUse}] ` + (chk.pass?'‚úÖ ƒê·∫°t':'‚ö†Ô∏è L·ªói');

        const conns = (typeof POSE_CONNECTIONS!=='undefined')?POSE_CONNECTIONS:(Pose&&Pose.POSE_CONNECTIONS?Pose.POSE_CONNECTIONS:null);
        if(conns){ ctx.strokeStyle = chk.pass?'#22c55e':'#ef4444'; ctx.lineWidth=2.6;
          conns.forEach(c=>{const a=lm[c[0]], b=lm[c[1]]; if(a&&b){ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();}});
        }
        lm.forEach(p=>{ctx.fillStyle=chk.pass?'#22d3ee':'#fb7185'; ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill();});
      } else liveBadge.style.display='none';
    };
    mpPose.onResults(mpPoseDrawingCallback);

    let raf=null,last=0; const interval=45;
    async function loop(){
      if(player.paused||player.ended){ if(raf) cancelAnimationFrame(raf); return; }
      const now=performance.now(); if(now-last>interval){ try{ await mpPose.send({image:player}); }catch{} last=now; }
      raf=requestAnimationFrame(loop);
    }
    player.onplay=()=>loop();
    player.onended=()=>{ if(raf) cancelAnimationFrame(raf); liveBadge.style.display='none'; };
  }

  async function analyzeVideoUsingMediaPipe(videoFile, sport, force=false){
    if(results[videoFile.id] && !force) return results[videoFile.id];
    if(!ensureMpPose()){ showModal('Kh√¥ng kh·ªüi t·∫°o ƒë∆∞·ª£c MediaPipe Pose.'); return null; }

    featTime=[]; featAngles=[]; featVel=[]; viewCounts={front:0,left:0,right:0,back:0};

    player.src=videoFile.url; player.muted=true; player.crossOrigin='anonymous';
    await new Promise(r=>{ if(player.readyState>=1) return r(); const fn=()=>{player.removeEventListener('loadedmetadata',fn); r();}; player.addEventListener('loadedmetadata',fn); setTimeout(r,1200); });
    player.pause();

    const total=60, dur=player.duration||3, step=Math.max(0.08, dur/total);
    let sampled=0, validW=0, totalW=0, prevAngles=null;

    const prevCb = mpPoseDrawingCallback || (r=>{ if(r?.poseLandmarks?.length) lastPoseLandmarks=r.poseLandmarks; });
    setProgress(0,'0%');

    const chosen=viewSel.value;

    for(let i=0;i<total;i++){
      const t=Math.min(i*step, Math.max(0,(player.duration||dur)-0.05));
      await new Promise(resolve=>{
        const tmpCb=(res)=>{
          sampled++;
          if(res?.poseLandmarks?.length){
            const W=player.videoWidth||overlay.width||640, H=player.videoHeight||overlay.height||360;
            const lm=res.poseLandmarks.map(p=>({x:p.x*W,y:p.y*H}));
            const auto=detectView2D(lm); if(viewCounts[auto]!=null) viewCounts[auto]++;
            const vUse=(chosen==='auto')?auto:chosen;
            const ang=extractAngles(lm);
            const chk=weightedCheck(ang,sport,vUse);
            const dt=featTime.length? t-featTime.at(-1) : step;
            featTime.push(t); featAngles.push(ang); featVel.push(angleVelocity(prevAngles||ang, ang, dt)); prevAngles=ang;

            const sumW = rulesFor(sport,vUse).reduce((s,r)=>s+(Number(r.weight||1)),0);
            totalW += sumW; if(chk.pass) validW += sumW;
          }
          const pct = Math.round(((i+1)/total)*100);
          setProgress(pct, pct+'%'); setTimeout(resolve,8);
        };
        mpPose.onResults(tmpCb);
        const onSeek=async()=>{player.removeEventListener('seeked',onSeek); try{ await mpPose.send({image:player}); }catch{}};
        player.addEventListener('seeked',onSeek); try{ player.currentTime=t; }catch{ player.removeEventListener('seeked',onSeek); mpPose.onResults(prevCb); resolve(); }
        setTimeout(()=>{ try{ mpPose.onResults(prevCb);}catch{} resolve(); }, 2500);
      });
    }
    mpPose.onResults(prevCb);

    if(totalW<=0){ setProgress(100,'Xong'); showModal('Kh√¥ng ƒë·ªß khung h√¨nh h·ª£p l·ªá ƒë·ªÉ ph√¢n t√≠ch.'); return null; }

    let decided = viewSel.value;
    if(decided==='auto'){ decided = Object.entries(viewCounts).sort((a,b)=>b[1]-a[1])[0]?.[0]||'front'; }

    const summary=summarizeFeatures(); featROM=summary.rom;
    const ratio = validW/totalW; const tile=Math.round(ratio*100);
    const resultObj = { id:videoFile.id, name:videoFile.name, sport, sai:Math.max(0,total-sampled), dung:sampled, tile, view:decided, khungChuan:rulesFor(sport,decided), features:summary, ...deterministicClassification(tile,sport) };
    results[videoFile.id]=resultObj; saveResults(); setProgress(100,'Xong');

    const q = new URLSearchParams(location.search);
    const athleteId=q.get('athleteId');
    if(athleteId){ await saveAchievementToFirestore(resultObj, athleteId); await saveInjuryWarningsToFirestore(resultObj, athleteId); }

    return resultObj;
  }

  function renderDashboard(res){
    const t=featTime, pick=(arr,k)=>arr.map(a=> (typeof a[k]==='number')?a[k]:0 );
    const knee = pick(featAngles,'kneeL').map((v,i)=>Math.max(v, pick(featAngles,'kneeR')[i]||v));
    const hip  = pick(featAngles,'hipL').map((v,i)=>Math.max(v, pick(featAngles,'hipR')[i]||v));
    const torso= pick(featAngles,'torsoIncline');
    const velK = pick(featVel,'kneeL').map((v,i)=>Math.abs(Math.max(v, pick(featVel,'kneeR')[i]||v)));
    const velH = pick(featVel,'hipL').map((v,i)=>Math.abs(Math.max(v, pick(featVel,'hipR')[i]||v)));

    window._a && _a.destroy(); window._v && _v.destroy(); window._r && _r.destroy();
    const optBase={responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#e5e7eb'}}},scales:{x:{grid:{color:'rgba(255,255,255,.08)'}},y:{grid:{color:'rgba(255,255,255,.08)'}}}};
    _a=new Chart(angleChartEl.getContext('2d'),{type:'line',data:{labels:t,datasets:[{label:'G·ªëi',data:knee,borderColor:'#22d3ee',tension:.1},{label:'H√¥ng',data:hip,borderColor:'#a78bfa',tension:.1},{label:'Th√¢n',data:torso,borderColor:'#f59e0b',tension:.1}]},options:optBase});
    _v=new Chart(velChartEl.getContext('2d'),{type:'line',data:{labels:t,datasets:[{label:'|v| G·ªëi',data:velK,borderColor:'#34d399',tension:.1},{label:'|v| H√¥ng',data:velH,borderColor:'#fb7185',tension:.1}]},options:{...optBase,scales:{...optBase.scales,y:{...optBase.scales.y,title:{display:true,text:'¬∞/s',color:'#e5e7eb'}}}}});
    const rom=res.features?.rom||{}; const labels=Object.keys(rom), data=labels.map(k=>rom[k].range);
    _r=new Chart(romChartEl.getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'ROM (¬∞)',data,backgroundColor:'rgba(245,158,11,.85)',borderRadius:8}]},options:{...optBase,indexAxis:'y'}});
    aiAlertsEl.innerHTML='<span class="muted">·∫§n "Ch·∫°y m√¥ h√¨nh AI".</span>';
  }

  exportBtn.onclick=()=>{
    if(!currentVideo||!results[currentVideo.id]) return showModal('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ xu·∫•t.');
    const data=results[currentVideo.id]; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${data.name.replace(/\.[^/.]+$/,'')}_report.json`; a.click(); URL.revokeObjectURL(url);
  };
  toggleDashboardBtn.onclick=()=>{ dashCard.style.display=dashCard.style.display==='none'?'block':'none'; if(dashCard.style.display==='block'&&currentVideo&&results[currentVideo.id]) renderDashboard(results[currentVideo.id]); };
  exportFeaturesBtn.onclick=()=>{
    if(!currentVideo) return showModal('Ch∆∞a c√≥ video.');
    const summary=results[currentVideo.id]?.features || summarizeFeatures();
    const payload={meta:{videoId:currentVideo.id,name:currentVideo.name,sport:currentVideo.sportTag||sportSel.value},time:featTime,angles:featAngles,velocity:featVel,summary};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.json`; a.click(); URL.revokeObjectURL(url);
  };
  exportFeaturesCsvBtn.onclick=()=>{
    if(!currentVideo) return showModal('Ch∆∞a c√≥ video.');
    const keys=['kneeL','kneeR','hipL','hipR','elbowL','elbowR','shoulderL','shoulderR','torsoIncline'];
    const header=['t',...keys,...keys.map(k=>'v_'+k)]; const rows=[header.join(',')];
    for(let i=0;i<featTime.length;i++){ const a=featAngles[i]||{}, v=featVel[i]||{}; rows.push([featTime[i].toFixed(3),...keys.map(k=>a[k]??''),...keys.map(k=>v[k]??'')].join(',')); }
    const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.csv`; a.click(); URL.revokeObjectURL(url);
  };
  runModelBtn.onclick=async()=>{
    const summary=results[currentVideo?.id]?.features || summarizeFeatures();
    const angleKeys=['kneeL','kneeR','hipL','hipR','elbowL','elbowR','shoulderL','shoulderR','torsoIncline'];
    const flat=(o,ks)=>ks.map(k=> (typeof o[k]==='number')?o[k]:0 );
    const romRanges=angleKeys.map(k=> summary.rom[k]?.range ?? 0);
    const inputVec=[...flat(summary.mean,angleKeys),...flat(summary.std,angleKeys),...romRanges,...flat(summary.vmean,angleKeys),...flat(summary.vstd,angleKeys)];
    let alerts=[];
    if(!aiAvailable) await tryLoadAIModel();
    if(aiAvailable&&aiModel){
      try{const t=tf.tensor2d([inputVec]); const out=aiModel.predict(t); const y=(Array.isArray(out)?out[0]:out).dataSync(); const labels=['Sai k·ªπ thu·∫≠t','T∆∞ th·∫ø r·ªßi ro','B·∫•t th∆∞·ªùng']; alerts=Array.from(y).map((s,i)=>`${labels[i]||('m·ª•c '+i)}: ${(s*100).toFixed(1)}%`);}catch{alerts=['Model l·ªói. D√πng heuristics.'];}
    }
    if(!alerts.length){
      const r=summary.rom||{}, vm=summary.vmean||{};
      const kneeROM=Math.max(r.kneeL?.range||0,r.kneeR?.range||0);
      const hipROM=Math.max(r.hipL?.range||0,r.hipR?.range||0);
      const torso=r.torsoIncline?.range||0;
      const kneeV=Math.max(Math.abs(vm.kneeL||0),Math.abs(vm.kneeR||0));
      const msg=[];
      if(sportSel.value==='nhaycao'){ if(kneeROM<35) msg.push('ROM g·ªëi th·∫•p (<35¬∞)'); if(hipROM<30) msg.push('ROM h√¥ng th·∫•p (<30¬∞)'); if(torso>50) msg.push('Th√¢n dao ƒë·ªông l·ªõn'); }
      if(sportSel.value==='xuatphat'){ if(kneeV<20) msg.push('V·∫≠n t·ªëc g·ªëi th·∫•p (<20¬∞/s)'); }
      if(sportSel.value==='nemta'){ if(hipROM<25) msg.push('ROM h√¥ng th·∫•p'); if(Math.abs(vm.shoulderR||0)<10 && Math.abs(vm.shoulderL||0)<10) msg.push('Vai vung ch·∫≠m'); }
      alerts = msg.length? msg : ['Kh√¥ng ph√°t hi·ªán c·∫£nh b√°o r√µ r√†ng.'];
    }
    aiAlertsEl.innerHTML='<ul>'+alerts.map(a=>`<li>${a}</li>`).join('')+'</ul>';
  };

  sportSel.onchange=()=>{ renderVideoList(); renderChart(); renderStdEditor(); updateThreshUI(); };
  analyzeBtn.onclick=()=>{ if(!currentVideo) return showModal('Ch∆∞a ch·ªçn video.'); runAnalysisIfNeeded(currentVideo,false); };
  forceAnalyzeBtn.onclick=()=>{ if(!currentVideo) return showModal('Ch∆∞a ch·ªçn video.'); runAnalysisIfNeeded(currentVideo,true); };

  videoUpload.addEventListener('change', async e=>{
    const files=[...e.target.files];
    for(const f of files){
      const id=uidFromName(f.name+'_'+Date.now()), url=URL.createObjectURL(f);
      let tag=''; const ln=f.name.toLowerCase();
      if(ln.includes('xuat')) tag='xuatphat'; else if(ln.includes('nhay')) tag='nhaycao'; else if(ln.includes('nem')) tag='nemta';
      if(!tag) tag=sportSel.value;
      const v={id,name:f.name,url,sportTag:tag,file:f}; uploadedVideos.push(v);
      try{ await saveVideoToDB({id,name:f.name,sportTag:tag,file:f}); }catch(e){ console.error('L·ªói l∆∞u DB',e);}
    }
    renderVideoList(); if(uploadedVideos.length && !currentVideo) openVideo(uploadedVideos.at(-1));
  });

  clearStorageBtn.onclick=()=>showModal('X√≥a to√†n b·ªô d·ªØ li·ªáu (video & k·∫øt qu·∫£)?',true,async()=>{
    localStorage.removeItem('thethaott_results'); try{ await clearVideosFromDB(); uploadedVideos.forEach(v=>URL.revokeObjectURL(v.url)); uploadedVideos=[]; }catch{}
    results={}; renderVideoList(); renderChart(); analysisPanel.innerHTML='ƒê√£ x√≥a d·ªØ li·ªáu.'; player.src=''; currentVideo=null;
  });

  const updateThreshUI=()=>{ const s=sportSel.value; sportThresh.value=THRESH[s]; threshLabel.textContent=`${THRESH[s]}%`; }
  sportThresh.oninput=()=>{ const s=sportSel.value; THRESH[s]=Number(sportThresh.value); threshLabel.textContent=`${THRESH[s]}%`; saveThresh(THRESH); };

  saveStdBtn.onclick=()=>{ applyStdEditorToSTD(); showModal('ƒê√£ l∆∞u khung chu·∫©n.'); };
  recalcBtn.onclick=()=>{ if(!currentVideo) return showModal('Ch∆∞a c√≥ video.'); runAnalysisIfNeeded(currentVideo,true); };
  document.getElementById('resetStandards').onclick=()=>{ STD=JSON.parse(JSON.stringify(DEFAULT_STD)); saveStd(STD); renderStdEditor(); showModal('ƒê√£ kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh.'); };

  (async ()=>{
    try{ await initDB(); const stored=await getVideosFromDB(); uploadedVideos = stored.map(v=>({...v, url:URL.createObjectURL(v.file)})); }catch(e){ console.warn('DB fail',e); }
    renderVideoList(); renderChart(); renderStdEditor(); updateThreshUI(); ensureMpPose();
    const q=new URLSearchParams(location.search); const name=q.get('athleteName');
    if(name){ document.getElementById('pageTitle').textContent = `Ph√¢n t√≠ch t∆∞ th·∫ø cho VƒêV: ${decodeURIComponent(name)}`; }
  })();

  window.addEventListener('beforeunload',()=>{ uploadedVideos.forEach(v=>{try{URL.revokeObjectURL(v.url);}catch{}}); });
</script>
</body>
</html>
