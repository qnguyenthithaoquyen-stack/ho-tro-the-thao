<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ph√¢n t√≠ch t∆∞ th·∫ø cho VƒêV</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- MediaPipe Pose (0.5) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.min.js"></script>

  <style>
    :root{
      --bg:#f1faf7; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --primary:#10b981; --primary-700:#059669; --ring:rgba(16,185,129,.18);
      --line:#e2e8f0; --danger:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,Arial,sans-serif;}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
    .header{background:linear-gradient(90deg,#eafff6,#f5fffb);border:1px solid var(--line);padding:14px 16px;border-radius:12px;margin-bottom:16px;display:flex;gap:12px;align-items:center;justify-content:space-between;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .header-title{font-weight:700}.header-sub{color:var(--muted);font-size:13px}.header-right{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:#f8fafc}.btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}.btn-primary:hover{background:var(--primary-700)}
    .btn-danger{background:#fff;color:var(--danger);border-color:var(--danger)}.btn-danger:hover{background:#fff0f0}
    .btn-ghost{background:#fff}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .select,.filebox{border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 12px;border-radius:10px;font-weight:700;outline:none}
    .select:focus,.filebox:focus{box-shadow:0 0 0 8px var(--ring);border-color:var(--primary)}
    .player{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
    .player video{width:100%;display:block}
    .overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    .badge{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.6);color:#fff;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.2)}
    .progress{display:flex;align-items:center;gap:10px;margin-top:10px}
    .bar{flex:1;height:10px;background:#eef2f7;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:var(--primary);transition:width .2s}
    .small{color:var(--muted);font-size:13px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px}
    .tag{background:#f1f5f9;color:#334155;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .note{color:#7c2d12;background:#fffbeb;border:1px solid #fde68a;padding:8px;border-radius:8px}
    @media (max-width:1060px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="header-title">Ph√¢n t√≠ch t∆∞ th·∫ø cho VƒêV</div>
        <div class="header-sub">T·∫£i video, ch·∫°y MediaPipe, so kh·ªõp v·ªõi khung chu·∫©n theo m√¥n & g√≥c quay.</div>
      </div>
      <div class="header-right">
        <button class="btn" id="backBtn">‚Üê B·∫£ng ƒëi·ªÅu khi·ªÉn</button>
        <button class="btn" id="exportJsonBtn">Xu·∫•t features (.json)</button>
        <button class="btn" id="exportCsvBtn">Xu·∫•t (.csv)</button>
        <button class="btn btn-primary" id="reportBtn">Xu·∫•t b√°o c√°o</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h3>Tr√¨nh ph√°t & ƒêi·ªÅu khi·ªÉn</h3>
        <div class="row" style="margin-bottom:10px">
          <select id="sport" class="select">
            <option value="xuatphat">M√¥n th·ªÉ thao: Xu·∫•t ph√°t</option>
            <option value="nhaycao">M√¥n th·ªÉ thao: Nh·∫£y cao</option>
            <option value="nemta">M√¥n th·ªÉ thao: N√©m t·∫°</option>
          </select>

          <select id="viewSel" class="select">
            <option value="auto">G√≥c quay: T·ª± ƒë·ªông</option>
            <option value="front">G√≥c quay: FRONT</option>
            <option value="left">G√≥c quay: LEFT</option>
            <option value="right">G√≥c quay: RIGHT</option>
            <option value="back">G√≥c quay: BACK</option>
          </select>

          <input type="file" id="videoUpload" class="filebox" accept="video/*" />
          <button id="analyzeBtn" class="btn btn-primary">Ph√¢n t√≠ch</button>
          <button id="reanalyzeBtn" class="btn">Ph√¢n t√≠ch l·∫°i</button>
          <button id="clearBtn" class="btn btn-danger">X√≥a d·ªØ li·ªáu</button>
        </div>

        <div class="player">
          <video id="player" controls playsinline crossorigin="anonymous" muted></video>
          <canvas id="overlay" class="overlay"></canvas>
          <div id="liveBadge" class="badge" style="display:none">ƒêang ki·ªÉm tra‚Ä¶</div>
        </div>

        <div class="progress" id="progressRow" style="display:none">
          <div class="bar"><span id="progressBar"></span></div>
          <div class="small" id="progressText">0%</div>
        </div>

        <div class="small" style="text-align:center;margin-top:8px">
          ¬© 2025 ‚Äî Demo theo y√™u c·∫ßu. N·∫øu auto-view ƒëo√°n sai, h√£y ch·ªçn tay FRONT/LEFT/RIGHT/BACK.
        </div>

        <h3 style="margin-top:20px">L·ªãch s·ª≠ video (l·ªçc theo m√¥n)</h3>
        <div id="videoList" class="list"></div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3>Th√¥ng tin ph√¢n t√≠ch</h3>
        <div id="info" class="small" style="border:1px solid var(--line);border-radius:10px;padding:12px">
          Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.
        </div>

        <h3 style="margin-top:16px">Th·ªëng k√™ t·ªâ l·ªá ƒë√∫ng</h3>
        <div style="height:220px"><canvas id="chart"></canvas></div>
      </div>
    </div>
  </div>

<script>
/* ========================== N√öT TI·ªÜN √çCH ========================== */
const backBtn = document.getElementById('backBtn');
backBtn.onclick = () => history.back();

const reportBtn = document.getElementById('reportBtn');
reportBtn.onclick = () => {
  if (!currentVideo || !results[currentVideo.id]) { alert('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ xu·∫•t.'); return; }
  const blob = new Blob([JSON.stringify(results[currentVideo.id], null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob), a = document.createElement('a');
  a.href = url; a.download = `${results[currentVideo.id].name.replace(/\.[^/.]+$/,'')}_report.json`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
};

const exportJsonBtn = document.getElementById('exportJsonBtn');
const exportCsvBtn  = document.getElementById('exportCsvBtn');

/* ========================== BI·∫æN TO√ÄN C·ª§C ========================== */
const sportSel = document.getElementById('sport');
const viewSel  = document.getElementById('viewSel');
const videoUpload = document.getElementById('videoUpload');
const videoListEl = document.getElementById('videoList');
const player = document.getElementById('player');
const overlay = document.getElementById('overlay');
const analyzeBtn = document.getElementById('analyzeBtn');
const reanalyzeBtn = document.getElementById('reanalyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const infoEl = document.getElementById('info');
const liveBadge = document.getElementById('liveBadge');
const progressRow = document.getElementById('progressRow');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const chartCanvas = document.getElementById('chart');

let results = JSON.parse(localStorage.getItem('thethaott_results')||'{}');  // KH√îNG m·∫•t khi tho√°t
let savedVideos = JSON.parse(localStorage.getItem('thethaott_videos')||'[]'); // danh s√°ch metadata
let uploadedVideos = []; // b·∫£n runtime: {id,name, sportTag, url}
let currentVideo = null;
let chart = null;

let mpPose = null, drawCb = null;

/* ========================== POSE AN TO√ÄN ========================== */
function ensurePose(){
  if (mpPose) return mpPose;
  if (window.Pose && typeof window.Pose.Pose === 'function'){
    mpPose = new window.Pose.Pose({ locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}` });
  } else if (window.Pose && typeof window.Pose === 'function'){
    mpPose = new window.Pose({ locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}` });
  } else { alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c MediaPipe Pose'); return null; }

  mpPose.setOptions({ modelComplexity:1, smoothLandmarks:true, enableSegmentation:false, minDetectionConfidence:0.45, minTrackingConfidence:0.45 });
  mpPose.onResults(r => drawCb && drawCb(r));
  return mpPose;
}

/* ========================== RULES ========================== */
const BASE = {
  xuatphat: [
    {name:'G·ªëi (L/R)',      joints:['kneeL','kneeR'],   want:100, tol:28, anySide:true},
    {name:'H√¥ng (L/R)',     joints:['hipL','hipR'],     want:120, tol:30, anySide:true},
    {name:'Th√¢n nghi√™ng',   joints:['torso'],           want:45,  tol:20},
    {name:'Khu·ª∑u (L/R)',    joints:['elbowL','elbowR'], want:90,  tol:35, anySide:true}
  ],
  nhaycao: [
    {name:'G·ªëi gi·∫≠m (L/R)', joints:['kneeL','kneeR'],   want:150, tol:25, anySide:true},
    {name:'H√¥ng m·ªü (L/R)',  joints:['hipL','hipR'],     want:160, tol:25, anySide:true},
    {name:'Th√¢n nghi√™ng',   joints:['torso'],           want:20,  tol:18}
  ],
  nemta: [
    {name:'G·ªëi (L/R)',      joints:['kneeL','kneeR'],   want:100, tol:30, anySide:true},
    {name:'H√¥ng (L/R)',     joints:['hipL','hipR'],     want:120, tol:30, anySide:true},
    {name:'Khu·ª∑u (L/R)',    joints:['elbowL','elbowR'], want:100, tol:30, anySide:true},
    {name:'Th√¢n nghi√™ng',   joints:['torso'],           want:30,  tol:18}
  ]
};
const VIEW_RULES = {
  xuatphat:{
    front:BASE.xuatphat, back:BASE.xuatphat,
    left:[{name:'G·ªëi (g·∫ßn)',joints:['kneeL','kneeR'],want:100,tol:28,anySide:true},{name:'H√¥ng (g·∫ßn)',joints:['hipL','hipR'],want:120,tol:32,anySide:true},{name:'Th√¢n',joints:['torso'],want:45,tol:20}],
    right:[{name:'G·ªëi (g·∫ßn)',joints:['kneeL','kneeR'],want:100,tol:28,anySide:true},{name:'H√¥ng (g·∫ßn)',joints:['hipL','hipR'],want:120,tol:32,anySide:true},{name:'Th√¢n',joints:['torso'],want:45,tol:20}]
  },
  nhaycao:{front:BASE.nhaycao,back:BASE.nhaycao,left:BASE.nhaycao,right:BASE.nhaycao},
  nemta:{front:BASE.nemta,back:BASE.nemta,left:BASE.nemta,right:BASE.nemta}
};
const THRESH = { xuatphat:0.4, nhaycao:0.5, nemta:0.6 }; // n·ªõi nh·∫π cho xu·∫•t ph√°t

/* ========================== H√åNH H·ªåC / G√ìC ========================== */
function degBetween(a,b,c){const abx=a.x-b.x,aby=a.y-b.y,cbx=c.x-b.x,cby=c.y-b.y,dot=abx*cbx+aby*cby,mag=Math.sqrt((abx*abx+aby*aby)*(cbx*cbx+cby*cby));if(!mag)return 0;let cos=dot/mag;cos=Math.max(-1,Math.min(1,cos));return Math.acos(cos)*180/Math.PI;}
function torsoDeg(lm){const lS=lm[11],rS=lm[12],lH=lm[23],rH=lm[24];if(!lS||!rS||!lH||!rH)return 0;const s={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2},h={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};const dx=s.x-h.x,dy=s.y-h.y;return Math.atan2(Math.abs(dy),Math.abs(dx))*180/Math.PI;}
function extractAngles(lm){const A={};if(lm[23]&&lm[25]&&lm[27])A.kneeL=degBetween(lm[23],lm[25],lm[27]);if(lm[24]&&lm[26]&&lm[28])A.kneeR=degBetween(lm[24],lm[26],lm[28]);if(lm[11]&&lm[23]&&lm[25])A.hipL=degBetween(lm[11],lm[23],lm[25]);if(lm[12]&&lm[24]&&lm[26])A.hipR=degBetween(lm[12],lm[24],lm[26]);if(lm[11]&&lm[13]&&lm[15])A.elbowL=degBetween(lm[11],lm[13],lm[15]);if(lm[12]&&lm[14]&&lm[16])A.elbowR=degBetween(lm[12],lm[14],lm[16]);if(lm[13]&&lm[11]&&lm[23])A.shoulderL=degBetween(lm[13],lm[11],lm[23]);if(lm[14]&&lm[12]&&lm[24])A.shoulderR=degBetween(lm[14],lm[12],lm[24]);A.torso=torsoDeg(lm);return A;}
function detectView2D(lm){const lS=lm[11],rS=lm[12],lH=lm[23],rH=lm[24];if(!(lS&&rS&&lH&&rH))return 'front';const sMid={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2},hMid={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};const torsoLen=Math.hypot(sMid.x-hMid.x,sMid.y-hMid.y),shW=Math.abs(rS.x-lS.x);const ratio=shW/(torsoLen||1);if(ratio<0.6)return (rS.x>lS.x)?'right':'left';return 'front';}
function rulesFor(sport,view){const G=VIEW_RULES[sport]||{};return G[view]||BASE[sport]||[];}
function checkAgainstRules(angles,rules,sportKey){let ok=0;for(const r of rules){let within=false;if(r.anySide){for(const k of r.joints){const v=angles[k];if(typeof v==='number'&&Math.abs(v-r.want)<=r.tol){within=true;break;}}}else{const v=angles[r.joints[0]];if(typeof v==='number'&&Math.abs(v-r.want)<=r.tol)within=true;}if(within)ok++;}const total=rules.length,ratio=total?ok/total:0,need=THRESH[sportKey]??0.6;return {pass:ratio>=need,ratio,ok,total};}
function passByAnyRuleSet(angles,sets,sportKey){for(const {rules,threshOverride} of sets){const o=THRESH[sportKey];if(threshOverride!=null)THRESH[sportKey]=threshOverride;const r=checkAgainstRules(angles,rules,sportKey);if(threshOverride!=null)THRESH[sportKey]=o;if(r.pass)return {pass:true};}return {pass:false};}

/* ========================== FEATURE ========================== */
let featTime=[],featAngles=[],featVel=[];
function angleVelocity(prev,curr,dt){const out={};const keys=new Set([...Object.keys(prev||{}),...Object.keys(curr||{})]);keys.forEach(k=>{const a=(curr&&typeof curr[k]==='number')?curr[k]:null;const b=(prev&&typeof prev[k]==='number')?prev[k]:null;out[k]=(a!=null&&b!=null&&dt>0)?(a-b)/dt:0;});return out;}
function summarizeFeatures(){const keys=new Set();featAngles.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));const sum={},sumSq={};keys.forEach(k=>{sum[k]=0;sumSq[k]=0;});const n=featAngles.length;featAngles.forEach(a=>{keys.forEach(k=>{const v=typeof a[k]==='number'?a[k]:0;sum[k]+=v;sumSq[k]+=v*v;});});const mean={},std={};keys.forEach(k=>{mean[k]=n?(sum[k]/n):0;std[k]=n?Math.sqrt(Math.max(0,sumSq[k]/n-mean[k]*mean[k])):0;});return {mean,std,nFrames:n};}

/* ========================== UI PH·ª§ ========================== */
function setProgress(pct,text){progressRow.style.display='flex';progressBar.style.width=Math.max(0,Math.min(100,pct))+'%';progressText.textContent=text??(Math.round(pct)+'%');if(pct>=100)setTimeout(()=>progressRow.style.display='none',400);}
function showInfo(res){
  if(!res){infoEl.textContent='Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.';return;}
  let html=`<div class="tag"><b>${res.name}</b></div>
    <div style="margin:8px 0"><span class="tag">G√≥c: ${res.view.toUpperCase()}</span> ‚Äî T·ªâ l·ªá ƒë√∫ng: <b>${res.tile}%</b> (ƒê√∫ng: ${res.dung}, Sai: ${res.sai})</div>`;
  if(res.loi?.length)html+=`<div><b>‚ùå L·ªói th∆∞·ªùng g·∫∑p</b><ul>${res.loi.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
  if(res.chanthuong?.length)html+=`<div><b>‚ö†Ô∏è Nguy c∆° ch·∫•n th∆∞∆°ng</b><ul>${res.chanthuong.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
  if(res.goiy?.length)html+=`<div><b>üí° G·ª£i √Ω</b><ul>${res.goiy.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
  if(res.note)html+=`<div class="note" style="margin-top:8px">${res.note}</div>`;
  infoEl.innerHTML=html;
}
let chart=null;
function renderChart(){
  const sport=sportSel.value; const keys=Object.keys(results).filter(k=>results[k].sport===sport);
  const labels=keys.map(k=>results[k].name), data=keys.map(k=>results[k].tile);
  if(chart)chart.destroy();
  chart=new Chart(chartCanvas.getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'T·ªâ l·ªá ƒë√∫ng (%)',data,backgroundColor:'#10b981'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:110}}}});
}

/* ========================== L·ªäCH S·ª¨ VIDEO (PERSIST) ========================== */
function uidFromName(name){let h=2166136261;for(let i=0;i<name.length;i++){h^=name.charCodeAt(i);h+=(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);}return 'v_'+(h>>>0);}
function persistVideos(){localStorage.setItem('thethaott_videos',JSON.stringify(savedVideos));}
function upsertSavedVideo(meta){const i=savedVideos.findIndex(x=>x.id===meta.id);if(i>=0)savedVideos[i]=meta;else savedVideos.push(meta);persistVideos();}
function runtimeFromSaved(){uploadedVideos = savedVideos.map(x=>({id:x.id,name:x.name,sportTag:x.sport, url:null}));}

function renderVideoList(){
  const sport=sportSel.value; videoListEl.innerHTML='';
  const list = savedVideos.filter(v=>v.sport===sport || (v.name||'').toLowerCase().includes(sport));
  if(!list.length){videoListEl.innerHTML='<div class="small">Ch∆∞a c√≥ video cho m√¥n n√†y.</div>';return;}
  list.forEach(meta=>{
    const hasUrl = !!(uploadedVideos.find(u=>u.id===meta.id && u.url));
    const row=document.createElement('div');row.className='item';
    row.innerHTML=`<div><b>${meta.name}</b><div class="small">${meta.sport}</div></div>
      <div>
        ${results[meta.id]?`<span class="tag">ƒê√£ ph√¢n t√≠ch</span>`:''}
        <button class="btn btn-ghost" ${hasUrl?'':'disabled'}>Xem</button>
        <button class="btn btn-ghost" ${hasUrl?'':'disabled'}>${results[meta.id]?'Ph√¢n t√≠ch l·∫°i':'Ph√¢n t√≠ch'}</button>
        <button class="btn btn-ghost">G·∫Øn file</button>
        <button class="btn btn-danger">X√≥a</button>
      </div>`;
    const [btnXem,btnPhan,btnGan,btnXoa]=row.querySelectorAll('button');

    btnGan.onclick=()=>{
      const input=document.createElement('input');input.type='file';input.accept='video/*';
      input.onchange=e=>{
        const f=e.target.files?.[0]; if(!f) return;
        const url=URL.createObjectURL(f);
        const idx=uploadedVideos.findIndex(u=>u.id===meta.id);
        if(idx>=0) uploadedVideos[idx].url=url; else uploadedVideos.push({id:meta.id,name:f.name||meta.name,sportTag:meta.sport,url});
        // C·∫≠p nh·∫≠t t√™n n·∫øu kh√°c
        if(f.name && f.name!==meta.name){ meta.name=f.name; upsertSavedVideo(meta); }
        renderVideoList(); openVideo(uploadedVideos.find(u=>u.id===meta.id));
      };
      input.click();
    };

    btnXem.onclick=()=>{
      const v=uploadedVideos.find(u=>u.id===meta.id);
      if(!v||!v.url){alert('H√£y g·∫Øn file cho video n√†y.');return;}
      openVideo(v);
    };
    btnPhan.onclick=()=>{
      const v=uploadedVideos.find(u=>u.id===meta.id);
      if(!v||!v.url){alert('H√£y g·∫Øn file cho video n√†y.');return;}
      openVideo(v); setTimeout(()=>analyze(v,!!results[v.id]),120);
    };
    btnXoa.onclick=()=>{
      if(!confirm('X√≥a m·ª•c n√†y kh·ªèi l·ªãch s·ª≠?'))return;
      const v=uploadedVideos.find(u=>u.id===meta.id);
      if(v&&v.url) URL.revokeObjectURL(v.url);
      uploadedVideos = uploadedVideos.filter(u=>u.id!==meta.id);
      savedVideos = savedVideos.filter(s=>s.id!==meta.id); persistVideos();
      if(results[meta.id]){ delete results[meta.id]; localStorage.setItem('thethaott_results',JSON.stringify(results)); }
      renderVideoList(); renderChart();
      if(currentVideo && currentVideo.id===meta.id){player.src=''; infoEl.textContent='Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.'; currentVideo=null;}
    };

    videoListEl.appendChild(row);
  });
}

/* ========================== SKELETON ========================== */
function getConnections(){
  if (window.POSE_CONNECTIONS) return window.POSE_CONNECTIONS;
  if (window.Pose && window.Pose.POSE_CONNECTIONS) return window.Pose.POSE_CONNECTIONS;
  // Fallback th·ªß c√¥ng (r√∫t g·ªçn c√°c nh√°nh ch√≠nh)
  return [[11,13],[13,15],[12,14],[14,16],[11,12],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];
}
function resizeOverlay(){
  const rect=player.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
  overlay.style.width=rect.width+'px'; overlay.style.height=rect.height+'px';
  overlay.width=Math.max(1,Math.round((player.videoWidth||rect.width||640)*dpr));
  overlay.height=Math.max(1,Math.round((player.videoHeight||rect.height||360)*dpr));
  overlay.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize',()=>{if(!player.src)return;resizeOverlay();});

/* ========================== PLAY / OVERLAY ========================== */
function openVideo(v){
  currentVideo=v; player.src=v.url; player.muted=false; player.crossOrigin='anonymous'; player.playsInline=true;
  player.onloadedmetadata=()=>resizeOverlay();
  player.onplay=()=>{
    ensurePose();
    drawCb=(res)=>{
      const ctx=overlay.getContext('2d'); ctx.clearRect(0,0,overlay.width,overlay.height);
      if(!(res&&res.poseLandmarks&&res.poseLandmarks.length)){ liveBadge.style.display='none'; return; }
      const w=player.videoWidth||overlay.width, h=player.videoHeight||overlay.height;
      const lm=res.poseLandmarks.map(l=>({x:l.x*w,y:l.y*h})), conns=getConnections();
      const A=extractAngles(lm);
      const auto=viewSel.value==='auto'?detectView2D(lm):viewSel.value;
      const startRules=rulesFor(v.sportTag||sportSel.value,auto);
      const kneeMin=Math.min((A.kneeL??999),(A.kneeR??999)), isRun=(kneeMin>140)&&(A.torso!=null?A.torso<30:false);
      const sets=isRun&&(v.sportTag||sportSel.value)==='xuatphat'?[{rules:startRules},{rules:startRules,threshOverride:0.5}]:[{rules:startRules}];
      const isPass=passByAnyRuleSet(A,sets,v.sportTag||sportSel.value).pass;
      const col=isPass?'#10b981':'#ef4444';

      ctx.lineWidth=2.5; ctx.strokeStyle=col;
      conns.forEach(([a,b])=>{if(lm[a]&&lm[b]){ctx.beginPath();ctx.moveTo(lm[a].x,lm[a].y);ctx.lineTo(lm[b].x,lm[b].y);ctx.stroke();}});
      ctx.fillStyle='#22d3ee'; lm.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();});
      liveBadge.style.display='block'; liveBadge.textContent=`[${auto}] ${isPass?'ƒê·∫°t':'L·ªói'}`;
    };
    const loop=async()=>{ if(player.paused||player.ended)return; try{await mpPose.send({image:player});}catch{} requestAnimationFrame(loop); };
    loop();
  };
  player.onpause=()=>liveBadge.style.display='none';
  showInfo(results[v.id]); renderChart();
}

/* ========================== PH√ÇN T√çCH ========================== */
const MIN_COVERAGE=0.25, MIN_PASS_FRAMES=3, MIN_PASS_RATIO=0.10;

reanalyzeBtn.onclick=()=>{ if(!currentVideo){alert('Ch∆∞a ch·ªçn video.');return;} analyze(currentVideo,true); };
analyzeBtn.onclick=()=>{ if(!currentVideo){alert('Ch∆∞a ch·ªçn video.');return;} analyze(currentVideo,false); };

async function probeView(v, samples=[0.25,0.5,0.75]){
  const tmp={front:0,left:0,right:0,back:0};
  for(const r of samples){
    const t=Math.max(0, Math.min(player.duration-0.05, (player.duration||0)*r));
    await new Promise(res=>{
      const prev=mpPose.onResults;
      mpPose.onResults=(rs)=>{ if(rs&&rs.poseLandmarks&&rs.poseLandmarks.length){
        const w=player.videoWidth||640,h=player.videoHeight||360;
        const lm=rs.poseLandmarks.map(l=>({x:l.x*w,y:l.y*h})); tmp[detectView2D(lm)]++; }
        mpPose.onResults=prev; res(); };
      const onseek=async()=>{player.removeEventListener('seeked',onseek);try{await mpPose.send({image:player});}catch{}};
      player.addEventListener('seeked',onseek); try{player.currentTime=t;}catch{player.removeEventListener('seeked',onseek);res();}
      setTimeout(()=>{mpPose.onResults=prev;res();},1200);
    });
  }
  return Object.entries(tmp).sort((a,b)=>b[1]-a[1])[0]?.[0]||'front';
}

async function analyze(v, force=false){
  if(results[v.id] && !force){ showInfo(results[v.id]); return; }
  if(!ensurePose()){ alert('Kh√¥ng kh·ªüi t·∫°o ƒë∆∞·ª£c Pose'); return; }

  featTime=[]; featAngles=[]; featVel=[];
  player.src=v.url; player.muted=true;
  await new Promise(r=>{ if(player.readyState>=1)return r(); player.onloadedmetadata=()=>r(); setTimeout(r,1200); });
  player.pause(); resizeOverlay();

  const total=60, duration=player.duration||3, step=Math.max(0.08,duration/total);
  let sampled=0, covered=0, valid=0, viewCounts={front:0,left:0,right:0,back:0};

  setProgress(0,'0%');
  for(let i=0;i<total;i++){
    const t=Math.min(i*step, Math.max(0,(player.duration||duration)-0.05));
    await new Promise(resolve=>{
      const once=(rs)=>{
        sampled++;
        if(rs&&rs.poseLandmarks&&rs.poseLandmarks.length){
          covered++;
          const w=player.videoWidth||640,h=player.videoHeight||360;
          const lm=rs.poseLandmarks.map(l=>({x:l.x*w,y:l.y*h}));
          const auto=detectView2D(lm); viewCounts[auto]=(viewCounts[auto]||0)+1;
          const A=extractAngles(lm);
          const chosen=viewSel.value==='auto'?auto:viewSel.value;
          const startRules=rulesFor(v.sportTag||sportSel.value,chosen);
          const kneeMin=Math.min((A.kneeL??999),(A.kneeR??999)), isRun=(kneeMin>140)&&(A.torso!=null?A.torso<30:false);
          const sets=isRun&&(v.sportTag||sportSel.value)==='xuatphat'?[{rules:startRules},{rules:startRules,threshOverride:0.5}]:[{rules:startRules}];
          if(passByAnyRuleSet(A,sets,v.sportTag||sportSel.value).pass) valid++;
          const dt=featTime.length?(t-featTime.at(-1)):step; featTime.push(t); featAngles.push(A); featVel.push(angleVelocity(featAngles.at(-2)||A,A,dt));
        }
        setProgress(Math.round(((i+1)/total)*100));
        resolve();
      };
      const prev=mpPose.onResults; mpPose.onResults=(r)=>{once(r);mpPose.onResults=prev;};
      const onseek=async()=>{player.removeEventListener('seeked',onseek);try{await mpPose.send({image:player});}catch{}};
      player.addEventListener('seeked',onseek); try{player.currentTime=t;}catch{player.removeEventListener('seeked',onseek);mpPose.onResults=prev;resolve();}
      setTimeout(()=>{mpPose.onResults=prev;resolve();},1500);
    });
  }

  let decided=viewSel.value==='auto'
    ? Object.entries(viewCounts).sort((a,b)=>b[1]-a[1])[0]?.[0]||'front'
    : viewSel.value;

  if (covered < 5 && viewSel.value==='auto') decided = await probeView(v);

  const coverage=covered/Math.max(sampled,1);
  const ratio = valid/Math.max(covered||1,1);
  let softWarn='';
  if((coverage<MIN_COVERAGE&&valid<MIN_PASS_FRAMES) || ratio<MIN_PASS_RATIO){
    softWarn='‚ö†Ô∏è Nh·∫≠n di·ªán kh√≥ (√≠t khung nh√¨n r√µ). K·∫øt qu·∫£ c√≥ th·ªÉ k√©m ·ªïn ƒë·ªãnh.';
  }

  const summary=summarizeFeatures();
  const tile=Math.round(ratio*100), sai=Math.max(0,covered-valid), dung=Math.max(0,valid);

  const bank={
    xuatphat:{loi:["G·∫≠p g·ªëi ch∆∞a ƒë√∫ng","Tay ch·ªëng y·∫øu","Th√¢n nghi√™ng nhi·ªÅu"],chanthuong:["C·ªï tay","G·ªëi","Vai"],goiy:["Gi·ªØ th√¢n th·∫≥ng khi xu·∫•t ph√°t","TƒÉng ph·∫£n x·∫° g·ªëi & m≈©i ch√¢n","Xu·∫•t ph√°t t·∫°i ch·ªó gi·ªØ 5s"]},
    nhaycao:{loi:["B∆∞·ªõc ch·∫°y ƒë√† ch·∫≠m","G·ªëi kh√¥ng n√¢ng cao","L∆∞ng qua x√† ch∆∞a cong"],chanthuong:["G·ªëi","C·ªôt s·ªëng th·∫Øt l∆∞ng"],goiy:["Ch·∫°y ƒë√† + nh·∫£y 1 ch√¢n","K√©o gi√£n c·ªôt s·ªëng","B·∫≠t nh·∫£y n√¢ng g·ªëi"]},
    nemta:{loi:["H·∫° vai khi xoay","Ch∆∞a t·ªëi ∆∞u l·ª±c ch√¢n"],chanthuong:["C·ªï tay","Vai","L∆∞ng"],goiy:["TƒÉng s·ª©c m·∫°nh xoay th√¢n","Ph·ªëi h·ª£p ch√¢n‚Äìtr·ª•c‚Äìƒë·∫©y t·∫°","Xoay ch·∫≠m gi·ªØ vai"]}
  };
  const sport=v.sportTag||sportSel.value;
  let loi=[],chan=[],goiy=[],xeploai='TRUNG B√åNH';
  if(tile===100) xeploai='HO√ÄN H·∫¢O';
  else if(tile>=90){xeploai='T·ªêT';loi=bank[sport].loi.slice(0,1);chan=bank[sport].chanthuong.slice(0,1);goiy=bank[sport].goiy.slice(0,1);}
  else if(tile>=70){xeploai='KH√Å';loi=bank[sport].loi.slice(0,2);chan=bank[sport].chanthuong.slice(0,2);goiy=bank[sport].goiy.slice(0,2);}
  else {xeploai='TRUNG B√åNH';loi=bank[sport].loi;chan=bank[sport].chanthuong;goiy=bank[sport].goiy;}

  results[v.id]={id:v.id,name:v.name,sport,view:decided,tile,sai,dung,features:summary,xeploai,loi,chanthuong:chan,goiy,note:softWarn};
  localStorage.setItem('thethaott_results',JSON.stringify(results));
  setProgress(100,'Xong');
  showInfo(results[v.id]); renderChart(); renderVideoList();
}

/* ========================== UPLOAD / CLEAR ========================== */
videoUpload.onchange=(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const id=uidFromName(f.name+'_'+Date.now());
  let tag=''; const ln=f.name.toLowerCase(); if(ln.includes('xuat'))tag='xuatphat'; else if(ln.includes('nhay'))tag='nhaycao'; else if(ln.includes('nem'))tag='nemta'; if(!tag) tag=sportSel.value;
  const url=URL.createObjectURL(f);
  const v={id,name:f.name,url,sportTag:tag};
  uploadedVideos.push(v);
  upsertSavedVideo({id,name:f.name,sport:tag,ts:Date.now()});
  renderVideoList();
  openVideo(v);
};

clearBtn.onclick=()=>{
  if(!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu (k·∫øt qu·∫£ & l·ªãch s·ª≠)?')) return;
  localStorage.removeItem('thethaott_results'); results={}; renderChart();
  savedVideos=[]; persistVideos();
  uploadedVideos.forEach(v=>v.url&&URL.revokeObjectURL(v.url)); uploadedVideos=[];
  renderVideoList(); player.src=''; infoEl.textContent='Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.'; currentVideo=null;
};

sportSel.onchange=()=>{ renderVideoList(); renderChart(); };

/* ========================== EXPORT ========================== */
exportJsonBtn.onclick=()=>{
  if(!currentVideo){alert('Ch∆∞a c√≥ video.');return;}
  const payload={meta:{videoId:currentVideo.id,name:currentVideo.name,sport:currentVideo.sportTag||sportSel.value},time:featTime,angles:featAngles,velocity:featVel,summary:results[currentVideo.id]?.features||summarizeFeatures()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}),url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url;a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.json`;a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
};
exportCsvBtn.onclick=()=>{
  if(!currentVideo){alert('Ch∆∞a c√≥ video.');return;}
  const keys=['kneeL','kneeR','hipL','hipR','elbowL','elbowR','shoulderL','shoulderR','torso'];
  const header=['t',...keys,...keys.map(k=>'v_'+k)], rows=[header.join(',')];
  for(let i=0;i<featTime.length;i++){const a=featAngles[i]||{},v=featVel[i]||{};rows.push([featTime[i].toFixed(3),...keys.map(k=>a[k]??''),...keys.map(k=>v[k]??'')].join(','));}
  const blob=new Blob([rows.join('\n')],{type:'text/csv'}),url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url;a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.csv`;a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
};

/* ========================== BOOT ========================== */
runtimeFromSaved();
renderVideoList();
renderChart();
</script>
</body>
</html>
