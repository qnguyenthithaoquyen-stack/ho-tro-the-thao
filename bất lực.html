<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phân tích tư thế cho VĐV</title>
  <link rel="icon" href="data:," />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Nạp dạng GLOBAL (để auto-detect dùng được). Nếu bạn dùng ESM thì bỏ 2 script này và xem chú thích trong JS. -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.js"></script>
  <style>
    :root{
      --bg:#eef7f7; --bg2:#ffffff;
      --card:#ffffff; --border:#d7e9ec;
      --text:#0f2b34; --muted:#6c8b93;
      --teal:#11a2a0; --teal-2:#0d8f8d; --teal-3:#e8fbfb;
      --ok:#1fa97a; --warn:#e88a00; --danger:#dd3146;
      --radius:14px; --pad:16px; --shadow:0 10px 28px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',system-ui,Arial,sans-serif;
      color:var(--text); background:linear-gradient(180deg,var(--bg),#e6f2f2 45%,#eaf7f7 100%);
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .bar{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:12px 16px; display:flex; gap:12px; align-items:center; box-shadow:var(--shadow)
    }
    .bar h1{font-size:18px;margin:0 12px 0 0}
    .tagline{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px; border:1px solid var(--border);
      background:#f8fffe; color:var(--text); cursor:pointer; font-weight:600;
      transition:.15s; text-decoration:none
    }
    .btn:hover{background:#f0fbfa}
    .btn.primary{background:var(--teal); color:#fff; border-color:var(--teal)}
    .btn.primary:hover{background:var(--teal-2)}
    .btn.warn{border-color:var(--danger); color:var(--danger); background:#fff}
    .btn.warn:hover{background:#fff0f2}
    .grid{
      display:grid; grid-template-columns:1fr 420px; gap:16px; margin-top:16px
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow)
    }
    .card h2{font-size:16px;margin:0 0 12px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select,input[type=file]{
      padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff; color:var(--text)
    }
    .pill{padding:6px 12px; border:1px solid var(--border); border-radius:999px; background:#fff}
    .video-box{position:relative;border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#000}
    video,canvas{display:block;width:100%;height:auto}
    .progress{display:flex;align-items:center;gap:8px;margin-top:8px}
    .barline{flex:1;height:10px;background:#e7f2f3;border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .barline>span{display:block;height:100%;width:0;background:var(--ok);transition:width .25s}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .li{
      display:flex;align-items:center;justify-content:space-between; gap:8px;
      padding:10px 12px;border:1px solid var(--border); border-radius:12px; background:#fff
    }
    .badge{padding:4px 10px;border-radius:999px;background:#edf9f4;border:1px solid #cbeede;color:#0b6b52;font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    .panel{border:1px dashed var(--border); background:#fbffff; border-radius:12px; padding:12px}
    .good{color:var(--ok)} .warnc{color:var(--warn)} .bad{color:var(--danger)}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="bar">
      <h1>Phân tích tư thế cho VĐV</h1>
      <div class="tagline">Tải video, chạy MediaPipe, so khớp với khung chuẩn theo môn &amp; góc quay.</div>
      <div class="spacer"></div>
      <a class="btn" id="backBtn">← Bảng điều khiển</a>
      <button class="btn" id="exportFeatJsonBtn">Xuất features (.json)</button>
      <button class="btn" id="exportFeatCsvBtn">Xuất (.csv)</button>
      <button class="btn primary" id="exportReportBtn">Xuất báo cáo</button>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2>Trình phát & Điều khiển</h2>
        <div class="row">
          <div class="pill">
            <div class="muted" style="font-size:12px">Môn thể thao</div>
            <select id="sportSel">
              <option value="xuatphat">Xuất phát</option>
              <option value="nhaycao">Nhảy cao</option>
              <option value="nemta">Ném tạ</option>
            </select>
          </div>
          <div class="pill">
            <div class="muted" style="font-size:12px">Góc quay</div>
            <select id="viewSel">
              <option value="auto">Tự động</option>
              <option value="front">FRONT</option>
              <option value="left">LEFT</option>
              <option value="right">RIGHT</option>
              <option value="back">BACK</option>
            </select>
          </div>
          <div class="pill">
            <div class="muted" style="font-size:12px">Tải video (.mp4, .mov)</div>
            <input id="fileInput" type="file" accept="video/*">
          </div>
          <button class="btn primary" id="analyzeBtn">Phân tích</button>
          <button class="btn" id="reanalyzeBtn">Phân tích lại</button>
          <button class="btn warn" id="clearBtn">Xóa dữ liệu</button>
        </div>

        <div class="video-box" style="margin-top:12px">
          <video id="player" controls playsinline crossorigin="anonymous" muted></video>
          <canvas id="overlay"></canvas>
        </div>
        <div class="progress" id="progRow" style="display:none">
          <div class="barline"><span id="progBar"></span></div>
          <div class="muted" id="progText">0%</div>
        </div>

        <div class="muted" style="margin-top:14px">Lịch sử video (lọc theo môn)</div>
        <div class="list" id="history"></div>
      </div>

      <!-- Right -->
      <div class="card">
        <h2>Thông tin phân tích</h2>
        <div class="panel" id="infoPanel">Chưa có video được chọn.</div>
        <h2 style="margin-top:16px">Thống kê tỉ lệ đúng</h2>
        <div style="height:260px"><canvas id="chartCanvas"></canvas></div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   AUTODETECT MEDIAPIPE POSE
   =========================== */
// Nếu bạn muốn dùng chuẩn ESM: import { Pose } from '.../pose.js' (type="module")
// và gán window.Pose = Pose; – lúc đó getPoseCtor vẫn hoạt động.
function getPoseCtor(){
  if (typeof window.Pose === 'function') return window.Pose;            // ESM gán global
  if (window.pose && typeof window.pose.Pose === 'function') return window.pose.Pose; // global script
  if (window.mp && typeof window.mp.Pose === 'function') return window.mp.Pose;       // namespace khác
  return null;
}
let mpPose = null;
function ensurePose(){
  if (mpPose) return mpPose;
  const PoseCtor = getPoseCtor();
  if(!PoseCtor){
    alert('Không tìm thấy MediaPipe Pose. Kiểm tra thẻ <script> nạp pose.js!');
    throw new Error('Pose constructor not found');
  }
  mpPose = new PoseCtor({
    locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
  });
  mpPose.setOptions({
    modelComplexity:1, smoothLandmarks:true,
    enableSegmentation:false,
    minDetectionConfidence:0.45, minTrackingConfidence:0.45
  });
  // cập nhật landmarks
  mpPose.onResults((r)=>{ if(r && r.poseLandmarks) lastPoseLandmarks = r.poseLandmarks; });
  return mpPose;
}

/* ==============
   UI & STATE
   ============== */
const player = document.getElementById('player');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');

const sportSel = document.getElementById('sportSel');
const viewSel  = document.getElementById('viewSel');
const fileInput= document.getElementById('fileInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const reanalyzeBtn = document.getElementById('reanalyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const historyEl = document.getElementById('history');
const infoPanel = document.getElementById('infoPanel');
const progRow = document.getElementById('progRow');
const progBar = document.getElementById('progBar');
const progText = document.getElementById('progText');
const backBtn = document.getElementById('backBtn');

const chartCanvas = document.getElementById('chartCanvas');
let chart=null;

let lastPoseLandmarks=null;
let uploaded = [];      // {id,name,url,sportTag, file}
let results = JSON.parse(localStorage.getItem('thethaott_results')||'{}');
let current=null;

/* ==========
   HELPERS
   ========== */
function uid(name){ let h=2166136261; for(let c of name) {h^=c.charCodeAt(0);h+= (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);} return 'v_'+(h>>>0);}
function setProgress(p,t){ progRow.style.display='flex'; progBar.style.width=Math.min(100,Math.max(0,p))+'%'; progText.textContent=t||`${Math.round(p)}%`; if(p>=100){ setTimeout(()=>progRow.style.display='none',400); } }
function save(){ localStorage.setItem('thethaott_results',JSON.stringify(results)); }
function renderHistory(){
  const s = sportSel.value;
  historyEl.innerHTML='';
  uploaded.filter(v=> (v.sportTag===s)||(v.name||'').toLowerCase().includes(s==='xuatphat'?'xuat':'nhaycao'?'nhay':'nem'))
    .forEach(v=>{
      const li=document.createElement('div'); li.className='li';
      li.innerHTML=`<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><strong>${v.name}</strong><div class="muted" style="font-size:12px">${v.sportTag}</div></div>
        <div class="row">
          ${results[v.id]?`<span class="badge">Đã phân tích</span>`:''}
          <button class="btn" onclick="openVideo('${v.id}')">Xem</button>
          <button class="btn" onclick="analyze('${v.id}',true)">Phân tích lại</button>
          <button class="btn warn" onclick="delVideo('${v.id}')">Xóa</button>
        </div>`;
      historyEl.appendChild(li);
    });
}
function renderChart(){
  const s = sportSel.value;
  const keys = Object.keys(results).filter(k=>results[k].sport===s);
  const labels = keys.map(k=>results[k].name);
  const data = keys.map(k=>results[k].tile);
  if(chart) chart.destroy();
  chart = new Chart(chartCanvas.getContext('2d'),{
    type:'bar',
    data:{ labels, datasets:[{label:'Tỉ lệ đúng (%)', data, backgroundColor:'#11a2a099', borderColor:'#11a2a0'}] },
    options:{ responsive:true, scales:{ y:{min:0,max:110} }, plugins:{legend:{display:false}} }
  });
}
function showInfo(res){
  if(!res){ infoPanel.textContent='Chưa có video được chọn.'; return; }
  infoPanel.innerHTML = `
    <div><strong>${res.name}</strong></div>
    <div class="muted">Góc: <strong>${res.view?.toUpperCase()||'AUTO'}</strong> — Tỉ lệ đúng: <span class="${res.tile>=90?'good':res.tile>=70?'warnc':'bad'}"><strong>${res.tile}%</strong></span> (Đúng: ${res.dung}, Sai: ${res.sai})</div>
    <hr style="border:none;border-top:1px dashed var(--border);margin:8px 0">
    ${res.tile<100?`
      <div><strong>❌ Lỗi thường gặp:</strong><ul>${res.loi.map(x=>`<li>${x}</li>`).join('')}</ul></div>
      <div><strong>⚠️ Nguy cơ chấn thương:</strong><ul>${res.chanthuong.map(x=>`<li>${x}</li>`).join('')}</ul></div>
      <div><strong>💡 Gợi ý:</strong><ul>${res.goiy.map(x=>`<li>${x}</li>`).join('')}</ul></div>
    `:`<div class="good"><strong>🌟 Hoàn hảo!</strong> Không phát hiện lỗi.</div>`}
  `;
}

/* =========================
   RULES & GEOMETRY (tóm lược)
   ========================= */
const BO = {
  xuatphat:{loi:["Gập gối chưa đúng góc","Tay chống yếu","Thân nghiêng nhiều"], chanthuong:["Cổ tay","Gối","Vai"], goiy:["Giữ thân thẳng khi xuất phát","Tăng phản xạ gối & mũi chân","Xuất phát tại chỗ giữ 5s"]},
  nhaycao :{loi:["Chạy đà chưa đủ tốc","Gối không nâng cao","Lưng qua xà chưa đúng"], chanthuong:["Gối","Cột sống thắt lưng"], goiy:["Chạy đà + nhảy 1 chân","Kéo giãn cột sống","Bật nhảy nâng gối"]},
  nemta   :{loi:["Hạ thấp vai khi xoay","Chưa tối ưu lực chân"], chanthuong:["Cổ tay","Vai","Lưng"], goiy:["Tăng sức mạnh cơ xoay","Phối hợp chân-trục-đẩy tạ","Xoay chậm giữ vai cố định"]}
};
const BASE = {
  xuatphat:[
    {name:'Gối (trái/phải)', joints:['kneeL','kneeR'], want:100, tol:20, anySide:true},
    {name:'Hông (trái/phải)', joints:['hipL','hipR'], want:120, tol:25, anySide:true},
    {name:'Thân nghiêng', joints:['torso'], want:45, tol:15},
    {name:'Khuỷu tay', joints:['elbowL','elbowR'], want:90, tol:25, anySide:true}
  ],
  nhaycao:[
    {name:'Gối giậm', joints:['kneeL','kneeR'], want:150, tol:20, anySide:true},
    {name:'Hông mở', joints:['hipL','hipR'], want:160, tol:20, anySide:true},
    {name:'Thân nghiêng', joints:['torso'], want:20, tol:15},
    {name:'Vai', joints:['shoulderL','shoulderR'], want:160, tol:25, anySide:true}
  ],
  nemta:[
    {name:'Gối', joints:['kneeL','kneeR'], want:100, tol:25, anySide:true},
    {name:'Hông', joints:['hipL','hipR'], want:120, tol:25, anySide:true},
    {name:'Khuỷu tay', joints:['elbowL','elbowR'], want:100, tol:25, anySide:true},
    {name:'Vai', joints:['shoulderL','shoulderR'], want:90, tol:25, anySide:true},
    {name:'Thân nghiêng', joints:['torso'], want:30, tol:15}
  ]
};
const VIEW_RULES = { xuatphat:{front:BASE.xuatphat, back:BASE.xuatphat, left:[
  {...BASE.xuatphat[0], tol:22},{...BASE.xuatphat[1], tol:28},{...BASE.xuatphat[2], tol:18}
], right:[
  {...BASE.xuatphat[0], tol:22},{...BASE.xuatphat[1], tol:28},{...BASE.xuatphat[2], tol:18}
]},
  nhaycao:{front:BASE.nhaycao, back:BASE.nhaycao, left:[
    {...BASE.nhaycao[0], tol:22},{...BASE.nhaycao[1], tol:22},{...BASE.nhaycao[2], tol:18}
  ], right:[
    {...BASE.nhaycao[0], tol:22},{...BASE.nhaycao[1], tol:22},{...BASE.nhaycao[2], tol:18}
  ]},
  nemta:{front:BASE.nemta, back:BASE.nemta, left:[
    {...BASE.nemta[1], tol:28},{...BASE.nemta[3], tol:28},{...BASE.nemta[2], tol:28},{...BASE.nemta[4], tol:18}
  ], right:[
    {...BASE.nemta[1], tol:28},{...BASE.nemta[3], tol:28},{...BASE.nemta[2], tol:28},{...BASE.nemta[4], tol:18}
  ]}
};
const THRESH = {xuatphat:.6, nhaycao:.5, nemta:.6};

function deg(a,b,c){ const abx=a.x-b.x, aby=a.y-b.y; const cbx=c.x-b.x, cby=c.y-b.y;
  const dot=abx*cbx+aby*cby; const mag=Math.sqrt((abx*abx+aby*aby)*(cbx*cbx+cby*cby)); if(!mag) return 0;
  let co=dot/mag; co=Math.max(-1,Math.min(1,co)); return Math.acos(co)*180/Math.PI; }
function torsoDeg(lm){ const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24]; if(!(lS&&rS&&lH&&rH)) return 0;
  const s={x:(lS.x+rS.x)/2, y:(lS.y+rS.y)/2}; const h={x:(lH.x+rH.x)/2, y:(lH.y+rH.y)/2};
  const dx=s.x-h.x, dy=s.y-h.y; return Math.atan2(Math.abs(dy),Math.abs(dx))*180/Math.PI; }
function extractAngles(lm){
  const A={};
  if(lm[23]&&lm[25]&&lm[27]) A.kneeL=deg(lm[23],lm[25],lm[27]);
  if(lm[24]&&lm[26]&&lm[28]) A.kneeR=deg(lm[24],lm[26],lm[28]);
  if(lm[11]&&lm[23]&&lm[25]) A.hipL=deg(lm[11],lm[23],lm[25]);
  if(lm[12]&&lm[24]&&lm[26]) A.hipR=deg(lm[12],lm[24],lm[26]);
  if(lm[11]&&lm[13]&&lm[15]) A.elbowL=deg(lm[11],lm[13],lm[15]);
  if(lm[12]&&lm[14]&&lm[16]) A.elbowR=deg(lm[12],lm[14],lm[16]);
  if(lm[13]&&lm[11]&&lm[23]) A.shoulderL=deg(lm[13],lm[11],lm[23]);
  if(lm[14]&&lm[12]&&lm[24]) A.shoulderR=deg(lm[14],lm[12],lm[24]);
  A.torso=torsoDeg(lm);
  return A;
}
function detectView(lm){
  const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24];
  if(!(lS&&rS&&lH&&rH)) return 'front';
  const sMid={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2}; const hMid={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};
  const torsoLen=Math.hypot(sMid.x-hMid.x, sMid.y-hMid.y); const shoulderW=Math.abs(rS.x-lS.x);
  const r=shoulderW/(torsoLen||1); if(r<0.55){ return (rS.x>lS.x)?'right':'left'; } return 'front';
}
function rulesFor(sport,view){ const G=VIEW_RULES[sport]; if(!G) return BASE[sport]||[]; return G[view]||BASE[sport]||[] }
function passFrame(angles,sport,view){ const R=rulesFor(sport,view); let ok=0;
  R.forEach(r=>{
    if(r.anySide){ for(const k of r.joints){ const v=angles[k]; if(typeof v==='number' && Math.abs(v-r.want)<=r.tol){ ok++; break; } }
    } else { const k=r.joints[0]; const v=angles[k]; if(typeof v==='number'&&Math.abs(v-r.want)<=r.tol) ok++; }
  });
  const sc=R.length? ok/R.length:0; return {pass: sc >= (THRESH[sport]??.6), total:R.length, ok};
}
function classify(tile,sport){
  const b=BO[sport];
  if(tile===100) return {loi:[],chanthuong:[],goiy:[],dongvien:'🌟 Xuất sắc!',xeploai:'HOÀN HẢO',ketluan:'Giữ phong độ'};
  if(tile>=90)  return {loi:b.loi.slice(0,1),chanthuong:b.chanthuong.slice(0,1),goiy:b.goiy.slice(0,1),dongvien:'🔥 Rất tốt!',xeploai:'TỐT',ketluan:'Giữ vững phong độ'};
  if(tile>=70)  return {loi:b.loi.slice(0,2),chanthuong:b.chanthuong.slice(0,2),goiy:b.goiy.slice(0,2),dongvien:'👍 Khá tốt',xeploai:'KHÁ',ketluan:'Cần hoàn thiện'};
  return {loi:b.loi,chanthuong:b.chanthuong,goiy:b.goiy,dongvien:'⚠️ Cần cố gắng hơn',xeploai:'TRUNG BÌNH',ketluan:'Tập trung luyện thêm'};
}

/* =======================
   ANALYZE MAIN
   ======================= */
async function analyze(id,force=false){
  const v = uploaded.find(x=>x.id===id) || current;
  if(!v){ alert('Chưa có video.'); return; }
  if(results[v.id] && !force){ showInfo(results[v.id]); return; }

  ensurePose(); // tạo mpPose

  // set source
  if(player.src !== v.url){ player.src = v.url; await new Promise(r=>{ if(player.readyState>=1) return r(); player.addEventListener('loadedmetadata',()=>r(),{once:true}); setTimeout(r,1200); }); }
  player.pause();

  // prepare overlay
  const dpr = window.devicePixelRatio||1;
  overlay.width = Math.round((player.videoWidth||640)*dpr);
  overlay.height= Math.round((player.videoHeight||360)*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // sampling
  const total = 60;
  const dur = player.duration||3;
  const step = Math.max(0.08, dur/total);
  let valid=0, sampled=0;
  const viewChoice = viewSel.value;
  const viewCount = {front:0,left:0,right:0,back:0};

  for(let i=0;i<total;i++){
    const t = Math.min(i*step, Math.max(0,(player.duration||dur)-0.05));
    setProgress((i/total)*100);
    await new Promise(resolve=>{
      const onSeeked = async ()=>{
        player.removeEventListener('seeked',onSeeked);
        try{ await mpPose.send({image:player}); }catch(e){}
        // read landmarks (từ onResults đã set)
        if(lastPoseLandmarks && lastPoseLandmarks.length){
          const w=player.videoWidth||640, h=player.videoHeight||360;
          const lm=lastPoseLandmarks.map(l=>({x:l.x*w,y:l.y*h}));
          const autoView = detectView(lm); viewCount[autoView] = (viewCount[autoView]||0)+1;
          const useView = (viewChoice==='auto')?autoView:viewChoice;
          const A = extractAngles(lm); const chk = passFrame(A, v.sportTag||sportSel.value, useView);
          if(chk.pass) valid++;
        }
        sampled++;
        resolve();
      };
      player.addEventListener('seeked',onSeeked);
      try{ player.currentTime = t; }catch(e){ player.removeEventListener('seeked',onSeeked); resolve(); }
      setTimeout(()=>{ try{ player.removeEventListener('seeked',onSeeked);}catch{}; resolve(); }, 1500);
    });
  }
  setProgress(100,'Xong');

  let decided = viewChoice;
  if(decided==='auto'){ decided = Object.entries(viewCount).sort((a,b)=>b[1]-a[1])[0]?.[0]||'front'; }

  const tile = Math.round((valid/Math.max(1,sampled))*100);
  const extra = classify(tile, v.sportTag||sportSel.value);
  const out = {
    id:v.id, name:v.name, sport:v.sportTag||sportSel.value,
    dung:valid, sai: Math.max(0, sampled-valid), tile, view:decided,
    loi:extra.loi, chanthuong:extra.chanthuong, goiy:extra.goiy,
    dongvien:extra.dongvien, xeploai:extra.xeploai, ketluan:extra.ketluan
  };
  results[v.id]=out; save();
  showInfo(out); renderChart();

  // === Hook Firestore của bạn (nếu dùng) ===
  // const athleteId = new URLSearchParams(location.search).get('athleteId');
  // if(athleteId){ saveAchievementToFirestore(out, athleteId); saveInjuryWarningsToFirestore(out, athleteId); }
}

/* ======================
   DRAW OVERLAY LIVE
   ====================== */
function drawOverlay(){
  const w = overlay.width/(window.devicePixelRatio||1);
  const h = overlay.height/(window.devicePixelRatio||1);
  ctx.clearRect(0,0,w,h);
  if(!lastPoseLandmarks) return;
  const lm = lastPoseLandmarks.map(l=>({x:l.x*w, y:l.y*h}));
  const conns = (window.POSE_CONNECTIONS || (window.Pose && Pose.POSE_CONNECTIONS) || (window.pose && window.pose.POSE_CONNECTIONS));
  ctx.strokeStyle = '#11a2a0'; ctx.lineWidth=2.5;
  if(conns){ conns.forEach(([a,b])=>{ const p=lm[a], q=lm[b]; if(p&&q){ ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke(); } }); }
  lm.forEach(p=>{ ctx.fillStyle='#0dc1bf'; ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill(); });
}
let raf=null, lastSend=0;
function loop(){
  if(player.paused||player.ended){ if(raf) cancelAnimationFrame(raf); return; }
  const now=performance.now(); if(now-lastSend>45){ try{ ensurePose().send({image:player}); }catch(e){} lastSend=now; }
  drawOverlay(); raf = requestAnimationFrame(loop);
}
player.onplay = ()=> loop();
player.onended= ()=> { if(raf) cancelAnimationFrame(raf); };

/* ======================
   EVENTS
   ====================== */
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const id = uid(f.name+'_'+Date.now()); const url = URL.createObjectURL(f);
  let tag=''; const ln=f.name.toLowerCase();
  if(ln.includes('xuat')) tag='xuatphat';
  else if(ln.includes('nhay')) tag='nhaycao';
  else if(ln.includes('nem')) tag='nemta';
  if(!tag) tag = sportSel.value;
  const v={id,name:f.name,url,sportTag:tag,file:f}; uploaded.push(v);
  openVideo(id);
  renderHistory();
});
function openVideo(id){
  const v = uploaded.find(x=>x.id===id);
  if(!v) return;
  current=v; player.src = v.url; player.muted=false; player.play().then(()=>player.pause()).catch(()=>{});
  showInfo(results[id]); renderChart();
}
function delVideo(id){
  const idx=uploaded.findIndex(x=>x.id===id); if(idx>-1){
    try{ URL.revokeObjectURL(uploaded[idx].url);}catch{}
    uploaded.splice(idx,1);
  }
  if(results[id]){ delete results[id]; save(); }
  if(current && current.id===id){ player.src=''; current=null; infoPanel.textContent='Chưa có video được chọn.'; }
  renderHistory(); renderChart();
}
analyzeBtn.onclick = ()=> current? analyze(current.id,false): alert('Hãy chọn video.');
reanalyzeBtn.onclick = ()=> current? analyze(current.id,true): alert('Hãy chọn video.');
clearBtn.onclick = ()=>{
  if(!confirm('Xóa toàn bộ dữ liệu trong phiên hiện tại?')) return;
  uploaded.forEach(v=>{ try{URL.revokeObjectURL(v.url);}catch{} });
  uploaded=[]; results={}; save(); player.src=''; current=null; renderHistory(); renderChart(); infoPanel.textContent='Đã xóa.';
};
sportSel.onchange = ()=>{ renderHistory(); renderChart(); };
backBtn.onclick = ()=>{
  // Nếu có file Bảng điều khiển thì đi tới, nếu không thì quay lại lịch sử
  fetch('bangdieukhien.html',{method:'HEAD'}).then(r=>{
    if(r.ok) location.href='bangdieukhien.html'; else history.back();
  }).catch(()=>history.back());
};

/* ======================
   EXPORT
   ====================== */
document.getElementById('exportReportBtn').onclick = ()=>{
  if(!current||!results[current.id]){ alert('Chưa có kết quả để xuất.'); return; }
  const data = results[current.id];
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`${data.name.replace(/\.[^/.]+$/,'')}_report.json`; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),800);
};
document.getElementById('exportFeatJsonBtn').onclick = ()=>{
  if(!current){ alert('Chưa có video.'); return; }
  const payload = { meta:{id:current.id,name:current.name,sport:current.sportTag||sportSel.value} };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`${current.name.replace(/\.[^/.]+$/,'')}_features.json`; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),800);
};
document.getElementById('exportFeatCsvBtn').onclick = ()=>{
  if(!current){ alert('Chưa có video.'); return; }
  const rows=[['t','kneeL','kneeR','hipL','hipR','elbowL','elbowR','shoulderL','shoulderR','torso'].join(',')];
  const blob = new Blob([rows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=`${current.name.replace(/\.[^/.]+$/,'')}_features.csv`; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),800);
};

/* initial render */
renderHistory(); renderChart();
</script>
</body>
</html>
