<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ph√¢n t√≠ch t∆∞ th·∫ø cho VƒêV</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0c1b22;
    --card:#0f2530;
    --muted:#a8c3cc;
    --text:#e7f3f6;
    --teal:#10b7b7;
    --teal-2:#0aa3a3;
    --green:#28c08b;
    --red:#f66;
    --yellow:#f3b94e;
    --border: #173845;
    --chip:#0b2a35;
    --shadow: 0 8px 30px rgba(0,0,0,.25);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Inter',system-ui,Arial,sans-serif;
    background: radial-gradient(1200px 600px at 10% -10%, #0e3640 0%, #0c1b22 55%) fixed;
    color:var(--text);
  }
  .wrap{max-width:1220px; margin:22px auto; padding:0 16px;}
  .topbar{
    display:flex; align-items:center; gap:10px; padding:14px 16px;
    border:1px solid var(--border); background:linear-gradient(180deg,#0f2733, #0f2230);
    border-radius:12px; box-shadow:var(--shadow); position:sticky; top:10px; z-index:5;
  }
  .topbar h1{margin:0; font-size:18px; font-weight:700}
  .topbar small{display:block; color:var(--muted); font-weight:500}
  .space{flex:1}
  .btn{
    background:#10313d; color:var(--text); border:1px solid var(--border);
    border-radius:999px; padding:9px 14px; font-weight:600; cursor:pointer;
    transition:.2s; display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{background:#133c49}
  .btn-primary{background:var(--teal); border-color:transparent; color:#072427}
  .btn-primary:hover{background:var(--teal-2)}
  .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; margin-top:16px}
  .card{
    background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px;
  }
  .card h3{margin:0 0 12px 0; font-size:16px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  select, input[type=file]{
    appearance:none; background:#0e3040; color:var(--text); border:1px solid var(--border);
    padding:10px 12px; border-radius:10px; min-width:150px;
  }
  .badge{background:#0b2a35; color:var(--muted); border:1px solid var(--border);
    border-radius:999px; padding:5px 9px; font-weight:600}
  video{width:100%; border-radius:12px; border:1px solid var(--border); background:#000}
  .progress{height:8px; background:#0a2a35; border:1px solid var(--border);
    border-radius:999px; overflow:hidden; margin-top:12px}
  .progress>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,#31dbc6,#27c4a9)}
  .list{margin-top:14px}
  .item{display:flex; align-items:center; justify-content:space-between; gap:8px;
    border:1px solid var(--border); background:#0e2733; padding:10px 12px; border-radius:12px; margin-top:8px}
  .item .left{display:flex; align-items:center; gap:10px}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--muted);
    padding:3px 8px; border-radius:999px; font-size:12px; font-weight:600}
  .btn-ghost{background:#0f2a35}
  .panel{
    min-height:160px; border:1px dashed #1a4958; border-radius:12px; padding:12px;
    background:linear-gradient(180deg,#0d2430 0%, #0c2330 100%);
  }
  ul{margin:6px 0 0 18px; padding:0}
  hr{border:none; border-top:1px solid var(--border); margin:12px 0}
  .muted{color:var(--muted)}
  canvas{max-width:100%}
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div>
        <h1>Ph√¢n t√≠ch t∆∞ th·∫ø cho VƒêV</h1>
        <small>T·∫£i video, ch·∫°y MediaPipe, so kh·ªõp v·ªõi khung chu·∫©n theo m√¥n &amp; g√≥c quay.</small>
      </div>
      <div class="space"></div>
      <button class="btn btn-ghost" id="backBtn">‚Üê B·∫£ng ƒëi·ªÅu khi·ªÉn</button>
      <button class="btn btn-ghost" id="exportJson">Xu·∫•t features (.json)</button>
      <button class="btn btn-ghost" id="exportCsv">Xu·∫•t (.csv)</button>
      <button class="btn btn-primary" id="exportReport">Xu·∫•t b√°o c√°o</button>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h3>Tr√¨nh ph√°t & ƒêi·ªÅu khi·ªÉn</h3>

        <div class="row" style="margin-bottom:10px">
          <div class="row">
            <span class="badge">M√¥n th·ªÉ thao</span>
            <select id="sportSel">
              <option value="xuatphat">Xu·∫•t ph√°t</option>
              <option value="nhaycao">Nh·∫£y cao</option>
              <option value="nemta">N√©m t·∫°</option>
            </select>
          </div>
          <div class="row">
            <span class="badge">G√≥c quay</span>
            <select id="viewSel">
              <option value="auto">T·ª± ƒë·ªông</option>
              <option value="front">FRONT</option>
              <option value="left">LEFT</option>
              <option value="right">RIGHT</option>
              <option value="back">BACK</option>
            </select>
          </div>
          <div class="row">
            <span class="badge">T·∫£i video (.mp4, .mov)</span>
            <input id="fileInput" type="file" accept="video/*" multiple />
          </div>
          <div class="space"></div>
          <button class="btn btn-primary" id="analyzeBtn">Ph√¢n t√≠ch</button>
          <button class="btn btn-ghost" id="reanalyzeBtn">Ph√¢n t√≠ch l·∫°i</button>
          <button class="btn btn-ghost" id="clearBtn">X√≥a d·ªØ li·ªáu</button>
        </div>

        <video id="player" controls playsinline muted></video>
        <div class="progress"><span id="bar"></span></div>

        <div class="list" id="history">
          <h3 style="margin-top:16px">L·ªãch s·ª≠ video (l·ªçc theo m√¥n)</h3>
          <!-- items render here -->
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3>Th√¥ng tin ph√¢n t√≠ch</h3>
        <div id="panel" class="panel">
          <span class="muted">Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.</span>
        </div>

        <h3 style="margin-top:16px">Th·ªëng k√™ t·ªâ l·ªá ƒë√∫ng</h3>
        <div class="panel">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>

    <p class="muted" style="text-align:center; margin:20px 0 10px">
      ¬© 2025 ‚Äî Demo giao di·ªán theo y√™u c·∫ßu. N·∫øu auto-view ƒëo√°n sai, h√£y ch·ªçn tay FRONT/LEFT/RIGHT/BACK.
    </p>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.js"></script>

  <script>
  /************** UI refs **************/
  const sportSel = document.getElementById('sportSel');
  const viewSel  = document.getElementById('viewSel');
  const fileInput= document.getElementById('fileInput');
  const player   = document.getElementById('player');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const reanalyzeBtn = document.getElementById('reanalyzeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const panel    = document.getElementById('panel');
  const bar      = document.getElementById('bar');
  const historyEl= document.getElementById('history');
  const exportReport = document.getElementById('exportReport');
  const exportJson = document.getElementById('exportJson');
  const exportCsv = document.getElementById('exportCsv');

  /************** State **************/
  let uploaded = [];           // [{id,name,url,sport}]
  let results = JSON.parse(localStorage.getItem('pose_results')||'{}');
  let current = null;          // video object
  let chart = null;

  // ng∆∞·ª°ng/khung chu·∫©n
  const PASS_THRESH = { xuatphat:0.5, nhaycao:0.45, nemta:0.5 }; // n·ªõi l·ªèng
  const SAMPLE_TOTAL = 90; // tƒÉng s·ªë khung l·∫•y m·∫´u

  // Khung chu·∫©n (ƒë√£ n·ªõi tol 2‚Äì4¬∞ so v·ªõi tr∆∞·ªõc)
  const RULES = {
    xuatphat:{
      base:[
        {name:'G·ªëi tr∆∞·ªõc', joints:['kneeL','kneeR'], want:100, tol:22, anySide:true},
        {name:'H√¥ng',      joints:['hipL','hipR'],  want:120, tol:24, anySide:true},
        {name:'Th√¢n nghi√™ng', joints:['torso'], want:45, tol:14},
        {name:'Khu·ª∑u tay tr·ª•', joints:['elbowL','elbowR'], want:90, tol:24, anySide:true}
      ],
      front:null, back:null,
      left:null, right:null
    },
    nhaycao:{
      base:[
        {name:'G·ªëi gi·∫≠m', joints:['kneeL','kneeR'], want:150, tol:22, anySide:true},
        {name:'H√¥ng m·ªü',  joints:['hipL','hipR'],  want:160, tol:22, anySide:true},
        {name:'Th√¢n nghi√™ng', joints:['torso'], want:20, tol:18},
        {name:'Vai vung', joints:['shoulderL','shoulderR'], want:160, tol:25, anySide:true}
      ]
    },
    nemta:{
      base:[
        {name:'G·ªëi', joints:['kneeL','kneeR'], want:100, tol:25, anySide:true},
        {name:'H√¥ng', joints:['hipL','hipR'],  want:120, tol:25, anySide:true},
        {name:'Khu·ª∑u tay', joints:['elbowL','elbowR'], want:100, tol:25, anySide:true},
        {name:'Vai', joints:['shoulderL','shoulderR'], want:90, tol:26, anySide:true},
        {name:'Th√¢n nghi√™ng', joints:['torso'], want:30, tol:18}
      ]
    }
  };

  /************** Helpers **************/
  function uid(name){ return 'v_'+(name+'_'+Date.now()).replace(/[^\w]+/g,''); }
  function setProgress(p){ bar.style.width = Math.max(0,Math.min(100,p))+'%'; }

  function renderHistory(){
    const sport = sportSel.value;
    const list = uploaded.filter(v => v.sport===sport);
    const root = document.createElement('div');
    list.forEach(v=>{
      const has = !!results[v.id];
      const item = document.createElement('div');
      item.className='item';
      item.innerHTML = `
        <div class="left">
          <span class="chip">${v.sport}</span>
          <strong>${v.name}</strong>
          ${has?`<span class="chip" style="color:#8ff2c9;border-color:#206c57">ƒê√£ ph√¢n t√≠ch</span>`:''}
        </div>
        <div class="row">
          <button class="btn btn-ghost" data-act="open">Xem</button>
          <button class="btn btn-ghost" data-act="rean">${has?'Ph√¢n t√≠ch l·∫°i':'Ph√¢n t√≠ch'}</button>
          <button class="btn btn-ghost" data-act="del" style="color:#ffb0b0;border-color:#4a1f26;background:#2b0f14">X√≥a</button>
        </div>`;
      item.querySelector('[data-act="open"]').onclick = ()=> openVideo(v);
      item.querySelector('[data-act="rean"]').onclick = ()=> { openVideo(v); analyze(true); };
      item.querySelector('[data-act="del"]').onclick = ()=>{
        try{URL.revokeObjectURL(v.url);}catch(e){}
        uploaded = uploaded.filter(x=>x.id!==v.id);
        delete results[v.id]; saveResults(); renderHistory(); renderChart(); if(current&&current.id===v.id){panel.innerHTML='<span class="muted">Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.</span>'; player.src='';}
      };
      root.appendChild(item);
    });
    const h = historyEl;
    h.innerHTML = '<h3 style="margin-top:16px">L·ªãch s·ª≠ video (l·ªçc theo m√¥n)</h3>';
    h.appendChild(root);
  }

  function saveResults(){ localStorage.setItem('pose_results', JSON.stringify(results)); }

  function renderPanel(res){
    if(!res){ panel.innerHTML='<span class="muted">Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.</span>'; return; }
    const html = `
      <div class="row" style="gap:10px;align-items:center;margin-bottom:8px">
        <strong>${res.name}</strong>
        <span class="chip">G√≥c: ${res.view.toUpperCase()}</span>
        <span class="chip" style="color:#9ff9d9;border-color:#1f6f58">T·ªâ l·ªá ƒë√∫ng: ${res.tile}%</span>
        <span class="chip">ƒê√∫ng: ${res.dung}</span>
        <span class="chip">Sai: ${res.sai}</span>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div style="flex:1; min-width:240px">
          <strong>L·ªói th∆∞·ªùng g·∫∑p</strong>
          <ul>${res.loi.map(x=>`<li>${x}</li>`).join('')}</ul>
        </div>
        <div style="flex:1; min-width:240px">
          <strong>Nguy c∆° ch·∫•n th∆∞∆°ng</strong>
          <ul>${res.chanthuong.map(x=>`<li>${x}</li>`).join('')}</ul>
        </div>
      </div>
      <div><strong>G·ª£i √Ω</strong><ul>${res.goiy.map(x=>`<li>${x}</li>`).join('')}</ul></div>
      <hr>
      <div class="muted">${res.dongvien}</div>
    `;
    panel.innerHTML = html;
  }

  function renderChart(){
    const sport = sportSel.value;
    const keys = Object.keys(results).filter(k=>results[k].sport===sport);
    const labels = keys.map(k=>results[k].name);
    const data = keys.map(k=>results[k].tile);
    if(chart) chart.destroy();
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[{label:'T·ªâ l·ªá ƒë√∫ng (%)', data, backgroundColor:'#19b6a8'}]},
      options:{
        scales:{ y:{beginAtZero:true, max:110, grid:{color:'#1a4958'}, ticks:{color:'#b8dbe4'}}, x:{ticks:{color:'#b8dbe4'}}},
        plugins:{ legend:{labels:{color:'#e6fbff'}}}
      }
    });
  }

  function openVideo(v){
    current = v; player.src = v.url; player.currentTime = 0;
    renderPanel(results[v.id]); renderChart();
  }

  /************** MediaPipe Pose **************/
  let mpPose = null, lastLm = null;
  function ensurePose(){
    if(mpPose) return mpPose;
    mpPose = new Pose.Pose({
      locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
    mpPose.setOptions({
      modelComplexity:1, smoothLandmarks:true, enableSegmentation:false,
      minDetectionConfidence:0.45, minTrackingConfidence:0.45
    });
    mpPose.onResults(res=>{
      if(res && res.poseLandmarks && res.poseLandmarks.length) lastLm = res.poseLandmarks;
    });
    return mpPose;
  }

  function deg(a,b,c){
    const abx=a.x-b.x, aby=a.y-b.y;
    const cbx=c.x-b.x, cby=c.y-b.y;
    const dot = abx*cbx + aby*cby;
    const mag = Math.sqrt((abx*abx+aby*aby)*(cbx*cbx+cby*cby)) || 1;
    let cs = Math.max(-1, Math.min(1, dot/mag));
    return Math.acos(cs)*180/Math.PI;
  }
  function torsoIncline(lm){
    const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24];
    if(!(lS&&rS&&lH&&rH)) return 0;
    const s={x:(lS.x+rS.x)/2, y:(lS.y+rS.y)/2};
    const h={x:(lH.x+rH.x)/2, y:(lH.y+rH.y)/2};
    const dx=s.x-h.x, dy=s.y-h.y;
    return Math.atan2(Math.abs(dy), Math.abs(dx))*180/Math.PI;
  }
  function extractAngles(lm){
    const a={};
    if(lm[23]&&lm[25]&&lm[27]) a.kneeL = deg(lm[23],lm[25],lm[27]);
    if(lm[24]&&lm[26]&&lm[28]) a.kneeR = deg(lm[24],lm[26],lm[28]);
    if(lm[11]&&lm[23]&&lm[25]) a.hipL  = deg(lm[11],lm[23],lm[25]);
    if(lm[12]&&lm[24]&&lm[26]) a.hipR  = deg(lm[12],lm[24],lm[26]);
    if(lm[11]&&lm[13]&&lm[15]) a.elbowL= deg(lm[11],lm[13],lm[15]);
    if(lm[12]&&lm[14]&&lm[16]) a.elbowR= deg(lm[12],lm[14],lm[16]);
    if(lm[13]&&lm[11]&&lm[23]) a.shoulderL = deg(lm[13],lm[11],lm[23]);
    if(lm[14]&&lm[12]&&lm[24]) a.shoulderR = deg(lm[14],lm[12],lm[24]);
    a.torso = torsoIncline(lm);
    return a;
  }
  function detectView(lm){
    const lS=lm[11], rS=lm[12]; if(!(lS&&rS)) return 'front';
    return (rS.x>lS.x)? 'right' : 'left'; // ƒë·ªß t·ªët cho auto ƒë∆°n gi·∫£n
  }
  function getRules(sport, view){
    const r = RULES[sport]; if(!r) return [];
    if(view!=='auto' && r[view]) return r[view];
    return r.base || [];
  }
  function checkFrame(angles, sport, view){
    const rules = getRules(sport, view);
    if(!rules.length) return {pass:false, ok:0, total:0};
    let ok = 0;
    for(const rule of rules){
      let within = false;
      if(rule.anySide){
        for(const key of rule.joints){
          const v = angles[key];
          if(typeof v==='number' && Math.abs(v-rule.want)<=rule.tol){ within=true; break; }
        }
      }else{
        const key = rule.joints[0];
        const v = angles[key];
        if(typeof v==='number' && Math.abs(v-rule.want)<=rule.tol) within=true;
      }
      if(within) ok++;
    }
    const score = ok / rules.length;
    return {pass: score >= (PASS_THRESH[sport]||0.5), ok, total:rules.length};
  }

  async function analyze(force=false){
    if(!current){ alert('Ch∆∞a ch·ªçn video.'); return; }
    const id=current.id, sport=current.sport;
    if(results[id] && !force){ renderPanel(results[id]); return; }

    ensurePose(); setProgress(0);
    player.muted = true;

    // chu·∫©n b·ªã video
    await new Promise(r=>{
      if(player.readyState>=1) return r();
      player.addEventListener('loadedmetadata', function on(){ player.removeEventListener('loadedmetadata',on); r(); });
    });

    const duration = Math.max(1, player.duration || 3);
    const step = duration / SAMPLE_TOTAL;

    let sampled=0, valid=0;
    let viewCount = {front:0,left:0,right:0,back:0};
    const userView = viewSel.value;

    for(let i=0;i<SAMPLE_TOTAL;i++){
      await new Promise(res=>{
        const t = Math.min(i*step, Math.max(0,duration-0.05));
        const onSeeked = async ()=>{
          player.removeEventListener('seeked', onSeeked);
          try{ await mpPose.send({image:player}); }catch(e){}
          sampled++;

          if(lastLm&&lastLm.length){
            // scale landmarks v√†o h·ªá to·∫° ƒë·ªô video
            const w = player.videoWidth || 640, h=player.videoHeight || 360;
            const lm = lastLm.map(p=>({x:p.x*w, y:p.y*h}));

            const autoView = detectView(lm);
            viewCount[autoView]=(viewCount[autoView]||0)+1;

            const angles = extractAngles(lm);
            const usedView = (userView==='auto')? autoView : userView;
            const chk = checkFrame(angles, sport, usedView);
            if(chk.pass) valid++;
          }
          setProgress(Math.round(((i+1)/SAMPLE_TOTAL)*100));
          setTimeout(res, 6);
        };
        player.addEventListener('seeked', onSeeked);
        try{ player.currentTime = t; }catch(e){ player.removeEventListener('seeked', onSeeked); res(); }
      });
    }

    const passRatio = valid/Math.max(1,sampled);
    // ch·ªâ c·∫£nh b√°o nh·∫π, kh√¥ng ch·∫∑n
    if(passRatio < 0.10){
      console.warn('T·ªâ l·ªá khung h·ª£p l·ªá th·∫•p:', Math.round(passRatio*100)+'%');
      alert('Video c√≥ t·ªâ l·ªá khung h·ª£p l·ªá th·∫•p (√°nh s√°ng/g√≥c quay/c·ª° ng∆∞·ªùi). V·∫´n tr·∫£ k·∫øt qu·∫£ tham kh·∫£o.');
    }

    let decidedView = userView;
    if(decidedView==='auto'){
      decidedView = Object.entries(viewCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'front';
    }

    const tile = Math.round(passRatio*100);
    const res = summarize(tile, sport);
    const out = {
      id, name: current.name, sport, view: decidedView,
      tile, dung: valid, sai: Math.max(0, sampled-valid),
      loi: res.loi, chanthuong: res.chanthuong, goiy: res.goiy, dongvien: res.dongvien
    };
    results[id]=out; saveResults();
    renderPanel(out); renderChart();
  }

  function summarize(tile, sport){
    const base={
      xuatphat:{
        loi:["G·∫≠p g·ªëi ch∆∞a ƒë√∫ng","Tay ch·ªëng y·∫øu","Th√¢n nghi√™ng nhi·ªÅu"],
        chanthuong:["C·ªï tay","G·ªëi","Vai"],
        goiy:["Gi·ªØ th√¢n th·∫≥ng khi xu·∫•t ph√°t","TƒÉng ph·∫£n x·∫° g·ªëi & m≈©i ch√¢n","Xu·∫•t ph√°t t·∫°i ch·ªó gi·ªØ 5s"]
      },
      nhaycao:{
        loi:["Ch·∫°y ƒë√† ch·∫≠m","G·ªëi kh√¥ng n√¢ng cao","Kh√¥ng ki·ªÉm so√°t ƒë·ªô cong l∆∞ng"],
        chanthuong:["G·ªëi","C·ªôt s·ªëng th·∫Øt l∆∞ng"],
        goiy:["Ch·∫°y ƒë√† + nh·∫£y 1 ch√¢n","K√©o gi√£n l∆∞ng","B·∫≠t nh·∫£y n√¢ng g·ªëi"]
      },
      nemta:{
        loi:["H·∫° th·∫•p vai khi xoay","Ch∆∞a t·ªëi ∆∞u l·ª±c ch√¢n"],
        chanthuong:["C·ªï tay","Vai","L∆∞ng"],
        goiy:["TƒÉng s·ª©c m·∫°nh c∆° xoay","Ph·ªëi h·ª£p ch√¢n-tr·ª•c-ƒë·∫©y t·∫°","Xoay ng∆∞·ªùi ch·∫≠m, gi·ªØ vai"]
      }
    }[sport];

    let loi, chanthuong, goiy, dongvien;
    if(tile===100){loi=[]; chanthuong=[]; goiy=[]; dongvien='üåü Xu·∫•t s·∫Øc!';}
    else if(tile>=90){loi=base.loi.slice(0,1); chanthuong=base.chanthuong.slice(0,1); goiy=base.goiy.slice(0,1); dongvien='üî• R·∫•t t·ªët!';}
    else if(tile>=70){loi=base.loi.slice(0,2); chanthuong=base.chanthuong.slice(0,2); goiy=base.goiy.slice(0,2); dongvien='üëç Kh√° t·ªët!';}
    else{loi=base.loi; chanthuong=base.chanthuong; goiy=base.goiy; dongvien='‚ö†Ô∏è C·∫ßn c·∫£i thi·ªán.';}
    return {loi,chanthuong,goiy,dongvien};
  }

  /************** Export **************/
  exportReport.onclick = ()=>{
    if(!current || !results[current.id]){ alert('Ch∆∞a c√≥ k·∫øt qu·∫£.'); return; }
    const data = results[current.id];
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = data.name.replace(/\.[^/.]+$/,'')+'_report.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };

  exportJson.onclick = ()=>{
    if(!current){ alert('Ch∆∞a ch·ªçn video.'); return; }
    const data = results[current.id];
    const payload = {meta:{id:current.id,name:current.name,sport:current.sport}, result:data};
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = current.name.replace(/\.[^/.]+$/,'')+'_features.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };

  exportCsv.onclick = ()=>{
    if(!current || !results[current.id]){ alert('Ch∆∞a c√≥ k·∫øt qu·∫£.'); return; }
    const header = ['name','sport','view','tile','dung','sai'];
    const r = results[current.id];
    const row = [r.name,r.sport,r.view,r.tile,r.dung,r.sai].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
    const blob = new Blob([[header.join(','),row].join('\n')],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = r.name.replace(/\.[^/.]+$/,'')+'_summary.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };

  /************** Events **************/
  fileInput.addEventListener('change', e=>{
    const files = Array.from(e.target.files||[]);
    files.forEach(f=>{
      const id = uid(f.name);
      const url = URL.createObjectURL(f);
      let tag = sportSel.value;
      const ln=f.name.toLowerCase();
      if(ln.includes('nhay')) tag='nhaycao';
      else if(ln.includes('nem')) tag='nemta';
      else if(ln.includes('xuat')) tag='xuatphat';
      uploaded.push({id,name:f.name,url,sport:tag});
    });
    renderHistory();
    if(uploaded.length && !current){ openVideo(uploaded[uploaded.length-1]); }
  });

  analyzeBtn.onclick = ()=> analyze(false);
  reanalyzeBtn.onclick = ()=> analyze(true);

  clearBtn.onclick = ()=>{
    if(!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu (k·∫øt qu·∫£ & video) trong phi√™n hi·ªán t·∫°i?')) return;
    uploaded.forEach(v=>{ try{URL.revokeObjectURL(v.url);}catch(e){} });
    uploaded=[]; results={}; saveResults(); renderHistory(); renderChart(); panel.innerHTML='<span class="muted">Ch∆∞a c√≥ video ƒë∆∞·ª£c ch·ªçn.</span>'; player.src='';
  };

  sportSel.onchange = ()=>{ renderHistory(); renderChart(); };
  viewSel.onchange = ()=>{}; // gi·ªØ nguy√™n

  // init
  ensurePose();
  renderHistory(); renderChart();
  </script>
</body>
</html>
