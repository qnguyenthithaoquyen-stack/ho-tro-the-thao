<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phân tích tư thế cho VĐV</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- MediaPipe Pose (global) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.min.js"></script>

  <style>
    :root{
      --bg: #f3faf8;
      --card: #ffffff;
      --ink: #1e293b;
      --muted: #64748b;
      --primary: #10b981;
      --primary-700:#059669;
      --ring: rgba(16,185,129,.15);
      --line:#e2e8f0;
      --chip:#eefcf7;
      --chip-text:#047857;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:'Inter',system-ui,Arial,sans-serif; }
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px;}
    .header{
      background: linear-gradient(90deg, #e6fff6, #f5fffb);
      border:1px solid var(--line);
      padding:14px 16px; border-radius:12px; margin-bottom:16px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .header-title{font-weight:700}
    .header-sub{color:var(--muted); font-size:13px}
    .header-right{display:flex; gap:8px; flex-wrap:wrap}

    .btn{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:10px 14px; border-radius:999px; font-weight:600; cursor:pointer;
      transition:.2s; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background:#f8fafc}
    .btn-primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-700)}
    .btn-danger{background:#fff; color:var(--danger); border-color:var(--danger)}
    .btn-ghost{background:#fff}

    .grid{display:grid; grid-template-columns: 1fr 380px; gap:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px}
    .card h3{margin:0 0 12px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .chip{background:var(--chip); color:var(--chip-text); border:1px solid #bdf0dd; padding:8px 14px; border-radius:999px; font-weight:600}
    .select, .filebox, .input{
      border:1px solid var(--line); background:#fff; color:var(--ink); padding:10px 12px; border-radius:10px;
      outline:none; font-weight:600;
    }
    .select:focus, .filebox:focus, .input:focus{box-shadow:0 0 0 6px var(--ring); border-color:var(--primary)}
    .tag{background:#f1f5f9; color:#334155; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line)}

    .player{position:relative; border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#000}
    .player video{width:100%; display:block}
    .overlay{position:absolute; inset:0; width:100%; height:100%; pointer-events:none}
    .badge{
      position:absolute; left:10px; top:10px; background:rgba(0,0,0,.6); color:#fff; font-size:12px;
      padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.2)
    }
    .progress{display:flex; align-items:center; gap:10px; margin-top:10px}
    .bar{flex:1; height:10px; background:#eef2f7; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; width:0%; background:var(--primary); transition:width .2s}
    .small{color:var(--muted); font-size:13px}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; justify-content:space-between; align-items:center; border:1px solid var(--line); background:#fff; border-radius:12px; padding:10px}
    .hint{font-size:12px; color:var(--muted); text-align:center; margin-top:8px}
    @media (max-width: 1060px){ .grid{grid-template-columns: 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="header-title">Phân tích tư thế cho VĐV</div>
        <div class="header-sub">Tải video, chạy MediaPipe, so khớp với khung chuẩn theo môn & góc quay.</div>
      </div>
      <div class="header-right">
        <button class="btn" id="backBtn">← Bảng điều khiển</button>
        <button class="btn" id="exportJsonBtn">Xuất features (.json)</button>
        <button class="btn" id="exportCsvBtn">Xuất (.csv)</button>
        <button class="btn btn-primary" id="reportBtn">Xuất báo cáo</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Trình phát & Điều khiển</h3>

        <div class="row" style="margin-bottom:10px">
          <select id="sport" class="select">
            <option value="xuatphat">Môn thể thao: Xuất phát</option>
            <option value="nhaycao">Môn thể thao: Nhảy cao</option>
            <option value="nemta">Môn thể thao: Ném tạ</option>
          </select>

          <select id="viewSel" class="select">
            <option value="auto">Góc quay: Tự động</option>
            <option value="front">Góc quay: FRONT</option>
            <option value="left">Góc quay: LEFT</option>
            <option value="right">Góc quay: RIGHT</option>
            <option value="back">Góc quay: BACK</option>
          </select>

          <input type="file" id="videoUpload" class="filebox" accept="video/*" />
          <button id="analyzeBtn" class="btn btn-primary">Phân tích</button>
          <button id="reanalyzeBtn" class="btn">Phân tích lại</button>
          <button id="clearBtn" class="btn btn-danger">Xóa dữ liệu</button>
        </div>

        <div class="player" id="playerWrap">
          <video id="player" controls playsinline crossorigin="anonymous" preload="metadata" muted></video>
          <canvas id="overlay" class="overlay"></canvas>
          <div id="liveBadge" class="badge" style="display:none">Đang kiểm tra…</div>
        </div>

        <div class="progress" id="progressRow" style="display:none">
          <div class="bar"><span id="progressBar"></span></div>
          <div class="small" id="progressText">0%</div>
        </div>

        <div class="hint">© 2025 — Demo. Nếu auto-view đoán sai, hãy chọn tay FRONT/LEFT/RIGHT/BACK.</div>

        <h3 style="margin-top:20px">Lịch sử video (lọc theo môn)</h3>
        <div id="videoList" class="list"></div>
      </div>

      <div class="card">
        <h3>Thông tin phân tích</h3>
        <div id="info" class="small" style="border:1px solid var(--line); border-radius:10px; padding:12px">
          Chưa có video được chọn.
        </div>

        <h3 style="margin-top:16px">Thống kê tỉ lệ đúng</h3>
        <div style="height:220px">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== hằng số key lưu trữ ====== */
const LS_RESULTS_KEY = 'thethaott_results';
const LS_VIDEOS_KEY  = 'thethaott_videos';

/* ========================== TIỆN ÍCH UI ========================== */
const backBtn = document.getElementById('backBtn');
backBtn.onclick = () => { history.back(); };

const reportBtn = document.getElementById('reportBtn');
reportBtn.onclick = () => {
  if (!currentVideo || !results[currentVideo.id]) { alert('Chưa có kết quả để xuất.'); return; }
  const data = results[currentVideo.id];
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${data.name.replace(/\.[^/.]+$/,'')}_report.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
};

const exportJsonBtn = document.getElementById('exportJsonBtn');
const exportCsvBtn  = document.getElementById('exportCsvBtn');

exportJsonBtn.onclick = () => {
  if(!currentVideo){ alert('Chưa có video.'); return; }
  const summary = results[currentVideo.id]?.features || summarizeFeatures();
  const payload = {
    meta:{videoId: currentVideo.id, name: currentVideo.name, sport: currentVideo.sportTag||sportSel.value},
    time: featTime, angles: featAngles, velocity: featVel, summary
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
};

exportCsvBtn.onclick = () => {
  if(!currentVideo){ alert('Chưa có video.'); return; }
  const keys = ['kneeL','kneeR','hipL','hipR','elbowL','elbowR','shoulderL','shoulderR','torso'];
  const header = ['t', ...keys, ...keys.map(k=>'v_'+k)];
  const rows = [header.join(',')];
  for (let i=0;i<featTime.length;i++){
    const a = featAngles[i]||{}, v = featVel[i]||{};
    const row = [featTime[i].toFixed(3), ...keys.map(k=> (a[k]??'').toString()), ...keys.map(k=> (v[k]??'').toString())];
    rows.push(row.join(','));
  }
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
};

/* ========================== STATE / DOM ========================== */
const sportSel = document.getElementById('sport');
const viewSel  = document.getElementById('viewSel');
const videoUpload = document.getElementById('videoUpload');
const videoListEl = document.getElementById('videoList');
const player = document.getElementById('player');
const overlay = document.getElementById('overlay');
const analyzeBtn = document.getElementById('analyzeBtn');
const reanalyzeBtn = document.getElementById('reanalyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const infoEl = document.getElementById('info');
const liveBadge = document.getElementById('liveBadge');
const progressRow = document.getElementById('progressRow');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const chartCanvas = document.getElementById('chart');

let overlayPass = null;
let results = JSON.parse(localStorage.getItem(LS_RESULTS_KEY)||'{}');
let uploadedVideos = JSON.parse(localStorage.getItem(LS_VIDEOS_KEY)||'[]'); // chỉ metadata, không URL
let currentVideo = null;
let chart = null;

let mpPose = null, drawCb = null;

/* ===== Lưu/khôi phục metadata video ===== */
function saveVideosMeta(){
  // Chỉ lưu metadata (không lưu URL blob)
  const meta = uploadedVideos.map(v=>({id:v.id,name:v.name,sportTag:v.sportTag,size:v.size,lastModified:v.lastModified}));
  localStorage.setItem(LS_VIDEOS_KEY, JSON.stringify(meta));
}
function addVideoFromFile(file, presetSport){
  const id = uidFromName(file.name+'_'+file.size+'_'+file.lastModified);
  const url = URL.createObjectURL(file);
  // nếu đã tồn tại trong list (khớp id) thì cập nhật URL để dùng tiếp
  let existed = uploadedVideos.find(v=>v.id===id);
  const tag = existed?.sportTag || presetSport || sportSel.value;
  const v = existed ? Object.assign(existed, {url}) : {id,name:file.name,url,sportTag:tag,size:file.size,lastModified:file.lastModified};
  if(!existed) uploadedVideos.push(v);
  saveVideosMeta();
  renderVideoList();
  openVideo(v);
}

/* ========================== MEDIA PIPE SAFE INIT ========================== */
function ensurePose(){
  if (mpPose) return mpPose;

  if (window.Pose && typeof window.Pose.Pose === 'function'){
    mpPose = new window.Pose.Pose({
      locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
  } else if (window.Pose && typeof window.Pose === 'function'){
    mpPose = new window.Pose({
      locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
  } else {
    alert('Không tải được MediaPipe Pose. Kiểm tra mạng/CDN!');
    return null;
  }

  mpPose.setOptions({
    modelComplexity:1, smoothLandmarks:true,
    enableSegmentation:false,
    minDetectionConfidence:0.45,
    minTrackingConfidence:0.45
  });

  mpPose.onResults((r)=>{
    if (drawCb) drawCb(r);
  });

  return mpPose;
}

/* ========================== RULES (START) ========================== */
const BASE = {
  xuatphat: [
    {name:'Gối (L/R)',      joints:['kneeL','kneeR'],   want:100, tol:20, anySide:true},
    {name:'Hông (L/R)',     joints:['hipL','hipR'],     want:120, tol:25, anySide:true},
    {name:'Thân nghiêng',   joints:['torso'],           want:45,  tol:15},
    {name:'Khuỷu (L/R)',    joints:['elbowL','elbowR'], want:90,  tol:25, anySide:true}
  ],
  nhaycao: [
    {name:'Gối giậm (L/R)', joints:['kneeL','kneeR'],   want:150, tol:20, anySide:true},
    {name:'Hông mở (L/R)',  joints:['hipL','hipR'],     want:160, tol:20, anySide:true},
    {name:'Thân nghiêng',   joints:['torso'],           want:20,  tol:15}
  ],
  nemta: [
    {name:'Gối (L/R)',      joints:['kneeL','kneeR'],   want:100, tol:25, anySide:true},
    {name:'Hông (L/R)',     joints:['hipL','hipR'],     want:120, tol:25, anySide:true},
    {name:'Khuỷu (L/R)',    joints:['elbowL','elbowR'], want:100, tol:25, anySide:true},
    {name:'Thân nghiêng',   joints:['torso'],           want:30,  tol:15}
  ]
};
const VIEW_RULES = {
  xuatphat:{
    front: BASE.xuatphat, back: BASE.xuatphat,
    left:  [
      {name:'Gối (bên gần)', joints:['kneeL','kneeR'], want:100, tol:22, anySide:true},
      {name:'Hông (bên gần)',joints:['hipL','hipR'],   want:120, tol:28, anySide:true},
      {name:'Thân',          joints:['torso'],         want:45,  tol:18}
    ],
    right: [
      {name:'Gối (bên gần)', joints:['kneeL','kneeR'], want:100, tol:22, anySide:true},
      {name:'Hông (bên gần)',joints:['hipL','hipR'],   want:120, tol:28, anySide:true},
      {name:'Thân',          joints:['torso'],         want:45,  tol:18}
    ]
  },
  nhaycao:{ front: BASE.nhaycao, back: BASE.nhaycao, left: BASE.nhaycao, right: BASE.nhaycao },
  nemta:  { front: BASE.nemta,   back: BASE.nemta,   left: BASE.nemta,   right: BASE.nemta }
};
const THRESH = { xuatphat:0.6, nhaycao:0.5, nemta:0.6 };

/* === rules fallback RUN cho xuất phát === */
const RUN_RULES_XUATPHAT = [
  {name:'Gối (L/R) — chạy',     joints:['kneeL','kneeR'],     want:170, tol:25, anySide:true},
  {name:'Hông (L/R) — chạy',    joints:['hipL','hipR'],       want:170, tol:25, anySide:true},
  {name:'Thân — chạy',          joints:['torso'],             want:10,  tol:20},
  {name:'Vai (L/R) — chạy',     joints:['shoulderL','shoulderR'], want:100, tol:60, anySide:true}
];
const THRESH_RUN = 0.5;

/* ========================== HÌNH HỌC / GÓC ========================== */
function degBetween(a,b,c){
  const abx=a.x-b.x, aby=a.y-b.y;
  const cbx=c.x-b.x, cby=c.y-b.y;
  const dot=abx*cbx+aby*cby;
  const mag=Math.sqrt((abx*abx+aby*aby)*(cbx*cbx+cby*cby));
  if(!mag) return 0;
  let cos = dot/mag; cos=Math.max(-1,Math.min(1,cos));
  return Math.acos(cos)*180/Math.PI;
}
function torsoDeg(lm){
  const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24];
  if(!lS||!rS||!lH||!rH) return 0;
  const s={x:(lS.x+rS.x)/2, y:(lS.y+rS.y)/2};
  const h={x:(lH.x+rH.x)/2, y:(lH.y+rH.y)/2};
  const dx=s.x-h.x, dy=s.y-h.y;
  return Math.atan2(Math.abs(dy), Math.abs(dx))*180/Math.PI;
}
function extractAngles(lm){
  const A={};
  if(lm[23]&&lm[25]&&lm[27]) A.kneeL=degBetween(lm[23],lm[25],lm[27]);
  if(lm[24]&&lm[26]&&lm[28]) A.kneeR=degBetween(lm[24],lm[26],lm[28]);
  if(lm[11]&&lm[23]&&lm[25]) A.hipL =degBetween(lm[11],lm[23],lm[25]);
  if(lm[12]&&lm[24]&&lm[26]) A.hipR =degBetween(lm[12],lm[24],lm[26]);
  if(lm[11]&&lm[13]&&lm[15]) A.elbowL=degBetween(lm[11],lm[13],lm[15]);
  if(lm[12]&&lm[14]&&lm[16]) A.elbowR=degBetween(lm[12],lm[14],lm[16]);
  if(lm[13]&&lm[11]&&lm[23]) A.shoulderL=degBetween(lm[13],lm[11],lm[23]);
  if(lm[14]&&lm[12]&&lm[24]) A.shoulderR=degBetween(lm[14],lm[12],lm[24]);
  A.torso = torsoDeg(lm);
  return A;
}
function detectView2D(lm){
  const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24];
  if(!(lS&&rS&&lH&&rH)) return 'front';
  const sMid={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2};
  const hMid={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};
  const torsoLen=Math.hypot(sMid.x-hMid.x, sMid.y-hMid.y);
  const shW=Math.abs(rS.x-lS.x);
  const ratio=shW/(torsoLen||1);
  if(ratio < 0.55) return (rS.x > lS.x) ? 'right':'left';
  return 'front';
}
function rulesFor(sport, view){
  const G = VIEW_RULES[sport]||{};
  return G[view] || BASE[sport] || [];
}

/* ========================== CHẤM KHUNG CHUẨN ========================== */
function checkAgainstRules(angles, rules, sportKey){
  let ok=0;
  for(const r of rules){
    let within=false;
    if(r.anySide){
      for(const k of r.joints){
        const v=angles[k];
        if(typeof v==='number' && Math.abs(v-r.want)<=r.tol){ within=true; break; }
      }
    }else{
      const v=angles[r.joints[0]];
      if(typeof v==='number' && Math.abs(v-r.want)<=r.tol) within=true;
    }
    if(within) ok++;
  }
  const total=rules.length;
  const ratio= total? ok/total : 0;
  const need = THRESH[sportKey] ?? 0.6;
  return {pass: ratio>=need, ratio, ok, total};
}
function passByAnyRuleSet(angles, ruleSets, sportKey){
  for(const {rules, threshOverride} of ruleSets){
    const old=THRESH[sportKey];
    if(threshOverride!=null) THRESH[sportKey]=threshOverride;
    const res=checkAgainstRules(angles, rules, sportKey);
    if(threshOverride!=null) THRESH[sportKey]=old;
    if(res.pass) return {pass:true};
  }
  return {pass:false};
}

/* ========================== FEATURE / ROM / VELOCITY ========================== */
let featTime=[], featAngles=[], featVel=[];
function angleVelocity(prev,curr,dt){
  const out={};
  const keys = new Set([...Object.keys(prev||{}), ...Object.keys(curr||{})]);
  keys.forEach(k=>{
    const a=(curr&&typeof curr[k]==='number')?curr[k]:null;
    const b=(prev&&typeof prev[k]==='number')?prev[k]:null;
    out[k]=(a!=null && b!=null && dt>0)? (a-b)/dt : 0;
  });
  return out;
}
function computeROM(series){
  const keys = new Set(); series.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));
  const rom={};
  keys.forEach(k=>{
    let min=+Infinity, max=-Infinity;
    series.forEach(a=>{
      const v=a[k]; if(typeof v==='number'){ if(v<min)min=v; if(v>max)max=v; }
    });
    if(min<+Infinity && max>-Infinity) rom[k]={min,max,range:max-min};
  });
  return rom;
}
function summarizeFeatures(){
  const keys=new Set(); featAngles.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));
  const sum={}, sumSq={}; keys.forEach(k=>{sum[k]=0; sumSq[k]=0;});
  const n=featAngles.length;
  featAngles.forEach(a=>{
    keys.forEach(k=>{
      const v=typeof a[k]==='number'?a[k]:0;
      sum[k]+=v; sumSq[k]+=v*v;
    });
  });
  const mean={}, std={}; keys.forEach(k=>{
    mean[k]=n? (sum[k]/n):0;
    std[k] =n? Math.sqrt(Math.max(0, sumSq[k]/n - mean[k]*mean[k])):0;
  });
  const rom=computeROM(featAngles);

  const vKeys=new Set(); featVel.forEach(a=>Object.keys(a).forEach(k=>vKeys.add(k)));
  const vsum={}, vsumSq={}; vKeys.forEach(k=>{vsum[k]=0; vsumSq[k]=0;});
  const vn=featVel.length;
  featVel.forEach(a=>{
    vKeys.forEach(k=>{
      const v=typeof a[k]==='number'?a[k]:0;
      vsum[k]+=v; vsumSq[k]+=v*v;
    });
  });
  const vmean={}, vstd={}; vKeys.forEach(k=>{
    vmean[k]=vn? (vsum[k]/vn):0;
    vstd[k] =vn? Math.sqrt(Math.max(0, vsumSq[k]/vn - vmean[k]*vmean[k])):0;
  });

  return {mean,std,rom,vmean,vstd, nFrames:n, duration: featTime.length? featTime.at(-1)-featTime[0]:0};
}

/* ========================== UI PHỤ ========================== */
function setProgress(pct, text){
  progressRow.style.display='flex';
  progressBar.style.width=Math.max(0,Math.min(100,pct))+'%';
  progressText.textContent = text ?? (Math.round(pct)+'%');
  if(pct>=100){ setTimeout(()=>progressRow.style.display='none', 400); }
}
function showInfo(res){
  if(!res){ infoEl.textContent='Chưa có video được chọn.'; return; }
  const lines=[];
  lines.push(`<div class="chip">${res.name}</div>`);
  lines.push(`<div style="margin:8px 0"><span class="tag">Góc: ${res.view.toUpperCase()}</span> — Tỉ lệ đúng: <b>${res.tile}%</b> (Đúng: ${res.dung}, Sai: ${res.sai})</div>`);
  if(res.loi?.length){
    lines.push(`<div style="margin-top:6px"><b>❌ Lỗi thường gặp</b><ul>${res.loi.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  }
  if(res.chanthuong?.length){
    lines.push(`<div><b>⚠️ Nguy cơ chấn thương</b><ul>${res.chanthuong.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  }
  if(res.goiy?.length){
    lines.push(`<div><b>💡 Gợi ý</b><ul>${res.goiy.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  }
  infoEl.innerHTML = lines.join('');
}
function renderChart(){
  const sport=sportSel.value;
  const keys = Object.keys(results).filter(k=>results[k].sport===sport);
  const labels=keys.map(k=>results[k].name);
  const data  =keys.map(k=>results[k].tile);
  if(chart) chart.destroy();
  chart = new Chart(chartCanvas.getContext('2d'),{
    type:'bar',
    data:{ labels, datasets:[{label:'Tỉ lệ đúng (%)', data, backgroundColor:'#10b981'}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{ticks:{color:'#475569'}}, y:{min:0,max:110,ticks:{color:'#475569'}}},
      plugins:{legend:{display:false}}
    }
  });
}

/* ========================== LỊCH SỬ VIDEO ========================== */
function uidFromName(name){
  let h=2166136261; for(let i=0;i<name.length;i++){ h ^= name.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); }
  return 'v_'+(h>>>0);
}
function renderVideoList(){
  const sport = sportSel.value;
  videoListEl.innerHTML='';
  const filtered = uploadedVideos.filter(v=>{
    if(v.sportTag===sport) return true;
    const ln=(v.name||'').toLowerCase();
    return ln.includes(sport);
  });
  if(filtered.length===0){
    videoListEl.innerHTML = '<div class="small">Chưa có video cho môn này.</div>'; return;
  }
  filtered.forEach(v=>{
    const row=document.createElement('div'); row.className='item';
    const left=document.createElement('div');
    const lost = !v.url; // chưa gắn file sau khi reload
    left.innerHTML = `<b>${v.name}</b><div class="small">${v.sportTag||''}${lost?' — <span class="tag">Cần gắn file</span>':''}</div>`;
    const right=document.createElement('div');

    const viewBtn = document.createElement('button');
    viewBtn.className='btn btn-ghost'; viewBtn.textContent='Xem';
    viewBtn.onclick = ()=>{ if(lost){ alert('Bạn cần gắn lại file cho mục này.'); return;} openVideo(v); };

    const analyzeBtn = document.createElement('button');
    analyzeBtn.className='btn btn-ghost'; analyzeBtn.textContent = results[v.id]?'Phân tích lại':'Phân tích';
    analyzeBtn.style.marginLeft='6px';
    analyzeBtn.onclick = ()=>{ if(lost){ alert('Bạn cần gắn lại file cho mục này.'); return;} openVideo(v); setTimeout(()=> analyze(v, !!results[v.id]), 120); };

    const linkBtn = document.createElement('button');
    linkBtn.className='btn'; linkBtn.textContent='Gắn file';
    linkBtn.style.marginLeft='6px';
    linkBtn.onclick = async ()=>{
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='video/*';
      inp.onchange = ()=>{
        const f = inp.files?.[0]; if(!f) return;
        // kiểm tra khớp tên/kích thước nếu có
        if(v.size && f.size!==v.size){ alert('File không khớp kích thước với mục đã lưu.'); return; }
        v.url = URL.createObjectURL(f);
        v.size = f.size; v.lastModified=f.lastModified;
        saveVideosMeta();
        renderVideoList();
        openVideo(v);
      };
      inp.click();
    };

    const delBtn = document.createElement('button');
    delBtn.className='btn btn-danger'; delBtn.textContent='Xóa'; delBtn.style.marginLeft='6px';
    delBtn.onclick = ()=>{
      if(confirm('Xóa video này khỏi lịch sử?')){
        if(results[v.id]){ delete results[v.id]; localStorage.setItem(LS_RESULTS_KEY, JSON.stringify(results)); }
        if(v.url) URL.revokeObjectURL(v.url);
        uploadedVideos = uploadedVideos.filter(x=>x.id!==v.id);
        saveVideosMeta(); renderVideoList(); renderChart();
        if(currentVideo && currentVideo.id===v.id){
          player.src=''; infoEl.textContent='Chưa có video được chọn.'; currentVideo=null;
        }
      }
    };

    right.appendChild(viewBtn);
    right.appendChild(analyzeBtn);
    if(lost) right.appendChild(linkBtn);
    right.appendChild(delBtn);

    row.appendChild(left); row.appendChild(right);
    videoListEl.appendChild(row);
  });
}

/* ========================== ANALYZE CORE (mượt hơn) ========================== */
let rafId=null, lastSend=0;
function resizeOverlayToVideo(){
  const rect = player.getBoundingClientRect();
  const dpr = window.devicePixelRatio||1;
  overlay.style.width = rect.width+'px';
  overlay.style.height= rect.height+'px';
  overlay.width  = Math.max(1, Math.round((player.videoWidth || rect.width || 640)*dpr));
  overlay.height = Math.max(1, Math.round((player.videoHeight|| rect.height|| 360)*dpr));
  const ctx=overlay.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', ()=>{ if(player.videoWidth) resizeOverlayToVideo(); });

function openVideo(v){
  currentVideo=v; player.src=v.url||''; player.muted=false; player.crossOrigin='anonymous'; player.playsInline=true;
  player.onloadedmetadata = ()=>{ resizeOverlayToVideo(); };
  player.onplay = ()=>{
    ensurePose();
    drawCb = (resPose)=>{
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0,0,overlay.width,overlay.height);
      if(!resPose || !resPose.poseLandmarks || !resPose.poseLandmarks.length){ liveBadge.style.display='none'; return; }
      const w=player.videoWidth||overlay.width, h=player.videoHeight||overlay.height;
      const lm = resPose.poseLandmarks.map(l=>({x:l.x*w, y:l.y*h}));
      const conns = (window.Pose && Pose.POSE_CONNECTIONS) ? Pose.POSE_CONNECTIONS : null;

      // pass realtime (cửa sổ trượt 8 khung)
      const A = extractAngles(lm);
      let vUse = viewSel.value==='auto' ? detectView2D(lm) : viewSel.value;
      const startRules = rulesFor(v.sportTag||sportSel.value, vUse);
      const kneeMin = Math.min((A.kneeL??999),(A.kneeR??999));
      const isRunPhase = (kneeMin>140) && (A.torso!=null ? A.torso<30 : false);
      const sets = isRunPhase && (v.sportTag||sportSel.value)==='xuatphat'
        ? [{rules:startRules},{rules:RUN_RULES_XUATPHAT, threshOverride:THRESH_RUN}]
        : [{rules:startRules}];
      const chk = passByAnyRuleSet(A, sets, v.sportTag||sportSel.value);
      overlayPassHist.push(chk.pass?1:0); if(overlayPassHist.length>8) overlayPassHist.shift();
      overlayPass = (overlayPassHist.reduce((a,b)=>a+b,0)/overlayPassHist.length)>=0.5?'pass':'fail';

      if(conns){
        const col = overlayPass==='pass' ? '#10b981' : '#ef4444';
        const ctx2=ctx; ctx2.lineWidth=2.5; ctx2.strokeStyle=col;
        conns.forEach(pair=>{
          const a=lm[pair[0]], b=lm[pair[1]];
          if(a&&b){ ctx2.beginPath(); ctx2.moveTo(a.x,a.y); ctx2.lineTo(b.x,b.y); ctx2.stroke(); }
        });
      }
      lm.forEach(p=>{
        ctx.fillStyle = overlayPass==='pass' ? '#14b8a6' : '#f43f5e';
        ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill();
      });
      liveBadge.style.display='block'; liveBadge.textContent=`[${vUse}] ${overlayPass==='pass'?'✅ Đạt':'⚠️ Lỗi'}`;
    };

    const loop = async ()=>{
      if(player.paused || player.ended){ cancelAnimationFrame(rafId); return; }
      const now = performance.now();
      if(now - lastSend > 45){ try{ await mpPose.send({image:player}); }catch(e){} lastSend=now; }
      rafId=requestAnimationFrame(loop);
    };
    ensurePose(); overlayPassHist.length=0; loop();
  };
  player.onpause = ()=>{ liveBadge.style.display='none'; };
  showInfo(results[v.id]); renderChart();
}
const overlayPassHist=[];

const analyzeBtnEl = document.getElementById('analyzeBtn');
analyzeBtnEl.onclick = ()=>{ if(!currentVideo){ alert('Chưa chọn video.'); return; } analyze(currentVideo,false); };
reanalyzeBtn.onclick = ()=>{ if(!currentVideo){ alert('Chưa chọn video.'); return; } analyze(currentVideo,true); };

function seekTo(t){
  return new Promise(resolve=>{
    let done=false;
    const finish=()=>{ if(done) return; done=true; resolve(); };
    const onseek=()=>{ player.removeEventListener('seeked',onse); if('requestVideoFrameCallback' in player){ player.requestVideoFrameCallback(()=>finish()); } else { setTimeout(finish, 30); } };
    const onse = onseek;
    player.addEventListener('seeked', onse);
    try{ player.currentTime = t; }catch(e){ player.removeEventListener('seeked',onse); finish(); }
    setTimeout(finish, 800); // dự phòng
  });
}

async function analyze(v, force=false){
  const id=v.id; if(results[id] && !force){ showInfo(results[id]); return; }
  if(!ensurePose()){ alert('Không khởi tạo được Pose'); return; }
  if(!v.url){ alert('Bạn cần gắn file cho mục này trước khi phân tích.'); return; }

  featTime=[]; featAngles=[]; featVel=[];
  player.src=v.url; player.muted=true;
  await new Promise(r=>{ if(player.readyState>=1) r(); else player.onloadedmetadata=()=>r(); });
  player.pause();

  const duration = Math.max(0.5, player.duration || 3);
  const total = Math.max(40, Math.min(120, Math.round(duration*18))); // mượt hơn theo thời lượng
  const step  = duration/total;

  let sampled=0, valid=0;
  setProgress(0,'0%');

  // xử lý callback Pose theo mỗi lần send
  const oneShot = (resPose)=>{
    sampled++;
    if(resPose && resPose.poseLandmarks && resPose.poseLandmarks.length){
      const w=player.videoWidth||overlay.width||640;
      const h=player.videoHeight||overlay.height||360;
      const lm=resPose.poseLandmarks.map(l=>({x:l.x*w,y:l.y*h}));
      const autoView = detectView2D(lm);
      const chosen = (viewSel.value==='auto')? autoView : viewSel.value;
      const A = extractAngles(lm);

      const startRules = rulesFor(v.sportTag||sportSel.value, chosen);
      const kneeMin=Math.min((A.kneeL??999),(A.kneeR??999));
      const isRunPhase = (kneeMin>140) && (A.torso!=null ? A.torso<30:false);
      const sets = isRunPhase && (v.sportTag||sportSel.value)==='xuatphat'
        ? [{rules:startRules},{rules:RUN_RULES_XUATPHAT,threshOverride:THRESH_RUN}]
        : [{rules:startRules}];
      const chk = passByAnyRuleSet(A, sets, v.sportTag||sportSel.value);
      if(chk.pass) valid++;

      const t = featTime.length? (featTime[0] + sampled*step) : 0;
      const dt = featTime.length? (t-featTime.at(-1)) : step;
      featTime.push(t); featAngles.push(A); featVel.push(angleVelocity(featAngles.at(-2)||A, A, dt));
    }
  };

  const oldCB = mpPose.onResults;
  mpPose.onResults = (r)=>oneShot(r);

  for(let i=0;i<total;i++){
    const t = Math.min(i*step, Math.max(0, duration-0.05));
    await seekTo(t);
    try{ await mpPose.send({image:player}); }catch(e){}
    const pct=Math.round(((i+1)/total)*100);
    setProgress(pct, pct+'%');
  }

  mpPose.onResults = oldCB;
  const ratio = valid/Math.max(sampled,1);
  if(ratio < 0.2){ setProgress(100,'Xong'); alert('Video có vẻ không phù hợp môn đã chọn.'); return; }

  const decided = (viewSel.value==='auto')? 'front' : viewSel.value;

  const summary = summarizeFeatures();
  const tile = Math.round(ratio*100);
  const sai  = Math.max(0, Math.round(sampled-valid));
  const dung = Math.max(0, Math.round(valid));

  const bank = {
    xuatphat:{loi:["Gập gối chưa đúng","Tay chống yếu","Thân nghiêng nhiều"], chanthuong:["Cổ tay","Gối","Vai"], goiy:["Giữ thân thẳng khi xuất phát","Tăng phản xạ gối & mũi chân","Xuất phát tại chỗ giữ 5s"]},
    nhaycao:{loi:["Bước chạy đà chậm","Gối không nâng cao","Lưng qua xà chưa cong"], chanthuong:["Gối","Cột sống thắt lưng"], goiy:["Chạy đà + nhảy 1 chân","Kéo giãn cột sống","Bật nhảy nâng gối"]},
    nemta:{loi:["Hạ vai khi xoay","Chưa tối ưu lực chân"], chanthuong:["Cổ tay","Vai","Lưng"], goiy:["Tăng sức mạnh xoay thân","Phối hợp chân–trục–đẩy tạ","Xoay chậm giữ vai"]}
  };
  const sport = v.sportTag||sportSel.value;
  let loi=[],chan=[],goiy=[], xeploai='TRUNG BÌNH';
  if(tile===100){ xeploai='HOÀN HẢO'; }
  else if(tile>=90){ xeploai='TỐT'; loi=bank[sport].loi.slice(0,1); chan=bank[sport].chanthuong.slice(0,1); goiy=bank[sport].goiy.slice(0,1); }
  else if(tile>=70){ xeploai='KHÁ'; loi=bank[sport].loi.slice(0,2); chan=bank[sport].chanthuong.slice(0,2); goiy=bank[sport].goiy.slice(0,2); }
  else { xeploai='TRUNG BÌNH'; loi=bank[sport].loi; chan=bank[sport].chanthuong; goiy=bank[sport].goiy; }

  results[id] = { id, name: v.name, sport, sai, dung, tile, view: decided, features: summary, xeploai, loi, chanthuong:chan, goiy };
  localStorage.setItem(LS_RESULTS_KEY, JSON.stringify(results));

  setProgress(100,'Xong');
  showInfo(results[id]); renderChart(); renderVideoList();
}

/* ========================== LOAD/UPLOAD ========================== */
videoUpload.onchange = (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  // đoán môn từ tên file
  let tag=''; const ln=f.name.toLowerCase();
  if(ln.includes('xuat')) tag='xuatphat';
  else if(ln.includes('nhay')) tag='nhaycao';
  else if(ln.includes('nem')) tag='nemta';
  addVideoFromFile(f, tag || sportSel.value);
};

clearBtn.onclick = ()=>{
  if(!confirm('Xóa toàn bộ dữ liệu (kết quả & lịch sử video)?')) return;
  localStorage.removeItem(LS_RESULTS_KEY); localStorage.removeItem(LS_VIDEOS_KEY);
  results={}; uploadedVideos=[];
  renderChart(); renderVideoList();
  player.src=''; infoEl.textContent='Chưa có video được chọn.'; currentVideo=null;
};

sportSel.onchange=()=>{ renderVideoList(); renderChart(); };

/* ========================== BOOT ========================== */
// Khi khởi động: render lịch sử từ metadata; video chưa gắn URL thì hiển thị “Cần gắn file”
function boot(){
  // đồng bộ lại mảng uploadedVideos (vì parse LS chỉ là meta)
  uploadedVideos = (uploadedVideos||[]).map(m=>Object.assign({}, m)); // không URL
  renderChart();
  renderVideoList();
}
boot();
</script>
</body>
</html>
