<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Phân tích tư thế cho VĐV</title>

<!-- Font + Chart.js -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- MediaPipe Pose (global) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.min.js"></script>

<style>
  :root{
    --bg:#eef9f5; --card:#fff; --ink:#0f172a; --muted:#64748b;
    --primary:#10b981; --primary-700:#059669; --line:#e2e8f0;
    --danger:#ef4444; --danger-700:#dc2626; --ring:rgba(16,185,129,.18);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,Arial,sans-serif}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
  .header{display:flex;justify-content:space-between;align-items:center;gap:10px;background:#f3fdf9;border:1px solid var(--line);padding:12px 14px;border-radius:12px}
  .header h1{font-size:18px;margin:0 0 4px 0}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);background:#fff;color:var(--ink);padding:9px 13px;border-radius:999px;font-weight:600;cursor:pointer;transition:.2s}
  .btn:hover{background:#f8fafc}
  .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn-primary:hover{background:var(--primary-700)}
  .btn-danger{color:var(--danger);background:#fff;border-color:var(--danger)}
  .btn-danger:hover{background:#fff2f2}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h3{margin:6px 0 12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .select,.file{border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:10px;font-weight:600;outline:none}
  .select:focus,.file:focus{box-shadow:0 0 0 6px var(--ring)}
  .player{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
  video{width:100%;display:block}
  canvas.overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .badge{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.55);color:#fff;padding:4px 10px;border-radius:999px;font-size:12px}
  .progress{display:flex;align-items:center;gap:10px;margin-top:8px}
  .bar{flex:1;height:10px;background:#eef2f7;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;width:0%;background:var(--primary);transition:width .2s}
  .small{color:var(--muted);font-size:13px}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px}
  .tag{background:#f1f5f9;color:#334155;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px}
  .chip{background:#ecfdf5;color:#065f46;border:1px solid #c4f2df;padding:6px 10px;border-radius:999px;font-weight:700}
  @media(max-width:1060px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>Phân tích tư thế cho VĐV</h1>
      <div class="sub">Tải video, chạy MediaPipe, so khớp với khung chuẩn theo môn & góc quay.</div>
    </div>
    <div class="toolbar">
      <button class="btn" id="backBtn">← Bảng điều khiển</button>
      <button class="btn" id="exportJsonBtn">Xuất features (.json)</button>
      <button class="btn" id="exportCsvBtn">Xuất (.csv)</button>
      <button class="btn btn-primary" id="reportBtn">Xuất báo cáo</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h3>Trình phát & Điều khiển</h3>
      <div class="row" style="margin-bottom:8px">
        <select id="sport" class="select">
          <option value="xuatphat">Môn thể thao: Xuất phát</option>
          <option value="nhaycao">Môn thể thao: Nhảy cao</option>
          <option value="nemta">Môn thể thao: Ném tạ</option>
        </select>

        <select id="viewSel" class="select">
          <option value="auto">Góc quay: Tự động</option>
          <option value="front">Góc quay: FRONT</option>
          <option value="left">Góc quay: LEFT</option>
          <option value="right">Góc quay: RIGHT</option>
          <option value="back">Góc quay: BACK</option>
        </select>

        <input id="videoUpload" type="file" class="file" accept="video/*"/>
        <button id="analyzeBtn" class="btn btn-primary">Phân tích</button>
        <button id="reanalyzeBtn" class="btn">Phân tích lại</button>
        <button id="clearBtn" class="btn btn-danger">Xóa dữ liệu</button>
      </div>

      <div class="player" id="playerWrap">
        <video id="player" controls playsinline crossorigin="anonymous" muted></video>
        <canvas id="overlay" class="overlay"></canvas>
        <div id="liveBadge" class="badge" style="display:none">Đang kiểm tra…</div>
      </div>

      <div class="progress" id="progressRow" style="display:none">
        <div class="bar"><span id="progressBar"></span></div>
        <div class="small" id="progressText">0%</div>
      </div>

      <div class="small" style="margin-top:8px">
        © 2025 — Demo theo yêu cầu. Nếu auto-view đoán sai, hãy chọn tay FRONT/LEFT/RIGHT/BACK.
      </div>

      <h3 style="margin-top:18px">Lịch sử video (lọc theo môn)</h3>
      <div id="videoList" class="list"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h3>Thông tin phân tích</h3>
      <div id="info" class="small" style="border:1px solid var(--line);border-radius:10px;padding:12px">Chưa có video được chọn.</div>

      <h3 style="margin-top:16px">Thống kê tỉ lệ đúng</h3>
      <div style="height:220px"><canvas id="chart"></canvas></div>
    </div>
  </div>
</div>

<script>
/* =================== UI BUTTONS =================== */
backBtn.onclick = ()=>history.back();

reportBtn.onclick = ()=>{
  if(!currentVideo || !results[currentVideo.id]){ alert('Chưa có kết quả để xuất.'); return; }
  const data = results[currentVideo.id];
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download = `${data.name.replace(/\.[^/.]+$/,'')}_report.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),500);
};

exportJsonBtn.onclick = ()=>{
  if(!currentVideo){ alert('Chưa có video.'); return; }
  const summary = results[currentVideo.id]?.features || summarizeFeatures();
  const payload = {
    meta:{videoId:currentVideo.id,name:currentVideo.name,sport:currentVideo.sportTag||sportSel.value},
    time:featTime, angles:featAngles, velocity:featVel, summary
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),500);
};

exportCsvBtn.onclick = ()=>{
  if(!currentVideo){ alert('Chưa có video.'); return; }
  const keys=['kneeL','kneeR','hipL','hipR','elbowL','elbowR','shoulderL','shoulderR','torso'];
  const header=['t',...keys,...keys.map(k=>'v_'+k)];
  const rows=[header.join(',')];
  for(let i=0;i<featTime.length;i++){
    const a=featAngles[i]||{}, v=featVel[i]||{};
    rows.push([featTime[i].toFixed(3), ...keys.map(k=>a[k]??''), ...keys.map(k=>v[k]??'')].join(','));
  }
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`${currentVideo.name.replace(/\.[^/.]+$/,'')}_features.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),500);
};

/* =================== STATE =================== */
const sportSel = document.getElementById('sport');
const viewSel  = document.getElementById('viewSel');
const videoUpload = document.getElementById('videoUpload');
const player = document.getElementById('player');
const overlay = document.getElementById('overlay');
const analyzeBtn = document.getElementById('analyzeBtn');
const reanalyzeBtn = document.getElementById('reanalyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const infoEl = document.getElementById('info');
const liveBadge = document.getElementById('liveBadge');
const progressRow = document.getElementById('progressRow');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const videoListEl = document.getElementById('videoList');
const chartCanvas = document.getElementById('chart');

let mpPose=null, lastPoseLandmarks=null, drawCb=null;
let results = JSON.parse(localStorage.getItem('thethaott_results')||'{}');
let libVideos = JSON.parse(localStorage.getItem('thethaott_videos')||'[]'); // persist metadata
let currentVideo=null, chart=null;

/* =================== MEDIAPIPE INIT =================== */
function ensurePose(){
  if(mpPose) return mpPose;
  if(window.Pose && typeof window.Pose.Pose==='function'){
    mpPose = new window.Pose.Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
  }else if(window.Pose && typeof window.Pose==='function'){
    mpPose = new window.Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
  }else{ alert('Không tải được MediaPipe Pose.'); return null; }

  mpPose.setOptions({
    modelComplexity:1, smoothLandmarks:true,
    enableSegmentation:false,
    minDetectionConfidence:0.45,
    minTrackingConfidence:0.45
  });
  mpPose.onResults(r=>{
    if(r && r.poseLandmarks && r.poseLandmarks.length) lastPoseLandmarks=r.poseLandmarks;
    if(drawCb) drawCb(r);
  });
  return mpPose;
}

/* =================== RULES =================== */
const BASE={
  xuatphat:[
    {name:'Gối (L/R)',joints:['kneeL','kneeR'],want:100,tol:20,anySide:true},
    {name:'Hông (L/R)',joints:['hipL','hipR'],want:120,tol:25,anySide:true},
    {name:'Thân nghiêng',joints:['torso'],want:45,tol:15},
    {name:'Khuỷu (L/R)',joints:['elbowL','elbowR'],want:90,tol:25,anySide:true}
  ],
  nhaycao:[
    {name:'Gối giậm',joints:['kneeL','kneeR'],want:150,tol:20,anySide:true},
    {name:'Hông mở',joints:['hipL','hipR'],want:160,tol:20,anySide:true},
    {name:'Thân nghiêng',joints:['torso'],want:20,tol:15}
  ],
  nemta:[
    {name:'Gối',joints:['kneeL','kneeR'],want:100,tol:25,anySide:true},
    {name:'Hông',joints:['hipL','hipR'],want:120,tol:25,anySide:true},
    {name:'Khuỷu',joints:['elbowL','elbowR'],want:100,tol:25,anySide:true},
    {name:'Thân',joints:['torso'],want:30,tol:15}
  ]
};
const VIEW_RULES={
  xuatphat:{
    front:BASE.xuatphat, back:BASE.xuatphat,
    left:[
      {name:'Gối (bên gần)',joints:['kneeL','kneeR'],want:100,tol:22,anySide:true},
      {name:'Hông (bên gần)',joints:['hipL','hipR'],want:120,tol:28,anySide:true},
      {name:'Thân',joints:['torso'],want:45,tol:18}
    ],
    right:[
      {name:'Gối (bên gần)',joints:['kneeL','kneeR'],want:100,tol:22,anySide:true},
      {name:'Hông (bên gần)',joints:['hipL','hipR'],want:120,tol:28,anySide:true},
      {name:'Thân',joints:['torso'],want:45,tol:18}
    ]
  },
  nhaycao:{front:BASE.nhaycao, back:BASE.nhaycao, left:BASE.nhaycao, right:BASE.nhaycao},
  nemta:{front:BASE.nemta, back:BASE.nemta, left:BASE.nemta, right:BASE.nemta}
};
const THRESH={xuatphat:0.6, nhaycao:0.5, nemta:0.6};
const RUN_RULES_XUATPHAT=[
  {name:'Gối (L/R) — chạy',joints:['kneeL','kneeR'],want:170,tol:25,anySide:true},
  {name:'Hông (L/R) — chạy',joints:['hipL','hipR'],want:170,tol:25,anySide:true},
  {name:'Thân — chạy',joints:['torso'],want:10,tol:20},
  {name:'Vai (L/R) — chạy',joints:['shoulderL','shoulderR'],want:100,tol:60,anySide:true}
];
const THRESH_RUN=0.5;

/* =================== GEOMETRY / ANGLES =================== */
function degBetween(a,b,c){
  const abx=a.x-b.x, aby=a.y-b.y;
  const cbx=c.x-b.x, cby=c.y-b.y;
  const dot=abx*cbx+aby*cby;
  const mag=Math.sqrt((abx*abx+aby*aby)*(cbx*cbx+cby*cby));
  if(!mag) return null;
  let cos=dot/mag; cos=Math.max(-1,Math.min(1,cos));
  return Math.acos(cos)*180/Math.PI;
}
// >>> FIX: đo góc thân so với TRỤC DỌC (0°=đứng thẳng)
function torsoDeg(lm){
  const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24];
  if(!lS||!rS||!lH||!rH) return null;
  const s={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2};
  const h={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};
  const dx=s.x-h.x, dy=s.y-h.y;
  return Math.atan2(Math.abs(dx), Math.abs(dy))*180/Math.PI;
}
function extractAngles(lm){
  const A={};
  if(lm[23]&&lm[25]&&lm[27]) A.kneeL=degBetween(lm[23],lm[25],lm[27]);
  if(lm[24]&&lm[26]&&lm[28]) A.kneeR=degBetween(lm[24],lm[26],lm[28]);
  if(lm[11]&&lm[23]&&lm[25]) A.hipL=degBetween(lm[11],lm[23],lm[25]);
  if(lm[12]&&lm[24]&&lm[26]) A.hipR=degBetween(lm[12],lm[24],lm[26]);
  if(lm[11]&&lm[13]&&lm[15]) A.elbowL=degBetween(lm[11],lm[13],lm[15]);
  if(lm[12]&&lm[14]&&lm[16]) A.elbowR=degBetween(lm[12],lm[14],lm[16]);
  if(lm[13]&&lm[11]&&lm[23]) A.shoulderL=degBetween(lm[13],lm[11],lm[23]);
  if(lm[14]&&lm[12]&&lm[24]) A.shoulderR=degBetween(lm[14],lm[12],lm[24]);
  A.torso = torsoDeg(lm);
  return A;
}
function detectView2D(lm){
  const lS=lm[11], rS=lm[12], lH=lm[23], rH=lm[24];
  if(!(lS&&rS&&lH&&rH)) return 'front';
  const sMid={x:(lS.x+rS.x)/2,y:(lS.y+rS.y)/2};
  const hMid={x:(lH.x+rH.x)/2,y:(lH.y+rH.y)/2};
  const torsoLen=Math.hypot(sMid.x-hMid.x, sMid.y-hMid.y);
  const shW=Math.abs(rS.x-lS.x);
  const ratio=shW/(torsoLen||1);
  if(ratio<0.55) return (rS.x>lS.x)?'right':'left';
  return 'front';
}
function rulesFor(sport,view){
  const G = VIEW_RULES[sport]||{}; return G[view]||BASE[sport]||[];
}

/* =================== SCORING =================== */
function checkAgainstRules(angles, rules, sportKey){
  let ok=0,total=rules.length;
  for(const r of rules){
    let within=false;
    if(r.anySide){
      for(const k of r.joints){
        const v=angles[k];
        if(typeof v==='number' && Math.abs(v-r.want)<=r.tol){within=true;break;}
      }
    }else{
      const v=angles[r.joints[0]];
      if(typeof v==='number' && Math.abs(v-r.want)<=r.tol) within=true;
    }
    if(within) ok++;
  }
  const ratio = total? ok/total : 0;
  const need  = THRESH[sportKey] ?? 0.6;
  return {pass:ratio>=need, ratio, ok, total};
}
function passByAnyRuleSet(angles, ruleSets, sportKey){
  for(const {rules,threshOverride} of ruleSets){
    const old=THRESH[sportKey];
    if(threshOverride!=null) THRESH[sportKey]=threshOverride;
    const res=checkAgainstRules(angles,rules,sportKey);
    if(threshOverride!=null) THRESH[sportKey]=old;
    if(res.pass) return {pass:true};
  }
  return {pass:false};
}

/* =================== FEATURES =================== */
let featTime=[], featAngles=[], featVel=[];
function angleVelocity(prev,curr,dt){
  const out={};
  const keys=new Set([...Object.keys(prev||{}),...Object.keys(curr||{})]);
  keys.forEach(k=>{
    const a=(curr&&typeof curr[k]==='number')?curr[k]:null;
    const b=(prev&&typeof prev[k]==='number')?prev[k]:null;
    out[k]=(a!=null && b!=null && dt>0)?(a-b)/dt:0;
  });
  return out;
}
function computeROM(series){
  const keys=new Set(); series.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));
  const rom={}; keys.forEach(k=>{
    let min=+Infinity,max=-Infinity;
    series.forEach(a=>{const v=a[k];if(typeof v==='number'){if(v<min)min=v;if(v>max)max=v;}});
    if(min<+Infinity && max>-Infinity) rom[k]={min,max,range:max-min};
  });
  return rom;
}
function summarizeFeatures(){
  const keys=new Set(); featAngles.forEach(a=>Object.keys(a).forEach(k=>keys.add(k)));
  const sum={},sumSq={}; keys.forEach(k=>{sum[k]=0;sumSq[k]=0;});
  const n=featAngles.length;
  featAngles.forEach(a=>{keys.forEach(k=>{const v=typeof a[k]==='number'?a[k]:0;sum[k]+=v;sumSq[k]+=v*v;});});
  const mean={},std={}; keys.forEach(k=>{mean[k]=n?sum[k]/n:0;std[k]=n?Math.sqrt(Math.max(0,sumSq[k]/n-mean[k]*mean[k])):0;});
  const rom=computeROM(featAngles);

  const vKeys=new Set(); featVel.forEach(a=>Object.keys(a).forEach(k=>vKeys.add(k)));
  const vsum={},vsumSq={}; vKeys.forEach(k=>{vsum[k]=0;vsumSq[k]=0;});
  const vn=featVel.length;
  featVel.forEach(a=>{vKeys.forEach(k=>{const v=typeof a[k]==='number'?a[k]:0;vsum[k]+=v;vsumSq[k]+=v*v;});});
  const vmean={},vstd={}; vKeys.forEach(k=>{vmean[k]=vn?vsum[k]/vn:0;vstd[k]=vn?Math.sqrt(Math.max(0,vsumSq[k]/vn-vmean[k]*vmean[k])):0;});
  return {mean,std,rom,vmean,vstd,nFrames:n,duration:featTime.length?featTime.at(-1)-featTime[0]:0};
}

/* =================== UI HELPERS =================== */
function setProgress(pct,text){
  progressRow.style.display='flex';
  progressBar.style.width=Math.max(0,Math.min(100,pct))+'%';
  progressText.textContent = text ?? (Math.round(pct)+'%');
  if(pct>=100) setTimeout(()=>progressRow.style.display='none',400);
}
function showInfo(res){
  if(!res){ infoEl.textContent='Chưa có video được chọn.'; return; }
  const html=[];
  html.push(`<div class="chip">${res.name}</div>`);
  html.push(`<div style="margin:8px 0"><span class="tag">Góc: ${res.view?.toUpperCase?.()||'N/A'}</span> — Tỉ lệ đúng: <b>${res.tile}%</b> (Đúng: ${res.dung}, Sai: ${res.sai})</div>`);
  if(res.loi?.length) html.push(`<div><b>❌ Lỗi thường gặp</b><ul>${res.loi.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  if(res.chanthuong?.length) html.push(`<div><b>⚠️ Nguy cơ chấn thương</b><ul>${res.chanthuong.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  if(res.goiy?.length) html.push(`<div><b>💡 Gợi ý</b><ul>${res.goiy.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  infoEl.innerHTML = html.join('');
}
function renderChart(){
  const sport=sportSel.value;
  const keys=Object.keys(results).filter(k=>results[k].sport===sport);
  const labels=keys.map(k=>results[k].name);
  const data=keys.map(k=>results[k].tile);
  if(chart) chart.destroy();
  chart = new Chart(chartCanvas.getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{label:'Tỉ lệ đúng (%)',data,backgroundColor:'#10b981'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:110}}}
  });
}

/* =================== HISTORY (persist) =================== */
function uidFromName(name){
  let h=2166136261; for(let i=0;i<name.length;i++){h^=name.charCodeAt(i);h+=(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);} return 'v_'+(h>>>0);
}
function persistVideos(){ localStorage.setItem('thethaott_videos', JSON.stringify(libVideos)); }
function renderVideoList(){
  const sport=sportSel.value;
  videoListEl.innerHTML='';
  const filtered = libVideos.filter(v=> (v.sportTag===sport) || (v.name||'').toLowerCase().includes(sport));
  if(filtered.length===0){ videoListEl.innerHTML='<div class="small">Chưa có video cho môn này.</div>'; return; }
  filtered.forEach(v=>{
    const row=document.createElement('div'); row.className='item';
    const left=document.createElement('div');
    left.innerHTML=`<b>${v.name}</b><div class="small">${v.sportTag||''}</div>`;
    const right=document.createElement('div');
    const analyzed = !!results[v.id];
    right.innerHTML=`
      ${analyzed?'<span class="tag">Đã phân tích</span>':''}
      <button class="btn" style="margin-left:6px">Xem</button>
      <button class="btn" style="margin-left:6px">${analyzed?'Phân tích lại':'Phân tích'}</button>
      <button class="btn" style="margin-left:6px">Gắn file</button>
      <button class="btn btn-danger" style="margin-left:6px">Xóa</button>`;
    const [btnView,btnAnalyze,btnAttach,btnDel] = right.querySelectorAll('button');

    btnView.onclick = ()=>openVideo(v);
    btnAnalyze.onclick = ()=>{ openVideo(v); setTimeout(()=>analyze(v,analyzed),120); };
    btnAttach.onclick = ()=>{
      const picker=document.createElement('input'); picker.type='file'; picker.accept='video/*';
      picker.onchange=e=>{
        const f=e.target.files?.[0]; if(!f) return;
        if(v.url) URL.revokeObjectURL(v.url);
        v.url=URL.createObjectURL(f); v.name=f.name;
        persistVideos(); renderVideoList(); openVideo(v);
      };
      picker.click();
    };
    btnDel.onclick = ()=>{
      if(confirm('Xóa video khỏi lịch sử?')){
        if(v.url) URL.revokeObjectURL(v.url);
        libVideos = libVideos.filter(x=>x.id!==v.id); persistVideos();
        if(results[v.id]){ delete results[v.id]; localStorage.setItem('thethaott_results',JSON.stringify(results)); }
        renderVideoList(); renderChart();
        if(currentVideo && currentVideo.id===v.id){ player.src=''; currentVideo=null; infoEl.textContent='Chưa có video được chọn.'; }
      }
    };

    row.appendChild(left); row.appendChild(right);
    videoListEl.appendChild(row);
  });
}

/* =================== PLAYBACK & OVERLAY =================== */
function resizeOverlayToVideo(){
  const rect=player.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  overlay.style.width=rect.width+'px';
  overlay.style.height=rect.height+'px';
  overlay.width = Math.max(1, Math.round((player.videoWidth||rect.width||640)*dpr));
  overlay.height= Math.max(1, Math.round((player.videoHeight||rect.height||360)*dpr));
  overlay.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
}
function openVideo(v){
  currentVideo=v; if(v.url) player.src=v.url; player.muted=false; player.playsInline=true;
  player.onloadedmetadata=()=>resizeOverlayToVideo();
  player.onplay = ()=>{
    ensurePose();
    drawCb = res=>{
      const ctx=overlay.getContext('2d'); ctx.clearRect(0,0,overlay.width,overlay.height);
      if(res && res.poseLandmarks && res.poseLandmarks.length){
        const w=player.videoWidth||overlay.width, h=player.videoHeight||overlay.height;
        const lm=res.poseLandmarks.map(l=>({x:l.x*w,y:l.y*h}));
        const A=extractAngles(lm);
        let vUse=viewSel.value==='auto'?detectView2D(lm):viewSel.value;
        const startRules=rulesFor(v.sportTag||sportSel.value, vUse);
        const kneeMin=Math.min((A.kneeL??999),(A.kneeR??999));
        const isRun=(kneeMin>140) && (A.torso!=null?A.torso<30:false);
        const sets=isRun && (v.sportTag||sportSel.value)==='xuatphat'
          ? [{rules:startRules},{rules:RUN_RULES_XUATPHAT,threshOverride:THRESH_RUN}]
          : [{rules:startRules}];
        const chk=passByAnyRuleSet(A,sets,v.sportTag||sportSel.value);
        const pass = chk.pass;

        // connections fallback
        const CONN = (window.Pose && Pose.POSE_CONNECTIONS) || [
          [11,13],[13,15],[12,14],[14,16],[11,12],[23,24],
          [11,23],[12,24],[23,25],[25,27],[24,26],[26,28]
        ];
        ctx.lineWidth=2.5; ctx.strokeStyle=pass?'#10b981':'#ef4444';
        CONN.forEach(([a,b])=>{ if(lm[a]&&lm[b]){ctx.beginPath();ctx.moveTo(lm[a].x,lm[a].y);ctx.lineTo(lm[b].x,lm[b].y);ctx.stroke();}});
        lm.forEach(p=>{ctx.fillStyle=pass?'#14b8a6':'#f43f5e';ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();});
        liveBadge.style.display='block'; liveBadge.textContent=`[${vUse}] ${pass?'✅ Đạt':'⚠️ Lỗi'}`;
      }else liveBadge.style.display='none';
    };
    const loop=async()=>{
      if(player.paused||player.ended) return;
      try{ await mpPose.send({image:player}); }catch(e){}
      requestAnimationFrame(loop);
    };
    ensurePose(); loop();
  };
  player.onpause=()=> liveBadge.style.display='none';
  showInfo(results[v.id]); renderChart();
}

/* =================== ANALYZE =================== */
analyzeBtn.onclick   = ()=>{ if(!currentVideo){alert('Chưa chọn video.');return;} analyze(currentVideo,false); };
reanalyzeBtn.onclick = ()=>{ if(!currentVideo){alert('Chưa chọn video.');return;} analyze(currentVideo,true); };

async function analyze(v,force=false){
  const id=v.id; if(results[id] && !force){ showInfo(results[id]); return; }
  if(!ensurePose()){ alert('Không khởi tạo được Pose'); return; }

  featTime=[]; featAngles=[]; featVel=[];
  if(v.url) player.src=v.url; player.muted=true;
  await new Promise(r=>{ if(player.readyState>=1) r(); else {player.onloadedmetadata=()=>r(); setTimeout(r,1000);} });
  player.pause(); resizeOverlayToVideo();

  const total=64;
  const duration = player.duration||3;
  const step = Math.max(0.06, duration/total);
  let sampled=0, valid=0;
  let viewCounts={front:0,left:0,right:0,back:0};

  setProgress(0,'0%');

  for(let i=0;i<total;i++){
    const t=Math.min(i*step, Math.max(0,(player.duration||duration)-0.05));
    await new Promise(resolve=>{
      const once=(res)=>{
        sampled++;
        if(res && res.poseLandmarks && res.poseLandmarks.length){
          const w=player.videoWidth||overlay.width||640, h=player.videoHeight||overlay.height||360;
          const lm=res.poseLandmarks.map(l=>({x:l.x*w,y:l.y*h}));
          const autoView=detectView2D(lm);
          const chosen=(viewSel.value==='auto')?autoView:viewSel.value;
          if(viewSel.value==='auto' && viewCounts[autoView]!=null) viewCounts[autoView]++;

          const A=extractAngles(lm);
          const startRules=rulesFor(v.sportTag||sportSel.value, chosen);
          const kneeMin=Math.min((A.kneeL??999),(A.kneeR??999));
          const isRun=(kneeMin>140) && (A.torso!=null?A.torso<30:false);
          const sets=isRun && (v.sportTag||sportSel.value)==='xuatphat'
            ? [{rules:startRules},{rules:RUN_RULES_XUATPHAT,threshOverride:THRESH_RUN}]
            : [{rules:startRules}];
          const chk=passByAnyRuleSet(A,sets,v.sportTag||sportSel.value);
          if(chk.pass) valid++;

          const dt=featTime.length?(t-featTime.at(-1)):step;
          featTime.push(t); featAngles.push(A); featVel.push(angleVelocity(featAngles.at(-2)||A,A,dt));
        }
        const pct=Math.round(((i+1)/total)*100); setProgress(pct,pct+'%'); resolve();
      };
      const prev=mpPose.onResults;
      mpPose.onResults=(r)=>{once(r); mpPose.onResults=prev;};
      const onseek=async()=>{ player.removeEventListener('seeked',onseek); try{await mpPose.send({image:player});}catch(e){} };
      player.addEventListener('seeked',onseek);
      try{ player.currentTime=t; }catch(e){ player.removeEventListener('seeked',onseek); mpPose.onResults=prev; resolve(); }
      setTimeout(()=>{ mpPose.onResults=prev; resolve(); },1200);
    });
  }

  const ratio = valid/Math.max(sampled,1);
  // nới điều kiện "không phù hợp" để tránh alert oan
  if(ratio < 0.05){ setProgress(100,'Xong'); alert('Video có vẻ không phù hợp môn đã chọn.'); return; }

  const decided = (viewSel.value==='auto')
    ? (Object.entries(viewCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'front')
    : viewSel.value;

  const summary=summarizeFeatures();
  const tile=Math.round(ratio*100);
  const sai = Math.max(0, Math.round(sampled-valid));
  const dung= Math.max(0, Math.round(valid));

  const bank={
    xuatphat:{loi:["Gập gối chưa đúng","Tay chống yếu","Thân nghiêng nhiều"],chanthuong:["Cổ tay","Gối","Vai"],goiy:["Giữ thân thẳng khi xuất phát","Tăng phản xạ gối & mũi chân","Xuất phát tại chỗ giữ 5s"]},
    nhaycao:{loi:["Bước chạy đà chậm","Gối không nâng cao","Lưng qua xà chưa cong"],chanthuong:["Gối","Cột sống thắt lưng"],goiy:["Chạy đà + nhảy 1 chân","Kéo giãn cột sống","Bật nhảy nâng gối"]},
    nemta:{loi:["Hạ vai khi xoay","Chưa tối ưu lực chân"],chanthuong:["Cổ tay","Vai","Lưng"],goiy:["Tăng sức mạnh xoay thân","Phối hợp chân–trục–đẩy tạ","Xoay chậm giữ vai"]}
  };
  const sport=v.sportTag||sportSel.value;
  let loi=[],chan=[],goiy=[];
  if(tile>=90){loi=bank[sport].loi.slice(0,1); chan=bank[sport].chanthuong.slice(0,1); goiy=bank[sport].goiy.slice(0,1);}
  else if(tile>=70){loi=bank[sport].loi.slice(0,2); chan=bank[sport].chanthuong.slice(0,2); goiy=bank[sport].goiy.slice(0,2);}
  else {loi=bank[sport].loi; chan=bank[sport].chanthuong; goiy=bank[sport].goiy;}

  results[id]={id,name:v.name,sport, sai,dung,tile,view:decided, features:summary, loi, chanthuong:chan, goiy};
  localStorage.setItem('thethaott_results', JSON.stringify(results));

  setProgress(100,'Xong'); showInfo(results[id]); renderChart(); renderVideoList();
}

/* =================== UPLOAD / CLEAR =================== */
videoUpload.onchange = e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const id=uidFromName(f.name+'_'+Date.now());
  let tag=''; const ln=f.name.toLowerCase();
  if(ln.includes('xuat')) tag='xuatphat';
  else if(ln.includes('nhay')) tag='nhaycao';
  else if(ln.includes('nem')) tag='nemta';
  if(!tag) tag=sportSel.value;
  const v={id,name:f.name,url:URL.createObjectURL(f),sportTag:tag};
  libVideos.push(v); persistVideos(); renderVideoList(); openVideo(v);
};

clearBtn.onclick=()=>{
  if(!confirm('Xóa toàn bộ dữ liệu (kết quả & lịch sử)?')) return;
  localStorage.removeItem('thethaott_results'); results={};
  libVideos.forEach(v=>v.url && URL.revokeObjectURL(v.url)); libVideos=[];
  persistVideos(); renderVideoList(); renderChart(); player.src=''; currentVideo=null;
  infoEl.textContent='Chưa có video được chọn.';
};

sportSel.onchange=()=>{ renderVideoList(); renderChart(); };

/* =================== BOOT =================== */
renderVideoList(); renderChart();
</script>
</body>
</html>
